<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>ÙƒØ´Ù ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù¡Ù¤Ù¤Ù§Ù‡Ù€</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--moe:#1e8a79;--moe-d:#0c594e;--ink:#0b2f2b;--line:#e6f1ee}
*{box-sizing:border-box}
html,body{margin:0;background:#fff;color:var(--ink);font-family:"Tajawal";font-size:15px;line-height:1.8}
#page{width:min(1120px,100%);margin:0 auto;padding:12px 14px 50px}

/* Ø±Ø£Ø³ */
.head{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;text-align:center;margin-bottom:8px}
.hcol{display:flex;flex-direction:column;gap:2px;align-items:center}
.hcol .line{font-weight:700;color:var(--moe-d);font-size:13px}
.head img{width:min(150px,28vw);height:auto;object-fit:contain}

/* Ø£Ø²Ø±Ø§Ø± */
.actions{display:flex;gap:8px;justify-content:flex-end;margin:6px 0;flex-wrap:wrap}
.btn{border:1px solid var(--line);border-radius:10px;padding:6px 10px;font-weight:800;background:#fff;color:#0c594e;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,var(--moe),var(--moe-d));color:#fff}
.btn.warn{background:linear-gradient(180deg,#fff6f6,#ffecec);color:#9b0000}

/* Ù…Ù„Ø®Øµ */
.summary{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px;background:#fff;margin:8px 0}
.tag{border:1px solid var(--line);border-radius:10px;padding:6px 8px;text-align:center}
.tag .t{font-size:12px;color:#557}
.tag .v{font-weight:900;color:#0c594e}

/* Ø¬Ø¯ÙˆÙ„ */
.table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{border:1px solid var(--line);padding:8px;vertical-align:middle;white-space:nowrap}
.table th{background:var(--moe);color:#fff}
.w-id{width:130px;max-width:130px}
.sign{height:26px;border-bottom:1px dashed #a9c5bf}

/* ØªØ°ÙŠÙŠÙ„: ÙÙŠ Ø§Ù„ÙˆØ³Ø· + Ø®Ø· Ù…ØªÙ‚Ø·Ø¹ ØªØ­Øª Ø§Ù„Ø§Ø³Ù… */
.approver{margin-top:16px;text-align:center}
.approver .title{color:var(--moe-d);font-weight:800}
.pname{font-weight:800;color:var(--moe-d)}
.sigline-below{width:240px;margin:6px auto 2px;border-bottom:1px dashed #a9c5bf}
.stamp{width:120px;height:120px;margin:12px auto;border:2px dashed var(--moe-d);border-radius:50%;
       display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--moe-d)}

/* Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙˆØ·Ø¨Ø§Ø¹Ø© */
@media (max-width:920px){.summary{grid-template-columns:repeat(3,1fr)}}
@media print{
  .actions{display:none!important}
  .no-print, .no-print *{display:none!important} /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø°Ù */
  .stamp{display:none!important} /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
  @page{size:A4;margin:12mm}
  html,body{font-size:13px;line-height:1.6}
}
</style>
</head>
<body>
<div id="page">
  <div class="head">
    <div class="hcol">
      <div class="line">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
      <div class="line">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
      <div class="line" id="dir">â€”</div>
      <div class="line" id="sch">â€”</div>
    </div>
    <img src="ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ….png" alt="">
    <div class="hcol">
      <div class="line" id="daydate"></div>

<div class="line" id="repTitle">ÙƒØ´Ù ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù¡Ù¤Ù¤Ù§Ù‡Ù€</div>
    </div>
  </div>

  <div class="actions">
    <button class="btn primary" id="add">Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
    <button class="btn warn" id="wipe">Ù…Ø³Ø­ Ø§Ù„ÙƒØ´Ù</button>
    <button class="btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button class="btn" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>

  <!-- Ù…Ù„Ø®Øµ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ´Ù -->
  <section class="summary">
    <div class="tag"><div class="t">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚ÙŠÙ‘Ù…ÙŠÙ†</div><div class="v" id="c_all">0</div></div>
    <div class="tag"><div class="t">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ù‘ÙÙ„Ù‘Ù…</div><div class="v" id="avg">0.00 / 5</div></div>
    <div class="tag"><div class="t">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¤Ø´Ø±</div><div class="v" id="avgPct">0%</div></div>
    <div class="tag"><div class="t">Ø¯Ø±Ø¬Ø© 5</div><div class="v" id="c5">0</div></div>
    <div class="tag"><div class="t">Ø¯Ø±Ø¬Ø© 4</div><div class="v" id="c4">0</div></div>
    <div class="tag"><div class="t">Ø¯Ø±Ø¬Ø© 3/2/1</div><div class="v" id="c321">0/0/0</div></div>
  </section>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ´Ù -->
  <table class="table" id="tbl">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th class="w-id">Ø§Ù„Ù‡ÙˆÙŠØ©</th>
        <th>Ø§Ù„ØªØ®ØµØµ</th>
        <th>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù…Ù† 5)</th>
        <th>Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² %</th>
        <th>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</th>
        <th class="no-print">Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>

  <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
  <div class="approver">
    <div class="title">ÙŠØ¹ØªÙ…Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
    <div class="pname" id="pname">â€”</div>
    <div class="sigline-below"></div>
    <div class="stamp">Ø§Ù„Ø®ØªÙ…</div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);

/* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */
const now=new Date(),days=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
document.getElementById('daydate').textContent = `${days[now.getDay()]} â€” ${now.toLocaleDateString('ar-SA')}`;


/* Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ­Ù‘Ø¯Ø© */
const DB_KEY='PF_DB';
function ensureDB(){
  const db=JSON.parse(localStorage.getItem(DB_KEY)||'{}');
  if(!db.archive) db.archive=[];
  if(!db.evals) db.evals=[];
  if(!db.plans) db.plans=[];
  if(!db.meta) db.meta={};
  return db;
}
function saveDB(db){localStorage.setItem(DB_KEY,JSON.stringify(db));}

/* ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© + Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
const sess=JSON.parse(localStorage.getItem('PF_session')||'{}');
dir.textContent=sess.dir||localStorage.getItem('PF_dir')||'â€”';
sch.textContent=sess.school||localStorage.getItem('PF_school')||'â€”';
/* Ø§Ù†Ø¹ÙƒØ§Ø³ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ´Ù */
function resolveStageLabel(s){
  const raw = (s.stageLabel || s.stageName || s.stageText || s.stage || s.stageKey || '').toString().trim();

  // 1) Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ØªØ­ÙØ¸ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø£ÙØ¶Ù„ Ø­Ø§Ù„Ø©)
  if (/Ù†ØµÙ\s*Ø³Ù†ÙˆÙŠ|Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\s*Ø§Ù„Ù†ØµÙ\s*Ø³Ù†ÙˆÙŠØ©|Ù…Ø±Ø§Ø¬Ø¹Ø©/i.test(raw)) return 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©';
  if (/Ù†Ù‡Ø§Ø¦ÙŠ|Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©|Ø®ØªØ§Ù…ÙŠ|Ø§Ù„ØªÙ‚ÙŠÙŠÙ…\s*Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ/i.test(raw)) return 'Ù…Ø±Ø­Ù„Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ';
  if (/ØªØ®Ø·ÙŠØ·/i.test(raw)) return 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·';

  // 2) Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ØªØ­ÙØ¸ Ù…ÙØªØ§Ø­/Ø±Ù‚Ù…
  const k = raw.toLowerCase();
  if (k === '2' || k.includes('stage2') || k.includes('mid') || k.includes('review') || k.includes('half')) return 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©';
  if (k === '3' || k.includes('stage3') || k.includes('final') || k.includes('end')) return 'Ù…Ø±Ø­Ù„Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ';
  if (k === '1' || k.includes('stage1') || k.includes('plan')) return 'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·';

  // Ø§ÙØªØ±Ø§Ø¶ÙŠ
  return 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ';
}

const stageLabel = resolveStageLabel(sess);
const reportTitle = `ÙƒØ´Ù ${stageLabel} Ù¡Ù¤Ù¤Ù§Ù‡Ù€`;

const rt = document.getElementById('repTitle');
if (rt) rt.textContent = reportTitle;

// (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…ÙÙŠØ¯) ÙŠØ­Ø¯Ù‘Ø« Ø¹Ù†ÙˆØ§Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ØªØµÙØ­ Ø£ÙŠØ¶Ù‹Ø§
document.title = reportTitle;
const db0=ensureDB();
const principalName = sess.principal || localStorage.getItem('PF_principal') || db0.meta.principal || 'â€”';
db0.meta.principal = principalName; /* ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
saveDB(db0);
pname.textContent = principalName;

/* ÙˆØ§Ø¬Ù‡Ø§Øª Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙƒØ´Ù */
function box(){return ensureDB().archive;}
function save(a){const db=ensureDB(); db.archive=a; saveDB(db);}

/* Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
function addFromSession(){
  const s=JSON.parse(localStorage.getItem('PF_session')||'{}');
  if(!s.name||!s.model){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');return;}
  const rec={
    name:s.name||'â€”',
    id:s.id||'',
    spec:s.spec||'',
    avg:+(s.avg||0),
    total:+(s.total||0),
    key:`${s.id||s.name}-${s.modelKey}-${s.stageKey}-${Date.now()}`
  };
  const a=box(); a.push(rec); save(a); render();
}
function delOne(key){
  const a=box().filter(r=>r.key!==key); save(a); render();
}

function render(){
  const a=box(), tb=body; tb.innerHTML='';
  a.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.name}</td>
      <td class="w-id">${r.id||''}</td>
      <td>${r.spec||''}</td>
      <td style="text-align:center">${(+r.avg).toFixed(2)}</td>
      <td style="text-align:center">${(+r.total).toFixed(0)}%</td>
      <td><div class="sign"></div></td>
      <td class="no-print" style="text-align:center">
        <button class="btn warn" data-k="${r.key}">Ø­Ø°Ù</button>
      </td>`;
    tb.appendChild(tr);
  });

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ±Ø¯ÙŠ
  tb.querySelectorAll('button[data-k]').forEach(b=>b.onclick=()=>delOne(b.getAttribute('data-k')));

  // Ù…Ù„Ø®Øµ
  document.getElementById('c_all').textContent=a.length;
  const cnt={1:0,2:0,3:0,4:0,5:0}; let sA=0,sP=0;
  a.forEach(r=>{const g=Math.max(1,Math.min(5,Math.round(+r.avg)));cnt[g]++; sA+=+r.avg; sP+=+r.total;});
  const avg=a.length? sA/a.length : 0, pct=a.length? Math.round(sP/a.length) : 0;
  document.getElementById('avg').textContent=avg.toFixed(2)+' / 5';
  document.getElementById('avgPct').textContent=pct+'%';
  document.getElementById('c5').textContent=cnt[5];
  document.getElementById('c4').textContent=cnt[4];
  document.getElementById('c321').textContent=`${cnt[3]}/${cnt[2]}/${cnt[1]}`;
}

document.getElementById('add').onclick=addFromSession;
document.getElementById('wipe').onclick=()=>{if(confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙƒØ´ÙØŸ')){save([]);render();}};
render();
</script>
</body>
</html>
