<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>ูููุฐุฌ ุชูููู ุงูุฃุฏุงุก ุงููุธููู โ ุซุงูููุฉ ุงููุนููุจู</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet"/>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
:root{
  --teal:#0f4c46; --teal2:#1e8a79; --ink:#0b2f2b; --muted:#5a7a74;
  --bg:#ffffff; --line:#d6e7e2; --border:#eaf3f1; --chip:#f4fbf9; --bar:#f8fffc;
  --shared:#cfeee3; --role:#e8f3ef; --extra:#efefef;
  --gloss1:#10b981; --gloss2:#34d399; --warn:#fbbf24; --danger:#f87171;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;color:var(--ink);font-family:"Tajawal",system-ui}
#page{width:min(1120px,100%);margin:0 auto;padding:10px}

/* ุฑุฃุณ ุซูุงุซู */
.header-grid{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;margin-bottom:8px}
.h-left{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;text-align:center}
.h-left .line{font-weight:800;color:#16544c;line-height:1.1}
.edit-icon{margin-inline-start:6px;cursor:pointer;font-size:12px;border:1px solid var(--border);border-radius:8px;padding:1px 5px;background:#fff}
.h-center{display:flex;justify-content:center;align-items:center}
.h-right{display:flex;flex-direction:column;gap:4px;align-items:flex-start;justify-content:center;padding-inline-end:40px} /* ุฅุฒุงุญุฉ ูุณุงุฑูุง ูุฑุจ ุงูุดุนุงุฑ */
.h-right .today{font-weight:800;color:#16544c}
.h-right .model{font-weight:800}
#moeLogo{width:min(220px,42vw);height:auto;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(0,0,0,.12))}

/* ุงูููุงุฆู ุงูููุณุฏูุฉ */
.picker-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;margin:8px 0}
.pill-select{position:relative}
.pill-select select{appearance:none;width:100%;height:38px;padding:0 34px 0 12px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:800;color:#0c3f39;cursor:pointer}
.pill-select .ico{position:absolute;inset-inline-end:10px;top:50%;transform:translateY(-50%);pointer-events:none;color:#0c3f39}

/* ุณุทุฑ ุงููุฑุญูุฉ ุงูููุฏูุฌ */
.stage-inline{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 10px;margin:6px 0}
.stage-inline div{display:flex;gap:8px;flex-wrap:wrap}
.stage-chip{background:#f6fffb;border:1px dashed #d9efe9;border-radius:10px;padding:6px 10px;font-weight:700}

/* ุตู ุงูุจูุงูุงุช */
.data-row{display:grid;grid-template-columns:2fr repeat(3,1fr);gap:8px;margin:8px 0}
.input-wrap{position:relative}
.lined{height:44px;border:1px solid var(--border);border-radius:12px;padding:0 42px 0 10px;width:100%}
.in-icon{position:absolute;inset-inline-start:10px;top:50%;transform:translateY(-50%);font-weight:900;color:#0b534b;cursor:pointer}

/* ูุงูุฐุฉ ุงูุนุฏุณุฉ */
.mini{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
.mini .card{width:min(780px,96%);background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 16px 48px rgba(0,0,0,.22)}
.mini .row{display:grid;grid-template-columns:1fr auto;gap:8px}
.list{max-height:300px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:6px;margin-top:8px}

/* ูุคุดุฑ ููุฌุงุช */
.kpi-wrap{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#ffffff 70%,#ffffff00);padding:6px 0 2px;margin:2px 0}
.kpi-bar{position:relative;height:16px;border-radius:999px;overflow:hidden;border:1px solid #e9f4f1}
.kpi-fill{position:absolute;inset:0;width:0%}
.kpi-fill::before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,var(--danger),var(--warn),var(--gloss2),var(--gloss1));opacity:.9}
.kpi-waves{position:absolute;left:0;bottom:0;height:42px;width:200%;background:radial-gradient(circle at 25% 120%, rgba(255,255,255,.6) 24%, transparent 26%) repeat-x;background-size:40px 40px;animation:waves 3s linear infinite;opacity:.45}
@keyframes waves{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.kpi-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);padding:2px 4px}

/* ุงูุฌุฏูู */
.table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{border:1px solid var(--line);background:#fff}
.table th{background:linear-gradient(90deg,#1e8a79,#2aa68a);color:#fff;padding:10px}
th.items{width:58%} th.weight{width:12%} th.scale{width:14%} th.result{width:16%}
td.result{white-space:nowrap}

/* ุณููู ุงูุชูุฏูุฑ */
.select-mini{appearance:none;background:transparent;border:none;padding:2px 8px;border-radius:8px;cursor:pointer;font-weight:800;color:#0b3430}
.select-mini:focus{outline:2px solid #b6e7dc}

/* ุชูููู ุตููู ุญุณุจ ุงูุฏุฑุฌุฉ */
tr.rate-1 td{background:#fff0f0}
tr.rate-2 td{background:#fff7e8}
tr.rate-3 td{background:#f8fbfb}
tr.rate-4 td{background:#f0fff7}
tr.rate-5 td{background:#e7fff2}

/* ุฑูู ุงูุนูุตุฑ */
.bullet{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:6px;font-weight:800;margin-inline-end:6px}
.b-shared{background:var(--shared);color:#0c443e}
.b-role{background:var(--role);color:#0c443e}
.b-extra{background:var(--extra);color:#333}

/* ูุฑุจุนุงุช ุงูููุฉ/ุงูุชุทููุฑ */
.two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}

/* ูุณู ุงูุชูููุนุงุช ุงููุณุชูู */
.sign-section{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0}
.sign-box{border:1px dashed var(--border);border-radius:10px;padding:8px;height:66px}

/* ุดุฑูุท ุงูุฃุฒุฑุงุฑ โ ุซุงุจุช ุฏุงุฎู ุงูุตูุญุฉ ุจุนุฏ ุงูุชูููุน */
.actions{position:sticky;bottom:0;z-index:30;display:flex;gap:10px;flex-wrap:wrap;padding:10px;background:var(--bar);border-top:1px solid var(--border);box-shadow:0 -8px 20px rgba(0,0,0,.06);justify-content:center}
.pill{border:1px solid var(--border);background:linear-gradient(180deg,#fff,#f7fffd);border-radius:12px;padding:10px 12px;font-weight:800;color:#0c3f39;cursor:pointer}
.pill.primary{background:linear-gradient(180deg,#1e8a79,#0f4c46);color:#fff;border-color:#0f4c46}

/* ููุฏุงูุงุช ุนุงูุฉ */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:60}
.panel{width:min(900px,96%);background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 16px 48px rgba(0,0,0,.22)}
.close{display:flex;justify-content:flex-end}
.title{font-weight:900;color:#0c4f47;font-size:18px}
.hr{height:1px;background:var(--border);margin:8px 0}

/* ุชุฐููู */
.footer{text-align:center;margin:12px 2px 4px 2px;color:#6a7f7b;font-size:12px}

/* ุชุฌุงูุจูุฉ ูุทุจุงุนุฉ */
@media (max-width:880px){ .data-row{grid-template-columns:1fr 1fr;grid-auto-rows:auto} .picker-row{grid-template-columns:1fr 1fr} .two,.sign-section{grid-template-columns:1fr}}
@media print{ .no-print,.actions,.mini,.modal{display:none!important} body{background:#fff} #page{padding:0} }
</style>
</head>
<body>
<div id="page">
  <header class="header-grid">
    <div class="h-left">
      <div class="line">ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ</div>
      <div class="line">ูุฒุงุฑุฉ ุงูุชุนููู</div>
      <div class="line">
        <span id="dirText">ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจุงูููุทูุฉ ุงูุดุฑููุฉ</span>
        <button id="editDir" class="edit-icon no-print" title="ุชุนุฏูู">โ</button>
      </div>
      <div class="line">
        <span id="schoolText">ุซุงูููุฉ ุงููุนููุจู</span>
        <button id="editSchool" class="edit-icon no-print" title="ุชุนุฏูู">โ</button>
      </div>
    </div>

    <div class="h-center">
      <img id="moeLogo" alt="ุดุนุงุฑ ูุฒุงุฑุฉ ุงูุชุนููู" src="ูุฒุงุฑุฉ ุงูุชุนููู.png"
        onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'220\\' height=\\'90\\'><rect fill=\\'white\\' width=\\'100%\\' height=\\'100%\\'/><text x=\\'50%\\' y=\\'55%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-family=\\'Tajawal\\' font-weight=\\'800\\' font-size=\\'20\\' fill=\\'#1e8a79\\'>ูุฒุงุฑุฉ ุงูุชุนููู</text></svg>');"/>
    </div>

    <div class="h-right">
      <div class="today" id="todayTxt">โ</div>
      <div id="dateTxt" style="color:#466e69">โ</div>
      <div class="model" id="modelTxt">ูููุฐุฌ ุงูุชูููู: โ</div>
    </div>
  </header>
  <section class="picker-row no-print">
    <div class="pill-select"><select id="modelSelect">
      <option value="teacher">ูุนูู</option>
      <option value="vp">ูููู</option>
      <option value="principal">ูุฏูุฑ</option>
      <option value="activity">ุฑุงุฆุฏ ูุดุงุท</option>
      <option value="health">ููุฌู ุตุญู</option>
      <option value="counselor">ููุฌู ุทูุงุจู</option>
      <option value="lab">ูุญุถุฑ ูุฎุชุจุฑ</option>
      <option value="kg">ูุนููุฉ ุฑูุงุถ ุฃุทูุงู</option>
    </select><span class="ico">โพ</span></div>

    <div class="pill-select"><select id="stageSelect">
      <option value="planning">ุงูุชุฎุทูุท</option>
      <option value="mid">ุงููุฑุงุฌุนุฉ ุงููุตู ุณูููุฉ</option>
      <option value="final">ุงูุชูููู ุงูููุงุฆู</option>
    </select><span class="ico">โพ</span></div>

    <button id="btnGapPlan" class="pill primary">ุฎุทุฉ ุชุญุณูู ูุฌูุฉ ุงูุฃุฏุงุก</button>
  </section>
  <section class="stage-inline" id="stageInline">
    <div id="stageChips"></div>
  </section>
  <section class="data-row no-print">
    <div class="input-wrap">
      <input id="tName" class="lined" placeholder="ุงุณู ุงูููุธู/ุงููุนูู"/>
      <span class="in-icon" id="openMini">๐</span>
    </div>
    <input id="tId"   class="lined" inputmode="numeric" placeholder="ุฑูู ุงููููุฉ"/>
    <input id="tSpec" class="lined" placeholder="ุงูุชุฎุตุต"/>
    <input id="tRank" class="lined" placeholder="ุงููุฑุชุจุฉ/ุงูุฑุชุจุฉ"/>
  </section>

  <div class="mini" id="mini">
    <div class="card">
      <div class="row">
        <input id="qName" class="lined" placeholder="ุงุจุญุซ ุนู ุงุณู"/>
        <div style="display:flex;gap:8px">
          <input type="file" id="xlsInput" accept=".xlsx,.xls,.csv"/>
          <button id="btnTpl" class="pill">โฌ๏ธ ูุงูุจ Excel</button>
        </div>
      </div>
      <div class="list" id="nameList"></div>
      <div style="text-align:end;margin-top:8px"><button id="miniClose" class="pill">ุฅุบูุงู</button></div>
    </div>
  </div>
  <div class="kpi-wrap">
    <div class="kpi-bar"><div class="kpi-fill" id="kpiFill"></div><div class="kpi-waves" id="kpiWaves"></div></div>
    <div class="kpi-label"><div id="kpiLabelL">ูุคุดุฑ ุงูุฅูุฌุงุฒ: 0%</div><div id="kpiLabelR">ูุฌููุน ุงูุฃูุฒุงู: 0%</div></div>
  </div>
  <section id="rubric">
    <table class="table">
      <thead>
        <tr>
          <th class="items">ุนูุงุตุฑ ุงูุชูููู</th>
          <th class="weight">ุงููุฒู ุงููุณุจู</th>
          <th class="scale">ุณูู ุงูุชูุฏูุฑ</th>
          <th class="result">ุงููุงุชุฌ ุงูููุฒูู</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <th>ุงูุชูุฏูุฑ ุงูุนุงู ููุฃุฏุงุก</th>
          <th id="sumWeight">0%</th>
          <th></th>
          <th id="sumScore">0.00</th>
        </tr>
      </tfoot>
    </table>
  </section>
  <section class="two">
    <div class="stage-inline">
      <h3 style="margin:0 0 6px;color:#0c4f47">ููุงุท ุงูููุฉ</h3>
      <p id="strengthsBox">โ</p>
    </div>
    <div class="stage-inline">
      <h3 style="margin:0 0 6px;color:#0c4f47">ูุฌุงูุงุช ุงูุชุญุณูู ูุงูุชุทููุฑ</h3>
      <p id="improveBox">โ</p>
    </div>
  </section>
  <section class="sign-section">
    <div>
      <div style="font-weight:800;color:#0c4f47">ุงุณู ุงููุนูู/ุงูููุธู</div>
      <div id="signTeacherName" class="sign-box">โ</div>
      <div style="font-weight:800;color:#0c4f47;margin-top:6px">ุงูุชูููุน</div>
      <div class="sign-box"></div>
    </div>
    <div>
      <div style="font-weight:800;color:#0c4f47">ุงุณู ูุฏูุฑ ุงููุฏุฑุณุฉ</div>
      <div id="signPrincipalName" class="sign-box">ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</div>
      <div style="font-weight:800;color:#0c4f47;margin-top:6px">ุงูุชูููุน</div>
      <div class="sign-box"></div>
    </div>
  </section>
  <div class="actions no-print" id="actionsBar">
    <button class="pill" id="btnPrint">๐จ๏ธ ุทุจุงุนุฉ</button>
    <button class="pill primary" id="btnPdf">๐งพ PDF</button>
    <button class="pill" id="btnSave">๐พ ุญูุธ</button>
    <button class="pill" id="btnClear">๐งน ูุณุญ</button>
    <button class="pill" id="btnExport">๐ ุชุตุฏูุฑ</button>
    <button class="pill" id="btnClipboard">๐๏ธ ุงูุญุงูุธุฉ</button>
    <button class="pill" id="openHelp">โน๏ธ ุงูุดุฑุญ</button>
    <button class="pill" id="openRubrics">๐ ุงูุฃุฏูุฉ</button>
  </div>
  <div class="modal" id="helpModal">
    <div class="panel">
      <div class="close"><button data-close="#helpModal" class="pill">โ ุฅุบูุงู</button></div>
      <div class="title">ุฏููู ุงูุงุณุชุฎุฏุงู</div><div class="hr"></div>
      <ol style="line-height:1.9">
        <li>ุงุฎุชุฑ ยซุงููููุฐุฌยป ูยซุงููุฑุญูุฉยปุ ุชูููููุฏ ุงูุจููุฏ ูุงูุฃูุฒุงู ูุณุทุฑ ยซูุง ููุจุบู ุนูููยป ุชููุงุฆููุง ููุงุจููุง ููุชุนุฏูู.</li>
        <li>ุฃุฏุฎู ุงูุงุณู ุฃู ุงุณุชุฎุฏู ๐ ูุงุณุชูุฑุงุฏ Excel: (ุงูุงุณู/ุงููููุฉ/ุงูุชุฎุตุต/ุงููุฑุชุจุฉ/ุงููุณูู) ุจุฃู ุชุฑุชูุจุ ูุณููุชุนุฑูู ุนูููุง ุชููุงุฆููุง.</li>
        <li>ูููู ุงูุจููุฏ ูู 1โ5ุ ุชูุญุณุจ ุงููุชุงุฆุฌ ูููุญุฏูุซ ูุคุดุฑ ุงูุฅูุฌุงุฒ ูุชุณุชูุจุท ุงูููุฉ/ุงูุชุญุณูู.</li>
        <li>ุงุญูุธ/ุงุณุชุฑุฌุน ุชููุงุฆููุง ููู (ุงุณู+ูููุฐุฌ+ูุฑุญูุฉ). ุงุทุจุน ุฃู ุงุญูุธ PDF ุจุฏูู ุงูุฃุฒุฑุงุฑ.</li>
        <li>ุฃูุดุฆ ยซุฎุทุฉ ุชุญุณูู ูุฌูุฉ ุงูุฃุฏุงุกยป ูู ุงูุฒุฑ ุงูุนูููุ ุชูููุฃ ุฎูุงุฑุฒูููุง ูุชุญูุธ PDF ูุณุชูู.</li>
      </ol>
    </div>
  </div>

  <div class="modal" id="reportsModal">
    <div class="panel">
      <div class="close"><button data-close="#reportsModal" class="pill">โ ุฅุบูุงู</button></div>
      <div class="title">ุฃุฏูุฉ ุงูุชูุงุฑูุฑ</div><div class="hr"></div>
      <ul style="line-height:1.9">
        <li>ุงูุงุญุชุณุงุจ: (ุงูุฏุฑุฌุฉ รท 5) ร ุงููุฒู = ุงููุงุชุฌ ุงูููุฒูู.</li>
        <li>ูุณุชููุงุช ุงูุชูุฏูุฑ: 1 ุบูุฑ ูุฑุถูุ 2 ุจุญุงุฌุฉ ูุชุทููุฑุ 3 ูุงูู ุงูุชููุนุงุชุ 4 ุชุฎุทู ุงูุชููุนุงุชุ 5 ูุซุงูู.</li>
        <li>ุชุตููู ุงูุจููุฏ: ูุดุชุฑูุฉ / ููู ุงูุฃุฏูุงุฑ / ุนูู ุฅุถุงูู โ ุชูููุฒ ุฃุฑูุงู ุงูุจููุฏ ูููููุง.</li>
        <li>ุชูุซูู ุงูุดูุงูุฏ ุงูุฑูููุฉ ูุงูููุฏุงููุฉ ูู ูู ูุฑุญูุฉ ูุฑุจุทูุง ุจุงูุฎุทุฉ ุงูุชุญุณูููุฉ.</li>
      </ul>
    </div>
  </div>
<script>
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];

const TITLE_BY_MODEL={ teacher:'ูุนูู', activity:'ุฑุงุฆุฏ ูุดุงุท', health:'ููุฌู ุตุญู', kg:'ูุนููุฉ ุฑูุงุถ ุฃุทูุงู', lab:'ูุญุถุฑ ูุฎุชุจุฑ', counselor:'ููุฌู ุทูุงุจู', vp:'ูููู', principal:'ูุฏูุฑ' };
const REQUIRED={ teacher:11, activity:15, health:14, kg:19, lab:13, counselor:13, vp:19, principal:19 };
const TYPE_COLOR = { shared:'b-shared', role:'b-role', extra:'b-extra' };

/* ุงูููู ูุงูุชุงุฑูุฎ */
(function(){
  const days=['ุงูุฃุญุฏ','ุงูุงุซููู','ุงูุซูุงุซุงุก','ุงูุฃุฑุจุนุงุก','ุงูุฎููุณ','ุงูุฌูุนุฉ','ุงูุณุจุช'];
  const d=new Date();
  $('#todayTxt').textContent = days[d.getDay()];
  $('#dateTxt').textContent = d.toLocaleDateString('ar-SA');
})();

/* ุชุนุฏูู ุงูุฅุฏุงุฑุฉ/ุงููุฏุฑุณุฉ */
function promptEdit(id,key,def){
  const v=prompt("ุฃุฏุฎู ุงููุต:", localStorage.getItem(key)||def||"");
  if(v){ $(id).textContent=v; localStorage.setItem(key,v); }
}
$('#editDir').addEventListener('click',()=> promptEdit('#dirText','dirText',$('#dirText').textContent));
$('#editSchool').addEventListener('click',()=> promptEdit('#schoolText','schoolText',$('#schoolText').textContent));
$('#dirText').textContent    = localStorage.getItem('dirText')    || $('#dirText').textContent;
$('#schoolText').textContent = localStorage.getItem('schoolText') || $('#schoolText').textContent;
</script>
<script>
const RUBRICS_OFFICIAL_1447 = {
  teacher:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:10,type:'shared'},{name:"ุงูุชููุน ูู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ",weight:10,type:'role'},{name:"ุชุญุณูู ูุชุงุฆุฌ ุงููุชุนูููู",weight:10,type:'role'},{name:"ุฅุนุฏุงุฏ ูุชูููุฐ ุฎุทุฉ ุงูุชุนูู",weight:10,type:'role'},{name:"ุชูุธูู ุชูููุงุช ููุณุงุฆู ุงูุชุนูู ุงูููุงุณุจุฉ",weight:10,type:'role'},{name:"ุชููุฆุฉ ุจูุฆุฉ ุชุนููููุฉ",weight:5,type:'role'},{name:"ุงูุฅุฏุงุฑุฉ ุงูุตููุฉ",weight:5,type:'role'},{name:"ุชุญููู ูุชุงุฆุฌ ุงููุชุนูููู ูุชุดุฎูุต ูุณุชููุงุชูู",weight:10,type:'role'},{name:"ุชููุน ุฃุณุงููุจ ุงูุชูููู",weight:10,type:'role'}],
  activity:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:5,type:'shared'},{name:"ุงูุชููุน ูู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ",weight:5,type:'role'},{name:"ุชุญุณูู ูุชุงุฆุฌ ุงููุชุนูููู",weight:5,type:'role'},{name:"ุฅุนุฏุงุฏ ูุชูููุฐ ุฎุทุฉ ุงูุชุนูู",weight:10,type:'role'},{name:"ุชูุธูู ุชูููุงุช ููุณุงุฆู ุงูุชุนูู ุงูููุงุณุจุฉ",weight:5,type:'role'},{name:"ุชููุฆุฉ ุจูุฆุฉ ุชุนููููุฉ",weight:5,type:'role'},{name:"ุงูุฅุฏุงุฑุฉ ุงูุตููุฉ",weight:5,type:'role'},{name:"ุชุญููู ูุชุงุฆุฌ ุงููุชุนูููู ูุชุดุฎูุต ูุณุชููุงุชูู",weight:5,type:'role'},{name:"ุชููุน ุฃุณุงููุจ ุงูุชูููู",weight:5,type:'role'},{name:"ุฅุนุฏุงุฏ ุฎุทุฉ ูุฒููุฉ ููุนุชูุฏุฉ ูุจุฑุงูุฌ ููุนุงููุงุช ุงููุดุงุท ุงูุทูุงุจู",weight:10,type:'extra'},{name:"ุชููุฆุฉ ุงูุจูุฆุฉ ุงููุฏุฑุณูุฉ ููุจุฑุงูุฌ ูุงูุฃูุดุทุฉ ุงูุทูุงุจูุฉ",weight:5,type:'extra'},{name:"ูุฏุนู ุงููุชุนูููู ููู ุงุญุชูุงุฌุงุชูู ููููููู ูููุดุงุท",weight:5,type:'extra'},{name:"ุชุญููุฒ ุงููุชุนูููู ุนูู ุงููุดุงุฑูุฉ ูู ุงูุฃูุดุทุฉ",weight:10,type:'extra'}],
  health:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:10,type:'shared'},{name:"ุงูุชููุน ูู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ",weight:5,type:'role'},{name:"ุชุญุณูู ูุชุงุฆุฌ ุงููุชุนูููู",weight:5,type:'role'},{name:"ุฅุนุฏุงุฏ ูุชูููุฐ ุฎุทุฉ ุงูุชุนูู",weight:5,type:'role'},{name:"ุชูุธูู ุชูููุงุช ููุณุงุฆู ุงูุชุนูู ุงูููุงุณุจุฉ",weight:5,type:'role'},{name:"ุชููุฆุฉ ุจูุฆุฉ ุชุนููููุฉ",weight:5,type:'role'},{name:"ุงูุฅุฏุงุฑุฉ ุงูุตููุฉ",weight:5,type:'role'},{name:"ุชุญููู ูุชุงุฆุฌ ุงููุชุนูููู ูุชุดุฎูุต ูุณุชููุงุชูู",weight:5,type:'role'},{name:"ุชููุน ุฃุณุงููุจ ุงูุชูููู",weight:5,type:'role'},{name:"ุชูููุฐ ุงูุฎุทุฉ ุงููุดุชุฑูุฉ ููุจุฑุงูุฌ ุงูุตุญูุฉ ุงููุฏุฑุณูุฉ",weight:15,type:'extra'},{name:"ุญุตุฑ ุงูุญุงูุงุช ุงูุตุญูุฉ ูููุชุนูููู",weight:5,type:'extra'},{name:"ุชููุฆุฉ ุงูุจูุฆุฉ ุงูุตุญูุฉ ุงููุฏุฑุณูุฉ",weight:10,type:'extra'}],
  kg:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:5,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:5,type:'shared'},{name:"ุงูุชููุน ูู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ",weight:5,type:'role'},{name:"ุชุญุณูู ููุงุชุฌ ุงูุชุนูู",weight:5,type:'role'},{name:"ุงุนุชูุงุฏ ููุงุฑุณุงุช ุชุนููููุฉ ูุณุคููุฉ ููุฃุทูุงู",weight:5,type:'role'},{name:"ุฅุนุฏุงุฏ ุฎุทุท ุงูุชุนูู",weight:5,type:'role'},{name:"ุชูุธูู ุชูููุงุช ููุณุงุฆู ุงูุชุนูู ุงูููุงุณุจุฉ",weight:5,type:'role'},{name:"ุงูุชููุฏ ุจูููุงุฌ ุงููุงุฏุฉ ุงูุนูููุฉ",weight:5,type:'role'},{name:"ุงุณุชุฎุฏุงู ุงุณุชุฑุงุชูุฌูุงุช ุชุฏุฑูุณ ูุงุนูุฉ ููุชููุนุฉ",weight:5,type:'role'},{name:"ุฅุดุฑุงู ุงูุฃุณุฑุฉ ูู ุฎุทุท ุงูููู ูุงูุชุนูู",weight:5,type:'role'},{name:"ุชููุฆุฉ ุจูุฆุฉ ุชุนููููุฉ ุขููุฉ ููููููููุฉ ููุชุทูุฑ ูุงูุชุนูู",weight:15,type:'role'},{name:"ุชูููุฑ ุฑูู ููุถูุนู ููุงุฆู ูุชูุงุนูุงุช ูููู ุงูุทูู",weight:5,type:'role'},{name:"ุชุชุจุน ุชูุฏู ุงูุฃุทูุงู ููุชุงุฆุฌ ุชุนูููู ุจุงูุชุธุงู",weight:5,type:'role'},{name:"ุงูุชูููู ุงููุณุชูุฑ ูุงููุชููุน ูููุงุณ ุงูููู ูุงูุชุนูู",weight:5,type:'role'},{name:"ุชุดุงุฑู ูู ุงูุฃูุดุทุฉ ุงูุชุฑุจููุฉ",weight:5,type:'role'},{name:"ุชุจุงุฏู ุงูุฎุจุฑุงุช ุงูููููุฉ",weight:5,type:'role'},{name:"ุชุฏุนู ููุชุณุจุงุช ุงููุชุนูููู ูู ุงูููุงุฑุงุช ูุงูููู ูุงูุงุชุฌุงูุงุช",weight:5,type:'role'},{name:"ุชุฏุนู ุงููุชุณุงุจ ุงููุชุนูููู ุงูููู ูุงููุจุงุฏุฆ ูุงูุงุชุฌุงูุงุช",weight:5,type:'role'}],
  lab:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:10,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:10,type:'shared'},{name:"ุงูุชููุน ูู ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ",weight:10,type:'role'},{name:"ุชุญุณูู ูุชุงุฆุฌ ุงููุชุนูููู",weight:10,type:'role'},{name:"ุฅุนุฏุงุฏ ุฎุทุฉ ุชุดุบูู ุงููุฎุชุจุฑ",weight:5,type:'role'},{name:"ุงููุนุฑูุฉ ูุงูููุงุฑุงุช ุงููุงุฒูุฉ ูุฃุฏุงุก ุงูุชุฌุงุฑุจ ุงูุนูููุฉ",weight:5,type:'role'},{name:"ููููุฑ ูุณุชูุฒูุงุช ูุชุฌููุฒุงุช ุฃุฏุงุก ุงูุชุฌุงุฑุจ ุงูุนูููุฉ",weight:5,type:'role'},{name:"ููุชุฒู ุจุณูุงุณุงุช ูุฅุฌุฑุงุกุงุช ุงูุณูุงูุฉ ุงูููููุฉ",weight:5,type:'role'},{name:"ูุญุถุฑ ููุฌูุฒ ุงููุฎุชุจุฑ",weight:5,type:'role'},{name:"ุชููุฆุฉ ูุชุณููู ุงูุฃุฌูุฒุฉ ุงููุทููุจุฉ ูููุนูููู ูุชุฎุฒูููุง ุจุทุฑููุฉ ุณูููุฉ",weight:5,type:'role'},{name:"ุฅุนุฏุงุฏ ุชูุฑูุฑ ุฃูุดุทุฉ ูููุงู ุงููุฎุชุจุฑ ุงูุฃุณุจูุนูุฉ",weight:10,type:'extra'},{name:"ุฅุนุฏุงุฏ ุชูุงุฑูุฑ ุฏูุฑูุฉ ุนู ุญุงูุฉ ุงูุฃุฌูุฒุฉ ูุงููุนุฏุงุช",weight:10,type:'extra'}],
  counselor:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:20,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:5,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:5,type:'shared'},{name:"ููุฏู ุงูุชุฏุฎูุงุช ุงูููุงุณุจุฉ ูุชุนุฒูุฒ ุงูุงูุถุจุงุท",weight:5,type:'role'},{name:"ุชูุฏูู ุจุฑุงูุฌ ุชุฑุจููุฉ ูุชุนุฒูุฒ ุฏุงูุนูุฉ ุงูุทูุจุฉ ููุชุนูู",weight:5,type:'role'},{name:"ุฅุนุฏุงุฏ ุฎุทุฉ ูุจุฑุงูุฌ ุงูุชูุฌูู ุงูุทูุงุจู",weight:10,type:'role'},{name:"ูุตูู ุงูุญุงูุงุช ูููุฏู ุจุฑุงูุฌ ุงูุฏุนู ุงูููุงุณุจุฉ",weight:10,type:'role'},{name:"ูุนุฒุฒ ุงูููู ูุงูุณููููุงุช ูููุชุนูููู",weight:10,type:'role'},{name:"ููุฏู ุงูุชุฏุฎูุงุช ุงูููุณูุฉ ูุงูุงุฌุชูุงุนูุฉ",weight:10,type:'role'},{name:"ูุณุงุนุฏ ุงููุชุนูููู ุนูู ุงูุชุฎุทูุท ุงููููู ูุงูุชุนูููู",weight:5,type:'role'},{name:"ูุนุฒุฒ ุงูุชููู ุงูุฏุฑุงุณู",weight:5,type:'role'},{name:"ููุฏู ุชุฏุฎูุงุช ุชุฑุจููุฉ ูููุชุฃุฎุฑูู ุฏุฑุงุณููุง ูุงููุนูุฏูู",weight:5,type:'role'},{name:"ุชูุนูุฉ ุงููุชุนูููู ูุฃูููุงุก ุฃููุฑูู ุจููุงุนุฏ ุงูุณููู ูุงูููุงุธุจุฉ",weight:5,type:'role'}],
  vp:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:5,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:5,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:5,type:'shared'},{name:"ูุฑู ููุงุฏุฑ ุนูู ุชูููุฐ ุฃุนูุงูู ูู ุธู ุธุฑูู ุงูุนูู ุงููุฎุชููุฉ",weight:5,type:'role'},{name:"ูุฏุนู ููุดุงุฑู ูู ุงููุจุงุฏุฑุงุช ุงูููุนูุฉ",weight:5,type:'role'},{name:"ูุชุฎุฐ ุฅุฌุฑุงุกุงุช ููุงุฆูุฉ ูุชุญููู ุงูุงูุถุจุงุท ุงููุฏุฑุณู",weight:10,type:'role'},{name:"ูุฏูุฑ ุงูููุงุฑุฏ ูู ุงููุฏุฑุณุฉ",weight:5,type:'role'},{name:"ูุณูู ูู ุฅุนุฏุงุฏ ุฎุทุฉ ุงูุชุทููุฑ ุงููููู",weight:5,type:'role'},{name:"ูุชุงุจุน ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ููุชุงุฆุฌ ุชุญูู ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุธููู",weight:5,type:'role'},{name:"ูููู ุฃุฏุงุก ููุณูุจู ุงููุฏุฑุณุฉ",weight:5,type:'role'},{name:"ูููุฐ ุฅุฌุฑุงุกุงุช ุนูููุฉ ูุชุญุณูู ูุชุงุฆุฌ ุงูุชุนูู",weight:5,type:'role'},{name:"ูุณูู ูู ุชุญุณูู ูุณุชูู ุฃุฏุงุก ุงููุฏุฑุณุฉ",weight:15,type:'role'},{name:"ูุดุงุฑู ูู ุฅุนุฏุงุฏ ุงูุฎุทุท ุงููุฏุฑุณูุฉ ุงููุงุฒูุฉ",weight:5,type:'role'},{name:"ูุชุงุจุน ุชูููุฐ ุงูุฎุทุท ุงููุฏุฑุณูุฉ ุจูุฎุชูู ุฃููุงุนูุง",weight:5,type:'role'},{name:"ุชููุฆุฉ ุงููุฑุต ูุงูุฅููุงูุงุช ุงูุฏุงุนูุฉ ููุดุงุฑูุฉ ุงูุทูุงุจ ูู ุงูุฃูุดุทุฉ ุงูุตููุฉ ูุบูุฑ ุงูุตููุฉ",weight:5,type:'role'},{name:"ููุธู ุงูููุตุงุช ุงูุฑูููุฉ ูุชุทุจููุงุชูุง ุงููุนุชูุฏุฉ ูู ุฏุนู ุนูููุงุช ุงูุชุนููู ูุงูุชุนูู",weight:5,type:'role'},{name:"ูุชุงุจุน ุชุนุฒูุฒ ุงูุณููู ุงูุฅูุฌุงุจู ููุทูุงุจ",weight:5,type:'role'},{name:"ูููุฆ ุจูุฆุฉ ูุฏุฑุณูุฉ ุขููุฉ ููููููููุฉ ุนูู ุงูุชุนูู",weight:5,type:'role'},{name:"ุงูุชูุฏูุฑ ุงูุนุงู ููุฃุฏุงุก (ุงุญุชุณุงุจ ุขูู)",weight:0,type:'extra'}],
  principal:[{name:"ุฃุฏุงุก ุงููุงุฌุจุงุช ุงููุธูููุฉ",weight:5,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุงููุฌุชูุน ุงููููู",weight:5,type:'shared'},{name:"ุงูุชูุงุนู ูุน ุฃูููุงุก ุงูุฃููุฑ",weight:5,type:'shared'},{name:"ูุฑู ููุงุฏุฑ ุนูู ุชูููุฐ ุฃุนูุงูู ูู ุธู ุธุฑูู ุงูุนูู ุงููุฎุชููุฉ",weight:5,type:'role'},{name:"ูุฏุนู ููุดุงุฑู ูู ุงููุจุงุฏุฑุงุช ุงูููุนูุฉ",weight:5,type:'role'},{name:"ูุชุฎุฐ ุฅุฌุฑุงุกุงุช ููุงุฆูุฉ ูุชุญููู ุงูุงูุถุจุงุท ุงููุฏุฑุณู",weight:5,type:'role'},{name:"ูุฏูุฑ ุงูููุงุฑุฏ ูู ุงููุฏุฑุณุฉ",weight:5,type:'role'},{name:"ูุณูู ูู ุฅุนุฏุงุฏ ุฎุทุฉ ุงูุชุทููุฑ ุงููููู",weight:5,type:'role'},{name:"ูุชุงุจุน ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ููุชุงุฆุฌ ุชุญูู ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุธููู",weight:5,type:'role'},{name:"ูููู ุฃุฏุงุก ููุณูุจู ุงููุฏุฑุณุฉ",weight:5,type:'role'},{name:"ูุฏุนู ุชูููุฐ ุจุฑุงูุฌ ุงูุชุทููุฑ ุงููููู",weight:5,type:'role'},{name:"ูุณูู ุชูููุฐ ุฎุทุฉ ุงูุชุทููุฑ ุงููููู",weight:15,type:'role'},{name:"ูุณูู ูู ุชุญุณูู ูุณุชูู ุฃุฏุงุก ุงููุฏุฑุณุฉ",weight:10,type:'role'},{name:"ูุดุงุฑู ูู ุฅุนุฏุงุฏ ุงูุฎุทุท ุงููุฏุฑุณูุฉ ุงููุงุฒูุฉ",weight:5,type:'role'},{name:"ูุชุงุจุน ุชูููุฐ ุงูุฎุทุท ุงููุฏุฑุณูุฉ ุจูุฎุชูู ุฃููุงุนูุง",weight:5,type:'role'},{name:"ุชููุฆุฉ ุงููุฑุต ูุงูุฅููุงูุงุช ุงูุฏุงุนูุฉ ููุดุงุฑูุฉ ุงูุทูุงุจ ูู ุงูุฃูุดุทุฉ ุงูุตููุฉ ูุบูุฑ ุงูุตููุฉ",weight:5,type:'role'},{name:"ููุธู ุงูููุตุงุช ุงูุฑูููุฉ ูุชุทุจููุงุชูุง ุงููุนุชูุฏุฉ ูู ุฏุนู ุนูููุงุช ุงูุชุนููู ูุงูุชุนูู",weight:5,type:'role'},{name:"ูุชุงุจุน ุชุนุฒูุฒ ุงูุณููู ุงูุฅูุฌุงุจู ููุทูุงุจ",weight:5,type:'role'},{name:"ูููุฆ ุจูุฆุฉ ูุฏุฑุณูุฉ ุขููุฉ ููููููููุฉ ุนูู ุงูุชุนูู",weight:5,type:'role'}]
};
</script>
<script>
function assertCount(key, arr){ const need=REQUIRED[key], have=(arr||[]).length; if(have!==need) throw new Error(`ุงููููุฐุฌ ยซ${TITLE_BY_MODEL[key]}ยป: ุงูุจููุฏ (${have}) โ ุงููุทููุจ (${need}).`); }

function buildRows(items){
  const tb=$("#rows"); tb.innerHTML=""; let wsum=0;
  items.forEach((it,i)=>{
    wsum+=+it.weight;
    const tr=document.createElement('tr'); tr.dataset.w=it.weight;
    tr.innerHTML=`
      <td><span class="bullet ${TYPE_COLOR[it.type]||'b-role'}">${i+1}</span><span class="item-text">${it.name}</span></td>
      <td style="text-align:center">${it.weight}%</td>
      <td style="text-align:center"><select class="select-mini grade"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select></td>
      <td class="result" style="text-align:center"><span class="score">0.00</span></td>`;
    tb.appendChild(tr);
  });
  $("#sumWeight").textContent=wsum+"%";
}

function recalc(){
  let total=0, wsum=0;
  $$('#rows tr').forEach(tr=>{
    const w=+tr.dataset.w||0; wsum+=w;
    const v=+tr.querySelector('.grade').value||1;
    const s=(v/5)*w; total+=s;
    tr.querySelector('.score').textContent=s.toFixed(2);
    for(let k=1;k<=5;k++) tr.classList.remove('rate-'+k);
    tr.classList.add('rate-'+v);
  });
  $("#sumScore").textContent=total.toFixed(2);
  const pct=Math.max(0,Math.min(100,total));
  $("#kpiFill").style.width=pct+"%";
  $("#kpiLabelL").textContent=`ูุคุดุฑ ุงูุฅูุฌุงุฒ: ${pct.toFixed(0)}%`;
  $("#kpiLabelR").textContent=`ูุฌููุน ุงูุฃูุฒุงู: ${wsum}%`;
}

document.addEventListener('change',e=>{ if(e.target.classList.contains('grade')){ recalc(); buildInsights(); autoSave(); }});

/* ูุง ููุจุบู ุนููู ููู ูุฑุญูุฉ */
const SHOULD={};
SHOULD.planning={teacher:["ุชุญุฏูุฏ ุฃูุฏุงู ูุงุจูุฉ ููููุงุณ","ุชุญููู ุงููุชุงุฆุฌ","ุชุฎุทูุท ููุงู ูุชููุนุฉ","ุดูุงูุฏ ูุชููุนุฉ"],activity:["ุฎุทุฉ ูุดุงุท","ุชูุธูู ูุฑู","ููุงุกูุฉ ุงูุจุฑุงูุฌ","ุชูุซูู ุงูุดูุงูุฏ"],health:["ุชูุนูู ุงูุฎุทุฉ ุงูุตุญูุฉ","ุญุตุฑ ุงูุญุงูุงุช","ุชูุนูุฉ ุฏูุฑูุฉ","ุชููุฆุฉ ุงูุจูุฆุฉ"],kg:["ุชุฎุทูุท ูุฑุงุนู ููุทูู","ุดุฑุงูุฉ ุงูุฃุณุฑุฉ","ุชูููุน ุงููุนุจ","ุชููุฆุฉ ุฑูู"],lab:["ุฎุทุฉ ุชุดุบูู","ุฌุฑุฏ ูุชุฌููุฒ","ุณูุงูุฉ","ุชูุงุฑูุฑ"],counselor:["ุฎุทุฉ ุชูุฌูู","ุชุตููู ุงูุญุงูุงุช","ุชุนุฒูุฒ ุงูุงูุถุจุงุท","ุฅุฑุดุงุฏ ุฃูุงุฏููู"],vp:["ุฎุทุฉ ุงูุถุจุงุท","ุชุชุจูุน ุงููุคุดุฑุงุช","ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ","ุชุทููุฑ ุงูููุงุฏุฑ"],principal:["ุฎุทุฉ ุชุญุณูู","ุชูููู ุงููุชุงุจุนุฉ","ุชุนุฒูุฒ ุงูุงูุถุจุงุท","ุฑูุน ููุงุกุฉ ุงูุชุทููุฑ"]};
SHOULD.mid={teacher:["ุชูุซูู ูุง ุชุญูู","ุฅุฌุฑุงุกุงุช ุชุตุญูุญูุฉ","ุชุญููู ูุจูู/ุจุนุฏู","ุชุนุฒูุฒ ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ"],activity:["ููุงุณ ุฃุซุฑ","ุชุญุณูู ุงูุฎุทุฉ","ุดุฑุงูุงุช","ุชูุซูู"],health:["ุญููุงุช ุตุญูุฉ","ูุชุงุจุนุฉ ุงูุญุงูุงุช","ุชุญุณูู ุงูุจูุฆุฉ","ููุงุณ ุงูุฃุซุฑ"],kg:["ูุชุงุจุนุฉ ุงูููู","ุชุญุณูู ุงูุฑูู","ุชูุงุตู ุงูุฃุณุฑุฉ","ุชุตุญูุญ ุงูููุงุฑุณุฉ"],lab:["ุชุญุฏูุซ ุณุฌู ุงูุณูุงูุฉ","ูุนุงูุฌุฉ ุงูููุงูุต","ุชูุซูู ุงูุชุฌุงุฑุจ","ุชูุงุฑูุฑ"],counselor:["ุชุญููู ุงูุงูุถุจุงุท","ููุงุกูุฉ ุงูุฎุทุฉ","ุฑูุน ุงูุฃุซุฑ","ุฏุนู ุงูุชููู"],vp:["ุชุญุณูู ุงููุคุดุฑุงุช","ูุงุนููุฉ ุงูููุตุงุช","ุชุทููุฑ ุงูุฃุฏุงุก","ุชุนุฒูุฒ ุงููุดุงุฑูุฉ"],principal:["ุชุญุณูู ุงูุฃุฏุงุก","ุชุทููุฑ ุงูุฎุทุท","ุฑูุน ุฃุซุฑ ุงูุชุทููุฑ","ุชุนุฒูุฒ ุงูุณููู"]};
SHOULD.final={teacher:["ููุฎุต ุงูุฅูุฌุงุฒ","ุฃุซุฑ ุงูุชุญุณูู","ุฎุทุฉ ุงูุนุงู ุงููุงุฏู","ูุดุฑูุนุงุช ุชุนูู"],activity:["ููุณูุจ ุงููุดุงุฑูุฉ","ุฃุซุฑ ุงููุนุงููุงุช","ุฎุทุฉ ูุงุฏูุฉ","ุดุฑุงูุงุช"],health:["ูุชุงุฆุฌ ุงูุจุฑุงูุฌ","ุชุญุณู ุงูุจูุฆุฉ ุงูุตุญูุฉ","ุฎุทุฉ ุชุทููุฑ","ุดุฑุงูุงุช"],kg:["ุชุญุณู ุงูููู","ูุนุงููุฉ ุงูุชุนูู ุจุงููุนุจ","ุฎุทุฉ ุชุทููุฑ","ูุดุงุฑูุฉ ุงูุฃุณุฑุฉ"],lab:["ุชุดุบูู ุงููุฎุชุจุฑ","ุณูุงูุฉ","ุฎุทุฉ ุชุทููุฑ","ุฅุซุฑุงุก ุนููู"],counselor:["ุฃุซุฑ ุงูุชูุฌูู","ูุฌุงุนุฉ ุงูุชุฏุฎูุงุช","ุฎุทุฉ ุงูุญุงูุงุช","ุดุฑุงูุงุช"],vp:["ุชุญุณู ุงููุคุดุฑุงุช","ูุงุนููุฉ ุงูููุงุฑุฏ","ุฑูุน ุงูุฃุฏุงุก","ุฎุทุฉ ุชุญุณูู ูุงุฏูุฉ"],principal:["ุชุญุณู ุฃุฏุงุก ุงููุฏุฑุณุฉ","ูุฌุงุนุฉ ุงูุชุฎุทูุท","ุชุทููุฑ ุงูุชุทููุฑ ุงููููู","ูุจุงุฏุฑุงุช ููุนูุฉ"]};

function updateStageInline(){
  const model=$('#modelSelect').value, stage=$('#stageSelect').value;
  const list=SHOULD[stage][model]||[];
  const box=$('#stageChips'); box.innerHTML='';
  list.forEach(txt=>{
    const chip=document.createElement('span'); chip.className='stage-chip'; chip.contentEditable='true'; chip.textContent=txt; box.appendChild(chip);
  });
}
</script>
<script>
function buildInsights(){
  const items=$$('#rows tr'); if(!items.length){ $('#strengthsBox').textContent='โ'; $('#improveBox').textContent='โ'; return; }
  const strengths=[], improve=[];
  items.forEach(tr=>{
    const v=+tr.querySelector('.grade').value||1;
    const name=tr.querySelector('.item-text').textContent.trim();
    if(v>=4) strengths.push(name);
    if(v<=2) improve.push(name);
  });
  const uniq=a=>[...new Set(a)].slice(0,6);
  $('#strengthsBox').textContent = (uniq(strengths).length? 'โข '+uniq(strengths).join('\nโข '):'โ');
  $('#improveBox').textContent   = (uniq(improve).length?   'โข '+uniq(improve).join('\nโข '):'โ');
  $('#signTeacherName').textContent = $('#tName').value || 'โ';
}
function keyFor(){ return `PF_${($('#tName').value||'').trim()}_${$('#modelSelect').value}_${$('#stageSelect').value}`; }
function autoSave(){
  const rows=$$('#rows tr').map(tr=>({n:tr.querySelector('.item-text').textContent,w:+tr.dataset.w,v:+tr.querySelector('.grade').value}));
  const data={dir:$('#dirText').textContent,school:$('#schoolText').textContent,model:$('#modelSelect').value,stage:$('#stageSelect').value,rows,meta:{name:$('#tName').value,id:$('#tId').value,spec:$('#tSpec').value,rank:$('#tRank').value},ins:{s:$('#strengthsBox').textContent,i:$('#improveBox').textContent},sum:$('#sumScore').textContent};
  localStorage.setItem(keyFor(),JSON.stringify(data));
}
function tryLoad(){
  const raw=localStorage.getItem(keyFor()); if(!raw) return;
  const d=JSON.parse(raw);
  $('#tId').value=d.meta.id||''; $('#tSpec').value=d.meta.spec||''; $('#tRank').value=d.meta.rank||'';
  $$('#rows tr').forEach((tr,i)=>{ const r=d.rows[i]; if(r) tr.querySelector('.grade').value=r.v; });
  recalc(); buildInsights();
}
function applyModelStage(){
  const key=$('#modelSelect').value, arr=RUBRICS_OFFICIAL_1447[key]||[]; assertCount(key,arr);
  buildRows(arr); recalc(); buildInsights();
  $('#modelTxt').textContent='ูููุฐุฌ ุงูุชูููู: '+TITLE_BY_MODEL[key];
  updateStageInline(); tryLoad();
}
$('#modelSelect').addEventListener('change',()=>{ applyModelStage(); autoSave();});
$('#stageSelect').addEventListener('change',()=>{ updateStageInline(); buildInsights(); tryLoad(); autoSave(); });
applyModelStage();

/* ุงูุนุฏุณุฉ ููุงูุจ Excel */
$('#openMini').addEventListener('click',()=> {refreshNameList(); $('#mini').style.display='flex';});
$('#miniClose').addEventListener('click',()=> $('#mini').style.display='none');
$('#btnTpl').addEventListener('click',()=>{
  const rows=[["ุงูุงุณู","ุฑูู ุงููููุฉ","ุงูุชุฎุตุต","ุงููุฑุชุจุฉ","ุงููุณูู"],[""],];
  const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"ุฃุณูุงุก");
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'}); saveAs(new Blob([wbout],{type:"application/octet-stream"}),"template_names.xlsx");
});
function getNames(){ return JSON.parse(localStorage.getItem('namesV2')||'[]'); }
function setNames(a){ localStorage.setItem('namesV2',JSON.stringify(a)); }
function refreshNameList(){
  const box=$("#nameList"); box.innerHTML="";
  const names=getNames();
  if(!names.length){ box.textContent="ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุณูุงุก ุจุนุฏ. ุงุณุชูุฑุฏ ููู Excel."; return; }
  const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fill,minmax(240px,1fr))'; grid.style.gap='8px';
  names.forEach(o=>{
    const card=document.createElement('div'); card.style.border='1px solid var(--border)'; card.style.borderRadius='10px'; card.style.padding='8px'; card.style.cursor='pointer'; card.style.background='#fff';
    card.innerHTML=`<div style="font-weight:900;color:#0c4f47">${o.name}</div><div style="font-size:12px;color:#667;display:flex;gap:6px;flex-wrap:wrap"><span>${o.id||'โ'}</span><span>${o.spec||'โ'}</span><span>${o.rank||'โ'}</span><span>${o.title||'โ'}</span></div>`;
    card.onclick=()=>{ $('#tName').value=o.name||''; $('#tId').value=o.id||''; $('#tSpec').value=o.spec||''; $('#tRank').value=o.rank||''; $('#mini').style.display='none'; applyModelStage(); };
    grid.appendChild(card);
  }); box.appendChild(grid);
}
const HEADER_MAP=[
  {keys:['ุงูุงุณู','Name','Full Name'], prop:'name'},
  {keys:['ุฑูู ุงููููุฉ','ูููุฉ','ID','National ID'], prop:'id'},
  {keys:['ุงูุชุฎุตุต','Specialty','Major'], prop:'spec'},
  {keys:['ุงููุฑุชุจุฉ','ุงูุฑุชุจุฉ','Rank','Grade'], prop:'rank'},
  {keys:['ุงููุณูู','ุงููุณูู ุงููุธููู','Title','Role'], prop:'title'},
];
function findProp(h){ h=(h||'').toString().trim(); for(const m of HEADER_MAP){ if(m.keys.some(k=>new RegExp(`^${k}$`,'i').test(h))) return m.prop; } return null; }
$('#xlsInput').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=await f.arrayBuffer(); const wb=XLSX.read(data,{type:'array'});
    const all=[];
    wb.SheetNames.forEach(name=>{
      const ws=wb.Sheets[name]; const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''}); if(!rows.length) return;
      const head=rows[0]; const idx={}; head.forEach((h,i)=>{ const p=findProp(h); if(p) idx[p]=i; });
      for(let r=1;r<rows.length;r++){
        const row=rows[r]; if(!row.length) continue;
        const o={}; Object.keys(idx).forEach(p=> o[p]=String(row[idx[p]]||'').trim());
        if(o.name){ all.push(o); }
      }
    });
    if(all.length){ const prev=getNames(); const mix=[...prev];
      all.forEach(o=>{ if(!mix.some(x=>x.name===o.name && x.id===o.id)){ mix.push(o); }});
      setNames(mix); refreshNameList();
    } else alert('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุนูุฏุฉ ูุนุฑููุฉ ููุฃุณูุงุก.');
  }catch(err){ alert('ุชุนุฐูุฑ ูุฑุงุกุฉ ุงูููู.'); }
  e.target.value='';
});

/* ุชูุงุนู ุนุงู */
['change','keyup'].forEach(evt=>{
  document.addEventListener(evt,(e)=>{
    if(e.target.matches('.grade,#tName,#tSpec,#tRank,#modelSelect,#stageSelect')) { recalc(); buildInsights(); autoSave(); }
  });
});
</script>
<script>
/* ูุงูุฐุฉ ุฎุทุฉ ุงููุฌูุฉ */
const gapModal=document.createElement('div');
gapModal.className='modal'; gapModal.id='gapModal';
gapModal.innerHTML=`
  <div class="panel" id="gapPanel" style="width:900px">
    <div class="close no-print" style="gap:8px">
      <button id="gapPdf"   class="pill primary">๐งพ ุญูุธ PDF</button>
      <button id="gapClose" class="pill">โ ุฅุบูุงู</button>
    </div>

    <div style="text-align:center;margin-bottom:10px">
      <div style="font-weight:900;color:#0c4f47;font-size:20px">ุฎุทุฉ ุชุญุณูู ูุฌูุฉ ุงูุฃุฏุงุก</div>
      <div id="gapHeaderSub" style="color:#5a7a74;font-weight:700"></div>
    </div>

    <section style="border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:10px">
      <table class="table" style="border-radius:0;margin:0;text-align:center">
        <thead><tr><th colspan="4">ุฃููุงู: ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูุดุงุบู ุงููุธููุฉ ุงูุชุนููููุฉ</th></tr></thead>
        <tbody>
          <tr><td>ุงูุงุณู</td><td id="g_name">โ</td><td>ุงูุฅุฏุงุฑุฉ</td><td id="g_dir">โ</td></tr>
          <tr><td>ุงููุณูู ุงููุธููู</td><td id="g_title">โ</td><td>ุงูุชุฎุตุต</td><td id="g_spec">โ</td></tr>
          <tr><td>ุงููุฏูุฑ ุงููุจุงุดุฑ</td><td id="g_mgr">ููุฏ ุญุงูุฏ ุนูู ุงูุฒูุฑุงูู</td><td>ุงููุชุฑุฉ</td><td id="g_stage">โ</td></tr>
          <tr><td>ุฌูุฉ ุงูุนูู</td><td id="g_school">โ</td><td>ุงูุนุงู ุงูุฏุฑุงุณู</td><td id="g_year"></td></tr>
        </tbody>
      </table>
    </section>

    <section style="padding:6px 0;text-align:center">
      <div style="display:flex;align-items:center;gap:8px;justify-content:center;margin:6px 0">
        <div style="font-weight:900;color:#0c4f47">ุซุงูููุง: ุงูุฎุทุฉ ุงูุชุญุณูููุฉ</div>
        <span class="badge-mini">ูุฑุชุจุทุฉ ุจุงููููุฐุฌ ูุงูุฏุฑุฌุงุช ุงูุญุงููุฉ</span>
      </div>

      <div class="stage-inline" style="margin-top:6px">
        <h3 style="margin:0 0 8px">ุฃ- ุชุญุฏูุฏ ุงููุฌูุฉ</h3>
        <table class="table" style="border-radius:10px;margin:0">
          <thead><tr><th style="width:50%">ุงููุนูุงุฑ ุงููุณุชูุฏู ุชุทููุฑู</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead>
          <tbody><tr><td id="g_target">โ</td><td id="g_s1"></td><td id="g_s2"></td><td id="g_s3"></td><td id="g_s4"></td><td id="g_s5"></td></tr></tbody>
        </table>
      </div>

      <div class="stage-inline">
        <h3 style="margin:0 0 8px">ุจ- ุชุญููู ูุณุชูู ุงูุฃุฏุงุก ุงูุญุงูู</h3>
        <table class="table" style="border-radius:10px;margin:0">
          <thead><tr><th>ุฏุฑุฌุฉ ุงูุชููู</th><th>ุงูุฃุณุจุงุจ</th><th>ููุงุท ุงูููุฉ</th><th>ุงูุฌูุงูุจ ุงูุชู ุจุญุงุฌุฉ ููุชุญุณูู</th></tr></thead>
        <tbody><tr><td id="g_grade" style="font-weight:900"></td><td contenteditable="true" id="g_reasons"></td><td id="g_strengths"></td><td id="g_gaps"></td></tr></tbody>
        </table>
      </div>

      <div class="stage-inline">
        <h3 style="margin:0 0 8px">ุฌ- ุฎุทุฉ ุงูุนูู ูุฅูุฌุงุฒ ุงูุชุญุณูู</h3>
        <table class="table" style="border-radius:10px;margin:0">
          <thead><tr><th>ู</th><th>ุงูุฎุทุฉ ุงูุฅุฌุฑุงุฆูุฉ</th><th>ูุชุทูุจุงุช ุงูุชูููุฐ</th><th>ุฒูู ุงูุชูููุฐ</th><th>ุงูุงุญุชูุงุฌุงุช</th><th>ุงููููู</th><th>ุงููุณุงูุฏ</th><th>ูุคุดุฑ ุงูุฃุฏุงุก</th></tr></thead>
          <tbody id="g_actions"></tbody>
        </table>
        <div style="margin-top:6px;font-size:12px;color:#5a7a74">ุงูุฎูุงูุง ูุงุจูุฉ ููุชุญุฑูุฑ ูุจู ุงูุญูุธ.</div>
      </div>
    </section>
  </div>`;
document.body.appendChild(gapModal);

/* ุจูุงุก ุงูุฎุทุฉ */
function buildGapPlan(){
  const name=$('#tName').value||'โ';
  const model=$('#modelSelect').selectedOptions[0].textContent;
  const stage=$('#stageSelect').selectedOptions[0].textContent;
  const year=new Date().getFullYear()+' / '+(new Date().getFullYear()+1);

  $('#gapHeaderSub').textContent = `${name} โ ${model} โ ${stage}`;
  $('#g_name').textContent=name; $('#g_dir').textContent=$('#dirText').textContent;
  $('#g_title').textContent=model; $('#g_spec').textContent=$('#tSpec').value||'โ';
  $('#g_stage').textContent=stage; $('#g_school').textContent=$('#schoolText').textContent;
  $('#g_year').textContent=year;

  const rows=$$('#rows tr').map(tr=>({name:tr.querySelector('.item-text').textContent,w:+tr.dataset.w,v:+tr.querySelector('.grade').value}));
  rows.sort((a,b)=> (a.v===b.v? a.w-b.w : a.v-b.v));
  const target=rows[0]||{name:'โ',v:3};
  $('#g_target').textContent=target.name;
  ['g_s1','g_s2','g_s3','g_s4','g_s5'].forEach((id,i)=>{ const el=$('#'+id); el.textContent=(i+1)===target.v?'โ':''; el.style.fontWeight='900'; });
  $('#g_grade').textContent = `${target.v} / 5`;
  $('#g_strengths').textContent = ($('#strengthsBox').textContent||'').replace(/^โข\s*/,'') || 'โ';
  $('#g_gaps').textContent      = ($('#improveBox').textContent||'').replace(/^โข\s*/,'')   || 'โ';

  const actions=$('#g_actions'); actions.innerHTML='';
  ['ุฌูุณุฉ ุชุบุฐูุฉ ุฑุงุฌุนุฉ ุฃุณุจูุนูุฉ','ุฏุฑุณ ุชุทุจููู/ุฒูุงุฑุฉ ุฒููู','ูุชุงุจุนุฉ ุงููุคุดุฑุงุช ูุฑูุน ุชูุฑูุฑ'].forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td contenteditable="true">${t} โ (${target.name})</td><td contenteditable="true">ููุงุฏ/ููุตุงุช</td><td contenteditable="true">ุฃุณุจูุนุงู</td><td contenteditable="true">ุชุฏุฑูุจ/ุฏุนู</td><td contenteditable="true">${name||'ุงููุนูู'}</td><td contenteditable="true">ุงููุฏูุฑ/ุงููุดุฑู</td><td contenteditable="true">ุชุญุณู ุงูุฏุฑุฌุฉ โฅ 1</td>`;
    actions.appendChild(tr);
  });
}

/* ูุชุญ/ุฅุบูุงู/PDF */
document.getElementById('btnGapPlan').addEventListener('click',()=>{ buildGapPlan(); document.getElementById('gapModal').style.display='flex'; });
document.addEventListener('click',(e)=>{ if(e.target.id==='gapClose'){ document.getElementById('gapModal').style.display='none'; }});
document.addEventListener('click',async(e)=>{
  if(e.target.id!=='gapPdf') return;
  try{
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.getElementById('gapPanel'),{scale:1.3,useCORS:true});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    const props=pdf.getImageProperties(img); const w=210, h=(props.height*w)/props.width;
    pdf.addImage(img,'PNG',0,0,w,h);
    const name=$('#tName').value||'ุจุฏูู ุงุณู';
    const role=$('#modelSelect').selectedOptions[0].textContent;
    pdf.save(`ุฎุทุฉ ุชุญุณูู ูุฌูุฉ ุงูุฃุฏุงุก - ${name} - ${role}.pdf`);
  }catch(e){ alert('ุชุนุฐูุฑ ุญูุธ PDF'); }
});

/* ุฃุฒุฑุงุฑ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ */
document.getElementById('btnPrint').addEventListener('click',()=> window.print());
document.getElementById('btnPdf').addEventListener('click', async ()=>{
  const hideSel='.no-print,.actions,.mini,.modal';
  const hidden=[...document.querySelectorAll(hideSel)];
  hidden.forEach(el=>{el.dataset._np='1'; el.style.display='none';});
  try{
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.body,{scale:1.2,useCORS:true});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    const props=pdf.getImageProperties(img); const w=210, h=(props.height*w)/props.width;
    pdf.addImage(img,'PNG',0,0,w,h);
    const model=$('#modelSelect').selectedOptions[0].textContent;
    const name=$('#tName').value||'ุจุฏูู ุงุณู';
    pdf.save(`ุชูููู ุงูุฃุฏุงุก ุงููุธููู - ${name} - ${model}.pdf`);
  }finally{
    hidden.forEach(el=>{ if(el.dataset._np==='1'){el.style.display=''; delete el.dataset._np;} });
  }
});
document.getElementById('btnSave').addEventListener('click',()=>{ autoSave(); alert('ุชู ุงูุญูุธ ูุญูููุง.'); });
document.getElementById('btnClear').addEventListener('click',()=>{ $$('.grade').forEach(s=> s.value='3'); recalc(); buildInsights(); autoSave(); });
document.getElementById('btnExport').addEventListener('click',()=>{
  let csv="ุงูุงุณู,ุงููููุฐุฌ,ุงููุฑุญูุฉ,ุงูุนูุตุฑ,ุงููุฒู,ุงูุฏุฑุฌุฉ,ุงููุงุชุฌ\n";
  const name=$('#tName').value||'โ', model=$('#modelSelect').selectedOptions[0].textContent, stage=$('#stageSelect').selectedOptions[0].textContent;
  $$('#rows tr').forEach(tr=>{
    const item=tr.querySelector('.item-text').textContent, w=+tr.dataset.w, v=+tr.querySelector('.grade').value, s=(v/5)*w;
    csv+=`"${name}","${model}","${stage}","${item}",${w},${v},${s.toFixed(2)}\n`;
  });
  saveAs(new Blob([csv],{type:"text/csv;charset=utf-8"}),`ุชูุฑูุฑ-ุงูุชูููู-${name}.csv`);
});
document.getElementById('btnClipboard').addEventListener('click',()=>{
  const name=$('#tName').value||'โ', model=$('#modelSelect').selectedOptions[0].textContent, stage=$('#stageSelect').selectedOptions[0].textContent;
  const lines=[`${name} โ ${model} โ ${stage}`, `ุงููุฌููุน: ${$('#sumScore').textContent}`];
  $$('#rows tr').forEach(tr=>{
    const item=tr.querySelector('.item-text').textContent; const w=+tr.dataset.w; const v=+tr.querySelector('.grade').value; const s=(v/5)*w;
    lines.push(`- ${item}: ูุฒู ${w}%ุ ุฏุฑุฌุฉ ${v}/5ุ ูุงุชุฌ ${s.toFixed(2)}`);
  });
  navigator.clipboard.writeText(lines.join("\n")); alert('ุชู ูุณุฎ ุงูููุฎุต.');
});
</script>
  <div class="footer">ุชูููุฐ ูุชุตููู: ููุฏ ุญุงูุฏ ุงูุฒูุฑุงูู</div>
</div><!-- /page -->
</body>
</html>
