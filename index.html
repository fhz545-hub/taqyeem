<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>نموذج تقييم الاداء الوظيفي للمعلمين للعام ١٤٤٧هـ</title>

<!-- خطوط -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<!-- مكتبات -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --teal:#0f4c46; --ink:#103330; --border:#e5efec; --line:#cfe1dd; --bg:#f7fbfa;
  --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
}
html,body{margin:0;padding:0;background:#fff;color:var(--ink);font-family:"Tajawal",system-ui}
*{box-sizing:border-box}

#page{width:794px;min-height:1123px;margin:0 auto;background:#fff}
.wrap{padding:6px 10px}

/* الهيدر */
header{text-align:center;margin:0 0 6px}
header .topline{font-weight:700;color:var(--teal);font-size:13px;line-height:1.25}
header .schooltitle{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:3px}
header .schooltitle h1{font-size:14.5px;color:var(--teal);margin:0}
.badge{background:#eaf4f1;border:1px solid var(--border);padding:4px 8px;border-radius:10px;font-weight:700;color:#0b2f2c;font-size:11.2px}

/* وصف */
.note{margin:6px 0 8px;color:#0f3d37;background:#edf8f4;border:1px solid var(--line);
  border-radius:10px;padding:8px 10px;line-height:1.65;font-size:12.6px}
.note b{color:#0b4f47}

/* تحرير رأس الصفحة */
.header-edit{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
.header-edit .editable{cursor:text;padding:6px 8px;border-radius:8px;background:#fff;border:1px dashed transparent}
.header-edit .editable[contenteditable="true"]{border-color:var(--border);background:#fffdea}
.small-action{font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:#fff;color:#0f4c46;cursor:pointer}

/* صف الأدوات */
.tools-grid{display:grid;gap:8px;align-items:center;margin:6px 0;grid-template-columns:repeat(12,minmax(0,1fr))}
.tool-box{display:flex;flex-wrap:wrap;align-items:center;gap:8px;background:#fbfdfc;border:1px solid var(--border);border-radius:10px;padding:6px 8px}
.btn-mini{font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid #cfe1dd;background:#fff;color:#0f4c46;cursor:pointer}
.icon-btn{width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #cfe1dd;border-radius:8px;background:#fff;cursor:pointer}
.icon-btn svg{width:18px;height:18px}
#excelInput{display:none}
.fld{height:34px;border:1px solid #cfe1dd;border-radius:8px;background:#fff;font:inherit;font-size:13px;line-height:34px;padding:0 10px;color:#103330}
.fld::placeholder{color:#9cb3af}
.badge-mini{font-size:11px;color:#4b6864}
.xs{width:120px}.xs2{width:160px}.sm{width:200px}
.col-span-4{grid-column:span 4}.col-span-3{grid-column:span 3}.col-span-2{grid-column:span 2}.col-span-1{grid-column:span 1}

/* بطاقة بيانات المعلم */
.idcard{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-start;background:#fbfdfc;border:1px solid var(--border);border-radius:10px;padding:6px 8px;margin:6px 0}
.idchip{background:#f2f7f6;border:1px solid var(--border);border-radius:10px;padding:4px 8px;font-size:11.5px;color:#0f4c46}

/* المؤشر */
.bar-row{display:flex;align-items:center;gap:6px;margin:6px 0 2px}
.chip{background:#f2f7f6;border:1px solid var(--border);padding:6px 8px;border-radius:10px;font-weight:700;color:#09312d;min-width:135px;text-align:center;font-size:11.5px}
.meter{position:relative;height:26px;flex:1;background:#eaf1ef;border:1px solid var(--border);border-radius:13px;overflow:hidden}
.fill{position:absolute;inset:3px;border-radius:11px;
/* ١ = أحمر (يسار) → ٥ = أخضر (يمين) */
background:linear-gradient(90deg,#ff3b30 0%, #ff7a59 25%, #f5b000 50%, #7ad957 75%, #22c55e 100%);}
.thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#fff;border:3px solid #b36a18;box-shadow:0 1px 5px rgba(0,0,0,.15)}
/* أرقام داخل الشريط (أسود ليتباين مع الألوان ومع الطباعة) */
.ticks{position:absolute;inset:0;pointer-events:none}
.ticks span{position:absolute;top:50%;transform:translate(-50%,-50%);font-weight:800;font-size:12px;color:#111;
  text-shadow:0 0 2px rgba(255,255,255,.6), 0 0 6px rgba(255,255,255,.6);}
.ticks .t1{left:3%}.ticks .t2{left:25%}.ticks .t3{left:50%}.ticks .t4{left:75%}.ticks .t5{left:97%}

/* الجدول */
table{width:100%;border-collapse:collapse}
th,td{background:#fff;border:1px solid var(--line);padding:6px 8px;vertical-align:middle;font-size:12.2px}
th{background:var(--teal);color:#fff;text-align:center;font-size:12px;line-height:1.2}
.w-tight{width:76px;text-align:center}.w{width:70px;text-align:center}
th .sub{display:block;font-size:10px;opacity:.92;margin-top:2px}
select.grade{width:62px;height:28px;text-align:center;border:1px solid #cfe1dd;border-radius:8px;background:#fff;font-size:12.3px}
td.brief{font-size:12.2px;color:#1d3f3b;line-height:1.55}

/* القوة/التطوير */
.cards{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:7px 8px;min-height:56px}
.card h3{margin:0 0 4px;font-size:13px}
#strength h3{color:#136b3e} #dev h3{color:#b4372d}

/* أزرار سفلية */
.actions{display:flex;gap:6px;justify-content:center;margin:8px 0 4px;flex-wrap:wrap}
.btn{padding:7px 10px;border-radius:10px;border:1px solid #cfe1dd;background:#eaf3f1;color:#09312d;font-weight:700;font-size:12.5px;cursor:pointer}
.btn.primary{background:#0f7a66;color:#fff;border-color:#0f7a66}
.btn.whatsapp{display:inline-flex;align-items:center;gap:6px;background:#c9f8dc;color:#065f46;border-color:#22c55e}
.btn.icon{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;border:1px solid #cfe1dd;background:#fff}

/* نافذة ترس واتساب */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25)}
.modal .dialog{position:relative;background:#fff;border:1px solid #dbe8e5;border-radius:12px;min-width:320px;max-width:92vw;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101}
.modal .dialog h3{margin:0 0 10px;font-size:14px;color:#0f4c46}
.modal .row{display:flex;gap:8px;align-items:center}
.modal input{flex:1;height:36px;border:1px solid #cfe1dd;border-radius:8px;padding:0 10px;font:inherit;direction:ltr}
.modal .actions{justify-content:flex-end;margin-top:10px}
.modal .actions .btn{background:#eaf3f1}
.modal .actions .btn.primary{background:#0f7a66;color:#fff}

/* تلوين قيم الدرجات */
select.grade[data-g="5"]{background:#eaf8f1}
select.grade[data-g="4"]{background:#f3faea}
select.grade[data-g="3"]{background:#fff8e8}
select.grade[data-g="2"]{background:#fff0e6}
select.grade[data-g="1"]{background:#ffe8e6}

/* حقوق */
.footer{margin:6px 0 2px;text-align:center;font-size:10.5px;color:#6a8682}
.footer:before{content:"© ";}

/* إخفاء أدوات الواجهة عند الطباعة/الحفظ */
.no-print{ }
.for-pdf .no-print{display:none !important}
@media print{
  .no-print{display:none !important}
}

/* طباعة A4 */
@page{size:A4 portrait;margin:4mm 5mm 5mm 5mm}
@media print{
  html,body{height:auto;margin:0!important;padding:0!important}
  #page{width:210mm;min-height:297mm}
  .wrap{padding:4mm 5mm}
  table{font-size:10.6px}
  td.brief{font-size:10.4px;line-height:1.4}
  th,td{padding:3.5px 5px}
  .card{min-height:44px}
  body.bw-print{filter:grayscale(100%) contrast(1.05)}
}

/* طبقة التحجيم (للحفظ فقط) */
#sheet{transform-origin:top center}

/* تجاوب */
@media (max-width:920px){
  .col-span-4,.col-span-3,.col-span-2,.col-span-1{grid-column:span 12 / span 12}
}
</style>
</head>
<body>
<div id="page">
  <div class="wrap" id="sheet">

    <!-- الهيدر -->
    <header>
      <div class="topline">
        الإدارة العامة للتعليم بالمنطقة الشرقية •
        <span id="sectorNameDisplay">قطاع التعليم بالخبر</span> •
        <span id="schoolNameDisplay">مدرسة اليعقوبي الثانوية</span>
      </div>
      <div class="schooltitle">
        <h1>تقييم الأداء الوظيفي للمعلمين للعام ١٤٤٧هـ</h1>
        <span class="badge" id="hijriChip">التاريخ الهجري: —</span>
      </div>

      <!-- تعديل رأس الصفحة -->
      <div class="header-edit no-print" style="margin-top:6px">
        <div class="tool-box">
          <span class="badge-mini">اسم المدرسة للعرض:</span>
          <div id="schoolName" class="editable" contenteditable="false">مدرسة اليعقوبي الثانوية</div>
          <button class="small-action" id="editSchoolBtn">تعديل</button>
        </div>
        <div class="tool-box">
          <span class="badge-mini">القطاع/المحافظة:</span>
          <div id="sectorName" class="editable" contenteditable="false">قطاع التعليم بالخبر</div>
          <button class="small-action" id="editSectorBtn">تعديل</button>
        </div>
        <div class="tool-box">
          <button class="small-action" id="saveSettingsBtn">حفظ</button>
          <button class="small-action" id="resetSettingsBtn">افتراضي</button>
        </div>
      </div>
    </header>

    <!-- وصف -->
    <div class="note">
      هذا <b>نموذج قبلي تدريبي</b> موجّه للمعلم بهدف <b>تعريف عناصر التقييم بدقة</b> وتيسير <b>الحوار المهني</b> بين المعلم والإدارة وفقاً لممارسات وزارة التعليم.
      حدّد درجة لكل عنصر (<b>١–٥</b>) بالاستناد إلى الأمثلة الموضّحة؛ ليُحتسب تلقائياً <b>مؤشر الإنجاز</b> وتظهر <b>نقاط القوة</b> و<b>فرص التطوير</b> بصياغات تربوية قابلة للمشاركة.
      يدعم النموذج: استيراد قائمة المعلمين من ملف <b>Excel</b>، ملخّصاً للطباعة في صفحة <b>A4</b> (ملوّن أو أبيض وأسود)، وتوليد <b>PDF</b> احترافي،
      وإرسال ملخّص مرتب عبر <b>واتساب</b>. كما يمكن <b>تعديل اسم المدرسة والقطاع/المحافظة</b> من أعلى الصفحة.
    </div>

    <!-- أدوات الاستيراد + الحقول -->
    <div class="tools-grid no-print">
      <div class="tool-box col-span-4">
        <label for="excelInput" class="icon-btn" title="استيراد ملف المعلمين (Excel)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#0f4c46" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 5 17 10"/>
            <line x1="12" y1="5" x2="12" y2="15"/>
          </svg>
        </label>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.xlsm,.xlsb,.csv"/>
        <button class="btn-mini" id="exportExcelBtn">تنزيل</button>
        <button class="btn-mini" id="clearTeachersBtn">مسح</button>
        <button class="btn-mini" id="importTemplateBtn">قالب</button>

        <select id="tSelect" class="fld xs2" style="display:none" title="الأسماء من الإكسل">
          <option value="">— اختر اسمًا —</option>
        </select>
      </div>

      <div class="col-span-3"><input class="fld" id="tName" placeholder="اسم المعلم" list="teachersList"/></div>
      <div class="col-span-2"><input class="fld" id="tId" placeholder="رقم الهوية (10 أرقام)"/></div>
      <div class="col-span-2"><input class="fld" id="tSpec" placeholder="التخصص"/></div>
      <div class="col-span-1">
        <select class="fld" id="tStage">
          <option value="الأولى" selected>الأولى</option>
          <option value="الثانية">الثانية</option>
          <option value="الثالثة">الثالثة</option>
        </select>
      </div>
      <datalist id="teachersList"></datalist>
    </div>

    <!-- بطاقة بيانات المعلم -->
    <div class="idcard">
      <span class="idchip">المعلم: <b id="s_name">—</b></span>
      <span class="idchip">الهوية: <b id="s_id">—</b></span>
      <span class="idchip">التخصص: <b id="s_spec">—</b></span>
      <span class="idchip">المرحلة: <b id="s_stage">الأولى</b></span>
    </div>

    <!-- المؤشر مع أرقام سوداء -->
    <div class="bar-row">
      <div class="chip" id="scoreChip">مؤشر الإنجاز: 0.00 / 5</div>
      <div class="meter">
        <div class="fill"></div>
        <div class="ticks">
          <span class="t1">١</span>
          <span class="t2">٢</span>
          <span class="t3">٣</span>
          <span class="t4">٤</span>
          <span class="t5">٥</span>
        </div>
        <div class="thumb" id="thumb" style="left:50%"></div>
      </div>
      <div class="chip" id="percentChip">المجموع: %0</div>
    </div>

    <!-- الجدول -->
    <table id="tbl">
      <thead>
        <tr>
          <th class="w-tight">#</th>
          <th>العنصر</th>
          <th class="w">الوزن</th>
          <th class="w-tight">الدرجة<span class="sub">(1–5)</span></th>
          <th>تفسير / أمثلة مختصرة</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <!-- القوة/التطوير -->
    <div class="cards">
      <div id="strength" class="card"><h3>نقاط القوة</h3><div id="strengthBody">—</div></div>
      <div id="dev" class="card"><h3>مجالات التطوير</h3><div id="devBody">—</div></div>
    </div>

    <!-- أسفل الصفحة (مخفية في الطباعة/الحفظ) -->
    <div class="actions no-print">
      <div class="tool-box" title="يؤثر على الطباعة فقط">
        <span class="badge-mini">وضع الطباعة:</span>
        <select id="printMode" class="fld xs">
          <option value="color" selected>ملون</option>
          <option value="bw">أبيض وأسود</option>
        </select>
      </div>

      <button class="btn" onclick="if(validate())doPrint()">طباعة A4</button>
      <button class="btn primary" id="saveBtn" onclick="if(validate())savePDF()">حفظ PDF</button>
      <button class="btn whatsapp" id="waBtn">إرسال واتساب</button>
      <button class="btn icon" id="waConfigBtn" title="ضبط رقم مدير المدرسة">
        <svg viewBox="0 0 24 24" fill="none" stroke="#0f4c46" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1z"/>
        </svg>
      </button>
    </div>

    <!-- نافذة ضبط رقم واتساب -->
    <div class="modal" id="waModal" aria-hidden="true">
      <div class="backdrop"></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="waTitle">
        <h3 id="waTitle">رقم واتساب المدير (دولي بدون +)</h3>
        <div class="row">
          <input id="waPhone" type="tel" inputmode="numeric" placeholder="مثال: 9665XXXXXXXX"/>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="waClose">إغلاق</button>
          <button class="btn primary" id="waSave">حفظ</button>
        </div>
      </div>
    </div>

    <!-- حقوق -->
    <div class="footer">
      مبادرة مدرسة اليعقوبي الثانوية بالخبر — تصميم وتنفيذ: فهد حامد الزهراني
    </div>
  </div>
</div>

<script>
/* ===== التاريخ الهجري ===== */
function hijriUmmAlQura(){
  let txt='—';
  try{
    const opt={weekday:'long',day:'numeric',month:'long',year:'numeric'};
    txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',opt).format(new Date());
  }catch(e){
    try{ txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date()); }
    catch{ txt=new Date().toLocaleDateString('ar-SA'); }
  }
  document.getElementById('hijriChip').textContent='التاريخ الهجري: '+txt+' هـ';
  return txt+' هـ';
}
const hijriToday=hijriUmmAlQura();

/* ===== إعدادات الرأس ===== */
const LS_SETTINGS='yaqubi_settings_v12';
function applyHeaderTexts(){
  const school=document.getElementById('schoolName').textContent.trim()||'مدرسة اليعقوبي الثانوية';
  const sector=document.getElementById('sectorName').textContent.trim()||'قطاع التعليم بالخبر';
  document.getElementById('schoolNameDisplay').textContent=school;
  document.getElementById('sectorNameDisplay').textContent=sector;
}
(function initHeader(){
  const s=localStorage.getItem(LS_SETTINGS);
  if(s){try{const o=JSON.parse(s);
    if(o.schoolName)document.getElementById('schoolName').textContent=o.schoolName;
    if(o.sectorName)document.getElementById('sectorName').textContent=o.sectorName;
  }catch{}}
  applyHeaderTexts();
  document.getElementById('editSchoolBtn').onclick=()=>toggleEditable('schoolName');
  document.getElementById('editSectorBtn').onclick=()=>toggleEditable('sectorName');
  document.getElementById('saveSettingsBtn').onclick=()=>{const o={schoolName:document.getElementById('schoolName').textContent||'مدرسة اليعقوبي الثانوية',sectorName:document.getElementById('sectorName').textContent||'قطاع التعليم بالخبر'};localStorage.setItem(LS_SETTINGS,JSON.stringify(o));applyHeaderTexts();alert('تم حفظ الإعدادات.')};
  document.getElementById('resetSettingsBtn').onclick=()=>{if(confirm('إعادة الإعدادات إلى الافتراضي؟')){document.getElementById('schoolName').textContent='مدرسة اليعقوبي الثانوية';document.getElementById('sectorName').textContent='قطاع التعليم بالخبر';document.getElementById('saveSettingsBtn').click();}}
})();
function toggleEditable(id){
  const el=document.getElementById(id);
  const editing=el.getAttribute('contenteditable')==='true';
  if(!editing){ el.setAttribute('contenteditable','true'); el.focus(); el.addEventListener('blur',()=>{el.setAttribute('contenteditable','false'); applyHeaderTexts();},{once:true}); }
  else{ el.setAttribute('contenteditable','false'); applyHeaderTexts(); }
}

/* ===== وضع الطباعة ===== */
const LS_PRINT='yaqubi_print_mode';
(function(){
  const sel=document.getElementById('printMode');
  sel.value=localStorage.getItem(LS_PRINT)||'color';
  applyPrintMode(sel.value);
  sel.onchange=()=>{localStorage.setItem(LS_PRINT,sel.value);applyPrintMode(sel.value);};
})();
function applyPrintMode(mode){ if(mode==='bw') document.body.classList.add('bw-print'); else document.body.classList.remove('bw-print'); }

/* ===== عناصر التقييم ===== */
const items=[
  {name:"أداء الواجبات الوظيفية",weight:10,brief:"انضباط يومي؛ التزام بالجدول والمواعيد؛ تحضير وتتبع للدرس؛ تسليم التقارير في وقتها."},
  {name:"التفاعل مع المجتمع المهني",weight:10,brief:"مجتمعات تعلم مهنية؛ تبادل زيارات؛ حضور دورات؛ مشاركة موارد وخبرات."},
  {name:"التفاعل مع أولياء الأمور",weight:10,brief:"قنوات تواصل منضبطة؛ رسائل موجزة؛ متابعة بنّاءة لحالات الطلاب."},
  {name:"التنوع في استراتيجيات التدريس",weight:10,brief:"تنويع أساليب التعلم النشط؛ مراعاة الفروق؛ أسئلة عليا؛ تعلم تعاوني."},
  {name:"تحسين نتائج المتعلمين",weight:10,brief:"قياس قبلي/بعدي؛ خطط علاج للفاقد؛ إثراء للمتفوقين؛ متابعة تقدم."},
  {name:"إعداد وتنفيذ خطة التعلم",weight:10,brief:"توزيع منهج معتمد؛ تحضير علمي؛ تقويم بنائي؛ تنفيذ ملتزم بالزمن."},
  {name:"توظيف تقنيات ووسائل التعلم المناسبة",weight:10,brief:"منصات تعليم؛ موارد تفاعلية؛ مصادر متعددة؛ محتوى منظم ومناسب."},
  {name:"تهيئة البيئة التعليمية",weight:5, brief:"تهيئة نفسية محفّزة؛ تنظيم المقاعد؛ لوحات وإرشادات صفية."},
  {name:"الإدارة الصفية",weight:5,  brief:"قواعد وضوابط واضحة؛ إدارة وقت دقيقة؛ انتقالات سلسة؛ متابعة الغياب."},
  {name:"تحليل نتائج المتعلمين وتشخيص مستوياتهم",weight:10,brief:"تحليل بنود الاختبار؛ تحديد نقاط القوة والضعف؛ تقارير مختصرة."},
  {name:"تنوع أساليب التقويم",weight:10,brief:"اختبارات تحريرية/شفهية/عملية/إلكترونية؛ مهام أداء؛ ملفات إنجاز."},
];
const strengthPhrases={ "أداء الواجبات الوظيفية":"انضباط وظيفي والتزام بالمواعيد وجودة متابعة للتحضير والتقارير.","التفاعل مع المجتمع المهني":"حضور فاعل وتبادل خبرات يثري الممارسة الصفية.","التفاعل مع أولياء الأمور":"تواصل راقٍ وموجّه يسهم في دعم تعلم الأبناء.","التنوع في استراتيجيات التدريس":"تنويع مؤثر يحقق مشاركة وفاعلية المتعلمين.","تحسين نتائج المتعلمين":"خطط علاج وإثراء انعكست على نتائج الطلاب.","إعداد وتنفيذ خطة التعلم":"تنفيذ محكم لخطة تعليمية متوازنة وتقويم بنائي.","توظيف تقنيات ووسائل التعلم المناسبة":"اختيار أدوات مناسبة تُحفّز التفاعل وتثري المحتوى.","تهيئة البيئة التعليمية":"بيئة آمنة ومحفّزة تُظهر أثرًا إيجابيًا على المشاركة.","الإدارة الصفية":"انضباط واضح وتنظيم وقت فعّال وانتقالات سلسة.","تحليل نتائج المتعلمين وتشخيص مستوياتهم":"تحليل دقيق للنتائج وتوجيه بنّاء لتحسين الأداء.","تنوع أساليب التقويم":"تقويم متنوع يقيس التعلم ويغذّيه راجعًا."};
const devPhrases={ "أداء الواجبات الوظيفية":"تعزيز توثيق التحضير وضبط المواعيد وتفعيل المتابعة الأسبوعية.","التفاعل مع المجتمع المهني":"زيادة المبادرات المهنية وتبادل الزيارات والتجارب الصفية.","التفاعل مع أولياء الأمور":"تنويع قنوات التواصل وجدولتها برسائل موجزة وواضحة.","التنوع في استراتيجيات التدريس":"توسيع التنويع وتفعيل أنشطة تعلم نشط تراعي الفروق.","تحسين نتائج المتعلمين":"تطوير خطط علاجية دقيقة وربطها بمؤشرات تقدم أسبوعية.","إعداد وتنفيذ خطة التعلم":"مراجعة التحضير العلمي وربط الأهداف بمعايير قياس واضحة.","توظيف تقنيات ووسائل التعلم المناسبة":"إثراء المحتوى بأدوات رقمية تفاعلية مناسبة للدرس.","تهيئة البيئة التعليمية":"تحسين التهيئة النفسية وتنظيم المقاعد بما يدعم التفاعل.","الإدارة الصفية":"تثبيت قواعد صفية واضحة وتحسين إدارة الوقت والانتقال.","تحليل نتائج المتعلمين وتشخيص مستوياتهم":"توسيع تحليل البنود وبناء ملفات تقدم مختصرة.","تنوع أساليب التقويم":"تفعيل التقويم العملي والشفهي والإلكتروني بشكل أوسع."};

/* بناء الجدول */
const tbody=document.getElementById('rows');
items.forEach((it,idx)=>{
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td class="w-tight" style="text-align:center">${idx+1}</td>
    <td>${it.name}</td>
    <td class="w"><b>${it.weight}%</b></td>
    <td class="w-tight">
      <select class="grade" data-g="3" aria-label="درجة العنصر">
        <option value="5">5</option><option value="4">4</option>
        <option value="3" selected>3</option><option value="2">2</option><option value="1">1</option>
      </select>
    </td>
    <td class="brief">${it.brief}</td>`;
  tbody.appendChild(tr);
});

/* حساب المؤشر */
const gradesEls=()=>[...document.querySelectorAll('.grade')];
const scoreChip=document.getElementById('scoreChip');
const percentChip=document.getElementById('percentChip');
const thumb=document.getElementById('thumb');
const strengthBody=document.getElementById('strengthBody');
const devBody=document.getElementById('devBody');
function overallText(avg){ if(avg>=4.5) return "مثالي"; if(avg>=3.5) return "تخطّى التوقعات"; if(avg>=2.5) return "وافق التوقعات"; if(avg>=1.5) return "بحاجة إلى تطوير"; return "غير مرضي"; }
function recalc(){
  let weighted=0, per=0, strengths=[], devs=[];
  gradesEls().forEach((sel,i)=>{
    const g=Number(sel.value); sel.dataset.g=g;
    const w=items[i].weight;
    weighted+=g*w; per+=(g/5)*w;
    const name=items[i].name;
    if(g>=4) strengths.push(`• ${strengthPhrases[name]}`);
    if(g<=3) devs.push(`• ${devPhrases[name]}`);
  });
  const avg=weighted/100, pct=Math.round(per);
  scoreChip.textContent=`مؤشر الإنجاز: ${avg.toFixed(2)} / 5`;
  percentChip.textContent=`المجموع: %${pct}`;
  const pos=((avg-1)/4)*100; thumb.style.left=`${pos}%`;
  thumb.style.borderColor = avg>=4.5? '#1c7f4d' : (avg<=2? '#b32828' : '#a86a19');
  strengthBody.innerHTML=strengths.length?strengths.join('<br>'):'—';
  devBody.innerHTML=devs.length?devs.join('<br>'):'—';
  return {avg,pct,overall:overallText(avg)};
}
gradesEls().forEach(el=>el.addEventListener('change',recalc));
recalc();

/* بطاقة بيانات المعلم — تحديث حي */
const s_name=document.getElementById('s_name');
const s_id=document.getElementById('s_id');
const s_spec=document.getElementById('s_spec');
const s_stage=document.getElementById('s_stage');
['tName','tId','tSpec','tStage'].forEach(id=>{
  document.getElementById(id).addEventListener('input',updateSummary);
});
function updateSummary(){
  s_name.textContent=document.getElementById('tName').value.trim()||'—';
  s_id.textContent=document.getElementById('tId').value.trim()||'—';
  s_spec.textContent=document.getElementById('tSpec').value.trim()||'—';
  s_stage.textContent=document.getElementById('tStage').value;
}
updateSummary();

/* طباعة/حفظ */
const SHEET=document.getElementById('sheet');
function fitOnce(){ const mmToPx=3.78, avail=(297-14)*mmToPx; const h=SHEET.scrollHeight, scale=Math.min(1,(avail/h)*0.995); SHEET.dataset.prev=SHEET.style.transform||''; SHEET.style.transform=`scale(${scale})`; return scale; }
function unfit(){ if(SHEET.dataset.prev!==undefined){SHEET.style.transform=SHEET.dataset.prev; delete SHEET.dataset.prev;} }
function validate(){
  const name=document.getElementById('tName').value.trim();
  const id=document.getElementById('tId').value.trim();
  const spec=document.getElementById('tSpec').value.trim();
  if(!name){ alert('رجاءً اكتب اسم المعلم أو اختره من القائمة/الاقتراحات.'); document.getElementById('tName').focus(); return false; }
  if(!/^\d{10}$/.test(id)){ alert('رجاءً أدخل رقم هوية صحيحًا (10 أرقام).'); document.getElementById('tId').focus(); return false; }
  if(!spec){ alert('رجاءً اكتب التخصص.'); document.getElementById('tSpec').focus(); return false; }
  return true;
}
function doPrint(){
  document.body.classList.add('for-pdf');      // إخفاء الأدوات
  fitOnce();
  setTimeout(()=>window.print(),60);
}
window.addEventListener('afterprint',()=>{
  unfit();
  document.body.classList.remove('for-pdf');
});

function sanitizeForFile(s){ return (s||'').replace(/[\\/:*?"<>|]/g,'-').replace(/\s+/g,' ').trim(); }
async function savePDF(){
  try{
    document.body.classList.add('for-pdf');    // إخفاء الأدوات في صورة PDF
    document.getElementById('saveBtn').disabled=true;
    const school=document.getElementById('schoolNameDisplay').textContent.trim();
    const name=sanitizeForFile(document.getElementById('tName').value||'غير مسمى');
    const stage=document.getElementById('tStage').value;
    const filename=`تقييم الأداء الوظيفي - ${school} - ${name} - مرحلة ${stage} - ${hijriToday}.pdf`;
    fitOnce(); await new Promise(r=>setTimeout(r,120));
    const node=document.getElementById('page');
    const canvas=await html2canvas(node,{useCORS:true,scale:2,background:'#ffffff',scrollX:0,scrollY:0});
    const imgData=canvas.toDataURL('image/png',1.0);
    const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
    const margin=5; const pdfW=210-2*margin, pdfH=297-2*margin;
    const imgWmm=canvas.width*0.264583, imgHmm=canvas.height*0.264583;
    const ratio=Math.min(pdfW/imgWmm, pdfH/imgHmm); const w=imgWmm*ratio, h=imgHmm*ratio;
    const x=margin+(pdfW-w)/2, y=margin+(pdfH-h)/2;
    pdf.addImage(imgData,'PNG',x,y,w,h,'','FAST'); pdf.save(filename);
  }catch(err){ alert('تعذّر الحفظ PDF.'); console.error(err);
  }finally{ unfit(); document.body.classList.remove('for-pdf'); document.getElementById('saveBtn').disabled=false; }
}

/* ===== واتساب (الترس) ===== */
const LS_WA='yaqubi_whatsapp_phone';
const waBtn=document.getElementById('waBtn');
const waConfigBtn=document.getElementById('waConfigBtn');
const waModal=document.getElementById('waModal');
const waPhone=document.getElementById('waPhone');
const waSave=document.getElementById('waSave');
const waClose=document.getElementById('waClose');
let waPendingSend=false;

function isPhoneOk(v){ const d=(v||'').replace(/\D+/g,''); return /^\d{11,15}$/.test(d) ? d : ''; }
function openModal(pending=false){
  waPendingSend=pending;
  waPhone.value=localStorage.getItem(LS_WA)||'';
  waModal.classList.add('show');
  setTimeout(()=>waPhone.focus(),80);
}
function closeModal(){ waModal.classList.remove('show'); waPendingSend=false; }
waConfigBtn.addEventListener('click',()=>openModal(false));
waBtn.addEventListener('click',(ev)=>{
  const saved=isPhoneOk(localStorage.getItem(LS_WA)||'');
  if(saved){ sendWhatsApp(saved); }
  else{ ev.preventDefault(); openModal(true); }
});
waClose.addEventListener('click',closeModal);
waModal.querySelector('.backdrop').addEventListener('click',closeModal);
waSave.addEventListener('click',()=>{
  const digits=isPhoneOk(waPhone.value.trim());
  if(!digits){ alert('أدخل رقمًا دوليًا صحيحًا بدون + (مثال: 9665XXXXXXXX).'); return; }
  localStorage.setItem(LS_WA, digits);
  const toSend=waPendingSend;
  closeModal();
  if(toSend){ sendWhatsApp(digits); } else { alert('تم حفظ رقم واتساب المدير.'); }
});

function sendWhatsApp(phoneDigits){
  if(!validate()) return;
  const school=document.getElementById('schoolNameDisplay').textContent.trim();
  const sector=document.getElementById('sectorNameDisplay').textContent.trim();
  const name=document.getElementById('tName').value.trim();
  const stage=document.getElementById('tStage').value;
  const S=recalc();
  const msg =
`السلام عليكم،
ملخص قبلي للمعلم في ${school} — ${sector}:
الاسم: ${name}
مرحلة التقييم: ${stage}
${document.getElementById('scoreChip').textContent} | ${document.getElementById('percentChip').textContent}
التقدير العام: ${S.overall}
(سيتم لاحقًا إرسال ملف PDF الكامل.)
التاريخ الهجري: ${hijriToday}`;
  const encoded=encodeURIComponent(msg);
  const url=`https://api.whatsapp.com/send?phone=${phoneDigits}&text=${encoded}`;
  const win=window.open(url,'_blank');
  setTimeout(()=>{ if(!win || win.closed || typeof win.closed==='undefined'){ window.location.href=`https://wa.me/${phoneDigits}?text=${encoded}`; }},400);
}

/* ===== استيراد/تصدير Excel ===== */
const LS_TEACHERS='yaqubi_teachers_v12';
let teachers=[]; // لا قائمة افتراضية
const datalist=document.getElementById('teachersList');
const tSelect=document.getElementById('tSelect');

function saveTeachers(){ localStorage.setItem(LS_TEACHERS, JSON.stringify(teachers)); }
function loadTeachers(){
  const raw=localStorage.getItem(LS_TEACHERS);
  teachers = raw ? (JSON.parse(raw)||[]) : [];
  rebuildTeacherUI();
}
function clearTeachers(){
  if(!confirm('سيتم مسح جميع بيانات المعلمين المحفوظة. هل تريد المتابعة؟')) return;
  localStorage.removeItem(LS_TEACHERS);
  teachers=[]; rebuildTeacherUI();
  alert('تم مسح بيانات المعلمين.');
}
document.getElementById('clearTeachersBtn').addEventListener('click',clearTeachers);

function rebuildTeacherUI(){
  // datalist
  datalist.innerHTML='';
  teachers.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.name; datalist.appendChild(opt); });
  // select
  tSelect.innerHTML='<option value="">— اختر اسمًا —</option>';
  if(teachers.length>0){
    teachers.forEach((t,i)=>{ const op=document.createElement('option'); op.value=String(i); op.textContent=t.name; tSelect.appendChild(op); });
    tSelect.style.display='inline-block';
    // تعبئة أول اسم تلقائيًا
    const first=teachers[0];
    document.getElementById('tName').value=first.name||'';
    document.getElementById('tId').value=first.id||'';
    document.getElementById('tSpec').value=first.spec||'';
    updateSummary();
  }else{
    tSelect.style.display='none';
  }
}

function normalizeHeader(h){
  if(!h) return '';
  h=String(h).trim().toLowerCase();
  const map={'name':'name','full name':'name','fullname':'name','teacher':'name','teacher name':'name','الاسم':'name','اسم':'name','اسم المعلم':'name',
             'id':'id','id number':'id','identity':'id','national id':'id','iqama':'id','الهوية':'id','رقم الهوية':'id','السجل المدني':'id',
             'spec':'spec','specialization':'spec','subject':'spec','major':'spec','التخصص':'spec','المادة':'spec','تخصص المعلم':'spec'};
  return map[h]||h;
}
function toCleanString(v){ if(v==null) return ''; if(typeof v==='number') return String(Math.trunc(v)); return String(v).trim(); }
function pickSheet(wb){ let sh=wb.Sheets[wb.SheetNames[0]]; for(const n of wb.SheetNames){const s=wb.Sheets[n];const arr=XLSX.utils.sheet_to_json(s,{header:1,defval:''});const has=arr.some(r=>r&&r.some(c=>String(c).trim()!=='')); if(has){sh=s;break;} } return sh; }
function findHeaderRow(rows){ let bi=0,bs=-1; for(let i=0;i<Math.min(rows.length,5);i++){const r=rows[i]||[];const sc=r.reduce((a,c)=>{const n=normalizeHeader(c); if(['name','id','spec'].includes(n)) a+=2; if(String(c).trim()) a+=0.5; return a;},0); if(sc>bs){bs=sc;bi=i;} } return bi; }

document.getElementById('excelInput').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:'array'});
    const sh=pickSheet(wb);
    const raw=XLSX.utils.sheet_to_json(sh,{header:1,defval:''});
    if(raw.length===0){ alert('الملف فارغ'); return; }
    const headerIdx=findHeaderRow(raw);
    const headers=raw[headerIdx].map(h=>normalizeHeader(h));
    const rows=raw.slice(headerIdx+1);
    const newTeachers=[];
    rows.forEach(r=>{
      if(r.every(c=>String(c).trim()==='')) return;
      const obj={name:'',id:'',spec:''};
      r.forEach((cell,idx)=>{
        const key=headers[idx]||'';
        const v=toCleanString(cell);
        if(!v) return;
        if(key.includes('name')) obj.name=v;
        else if(key.includes('id')) obj.id=v.replace(/\D+/g,'');
        else if(key.includes('spec')) obj.spec=v;
      });
      if(!obj.name && r[0]) obj.name=toCleanString(r[0]);
      if(!obj.id && r[1]) obj.id=toCleanString(r[1]).replace(/\D+/g,'');
      if(!obj.spec && r[2]) obj.spec=toCleanString(r[2]);
      if(obj.name) newTeachers.push(obj);
    });
    if(newTeachers.length===0){ alert('لم يتم العثور على بيانات صالحة. تأكد من أعمدة (الاسم/الهوية/التخصص).'); return; }
    teachers=newTeachers; saveTeachers(); rebuildTeacherUI();
    alert('تم استيراد القائمة بنجاح.');
  }catch(err){ console.error(err); alert('فشل استيراد الملف.'); }
  finally{ e.target.value=''; }
});

/* اختيار من القائمة المنسدلة => تعبئة الحقول */
tSelect.addEventListener('change',()=>{
  if(tSelect.value==="") return;
  const t=teachers[Number(tSelect.value)];
  document.getElementById('tName').value=t.name||'';
  document.getElementById('tId').value=t.id||'';
  document.getElementById('tSpec').value=t.spec||'';
  updateSummary();
});

/* كتابة اسم => تعبئة تلقائية */
document.getElementById('tName').addEventListener('change',()=>{
  const name=document.getElementById('tName').value.trim();
  const idx=teachers.findIndex(x=>x.name===name);
  if(idx>-1){
    const t=teachers[idx];
    document.getElementById('tId').value=t.id||'';
    document.getElementById('tSpec').value=t.spec||'';
    updateSummary();
  }
});

/* تنزيل الملف الحالي */
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  if(!teachers || teachers.length===0){ alert('لا توجد بيانات لتصدير.'); return; }
  const header=['الاسم','رقم الهوية','التخصص'];
  const data=teachers.map(t=>[t.name,t.id,t.spec]);
  const ws=XLSX.utils.aoa_to_sheet([header,...data]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'المعلمون');
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  saveAs(new Blob([wbout],{type:'application/octet-stream'}),'قائمة_المعلمين.xlsx');
});

/* تنزيل قالب فارغ */
document.getElementById('importTemplateBtn').addEventListener('click', ()=>{
  const header=['الاسم','رقم الهوية','التخصص'];
  const ws=XLSX.utils.aoa_to_sheet([header,['مثال: محمد علي','1010101010','رياضيات']]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'قالب_المعلمين');
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  saveAs(new Blob([wbout],{type:'application/octet-stream'}),'قالب_المعلمين.xlsx');
});

/* تهيئة مبدئية */
(function mobileTune(){ if(window.innerWidth<640){ document.documentElement.style.fontSize='14px'; }})();
</script>
</body>
</html>
