<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>نموذج تقييم الأداء الوظيفي — ثانوية اليعقوبي</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet"/>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
:root{
  --teal:#0f4c46; --teal2:#1e8a79; --ink:#0b2f2b; --muted:#5a7a74;
  --bg:#ffffff; --line:#d6e7e2; --border:#eaf3f1; --chip:#f4fbf9; --bar:#f8fffc;
  --shared:#cfeee3; --role:#e8f3ef; --extra:#efefef;
  --gloss1:#10b981; --gloss2:#34d399; --warn:#fbbf24; --danger:#f87171;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;color:var(--ink);font-family:"Tajawal",system-ui}
#page{width:min(1120px,100%);margin:0 auto;padding:10px}

/* رأس ثلاثي */
.header-grid{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;margin-bottom:8px}
.h-left{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;text-align:center}
.h-left .line{font-weight:800;color:#16544c;line-height:1.1}
.edit-icon{margin-inline-start:6px;cursor:pointer;font-size:12px;border:1px solid var(--border);border-radius:8px;padding:1px 5px;background:#fff}
.h-center{display:flex;justify-content:center;align-items:center}
.h-right{display:flex;flex-direction:column;gap:4px;align-items:flex-start;justify-content:center;padding-inline-end:40px} /* إزاحة يسارًا قرب الشعار */
.h-right .today{font-weight:800;color:#16544c}
.h-right .model{font-weight:800}
#moeLogo{width:min(220px,42vw);height:auto;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(0,0,0,.12))}

/* القوائم المنسدلة */
.picker-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center;margin:8px 0}
.pill-select{position:relative}
.pill-select select{appearance:none;width:100%;height:38px;padding:0 34px 0 12px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:800;color:#0c3f39;cursor:pointer}
.pill-select .ico{position:absolute;inset-inline-end:10px;top:50%;transform:translateY(-50%);pointer-events:none;color:#0c3f39}

/* سطر المرحلة المندمج */
.stage-inline{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 10px;margin:6px 0}
.stage-inline div{display:flex;gap:8px;flex-wrap:wrap}
.stage-chip{background:#f6fffb;border:1px dashed #d9efe9;border-radius:10px;padding:6px 10px;font-weight:700}

/* صف البيانات */
.data-row{display:grid;grid-template-columns:2fr repeat(3,1fr);gap:8px;margin:8px 0}
.input-wrap{position:relative}
.lined{height:44px;border:1px solid var(--border);border-radius:12px;padding:0 42px 0 10px;width:100%}
.in-icon{position:absolute;inset-inline-start:10px;top:50%;transform:translateY(-50%);font-weight:900;color:#0b534b;cursor:pointer}

/* نافذة العدسة */
.mini{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
.mini .card{width:min(780px,96%);background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 16px 48px rgba(0,0,0,.22)}
.mini .row{display:grid;grid-template-columns:1fr auto;gap:8px}
.list{max-height:300px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:6px;margin-top:8px}

/* مؤشر موجات */
.kpi-wrap{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#ffffff 70%,#ffffff00);padding:6px 0 2px;margin:2px 0}
.kpi-bar{position:relative;height:16px;border-radius:999px;overflow:hidden;border:1px solid #e9f4f1}
.kpi-fill{position:absolute;inset:0;width:0%}
.kpi-fill::before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,var(--danger),var(--warn),var(--gloss2),var(--gloss1));opacity:.9}
.kpi-waves{position:absolute;left:0;bottom:0;height:42px;width:200%;background:radial-gradient(circle at 25% 120%, rgba(255,255,255,.6) 24%, transparent 26%) repeat-x;background-size:40px 40px;animation:waves 3s linear infinite;opacity:.45}
@keyframes waves{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.kpi-label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);padding:2px 4px}

/* الجدول */
.table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
.table th,.table td{border:1px solid var(--line);background:#fff}
.table th{background:linear-gradient(90deg,#1e8a79,#2aa68a);color:#fff;padding:10px}
th.items{width:58%} th.weight{width:12%} th.scale{width:14%} th.result{width:16%}
td.result{white-space:nowrap}

/* سلّم التقدير */
.select-mini{appearance:none;background:transparent;border:none;padding:2px 8px;border-radius:8px;cursor:pointer;font-weight:800;color:#0b3430}
.select-mini:focus{outline:2px solid #b6e7dc}

/* تلوين صفوف حسب الدرجة */
tr.rate-1 td{background:#fff0f0}
tr.rate-2 td{background:#fff7e8}
tr.rate-3 td{background:#f8fbfb}
tr.rate-4 td{background:#f0fff7}
tr.rate-5 td{background:#e7fff2}

/* رقم العنصر */
.bullet{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:6px;font-weight:800;margin-inline-end:6px}
.b-shared{background:var(--shared);color:#0c443e}
.b-role{background:var(--role);color:#0c443e}
.b-extra{background:var(--extra);color:#333}

/* مربعات القوة/التطوير */
.two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}

/* قسم التوقيعات المستقل */
.sign-section{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0}
.sign-box{border:1px dashed var(--border);border-radius:10px;padding:8px;height:66px}

/* شريط الأزرار — ثابت داخل الصفحة بعد التوقيع */
.actions{position:sticky;bottom:0;z-index:30;display:flex;gap:10px;flex-wrap:wrap;padding:10px;background:var(--bar);border-top:1px solid var(--border);box-shadow:0 -8px 20px rgba(0,0,0,.06);justify-content:center}
.pill{border:1px solid var(--border);background:linear-gradient(180deg,#fff,#f7fffd);border-radius:12px;padding:10px 12px;font-weight:800;color:#0c3f39;cursor:pointer}
.pill.primary{background:linear-gradient(180deg,#1e8a79,#0f4c46);color:#fff;border-color:#0f4c46}

/* مودالات عامة */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:60}
.panel{width:min(900px,96%);background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 16px 48px rgba(0,0,0,.22)}
.close{display:flex;justify-content:flex-end}
.title{font-weight:900;color:#0c4f47;font-size:18px}
.hr{height:1px;background:var(--border);margin:8px 0}

/* تذييل */
.footer{text-align:center;margin:12px 2px 4px 2px;color:#6a7f7b;font-size:12px}

/* تجاوبية وطباعة */
@media (max-width:880px){ .data-row{grid-template-columns:1fr 1fr;grid-auto-rows:auto} .picker-row{grid-template-columns:1fr 1fr} .two,.sign-section{grid-template-columns:1fr}}
@media print{ .no-print,.actions,.mini,.modal{display:none!important} body{background:#fff} #page{padding:0} }
</style>
</head>
<body>
<div id="page">
  <header class="header-grid">
    <div class="h-left">
      <div class="line">المملكة العربية السعودية</div>
      <div class="line">وزارة التعليم</div>
      <div class="line">
        <span id="dirText">الإدارة العامة للتعليم بالمنطقة الشرقية</span>
        <button id="editDir" class="edit-icon no-print" title="تعديل">✎</button>
      </div>
      <div class="line">
        <span id="schoolText">ثانوية اليعقوبي</span>
        <button id="editSchool" class="edit-icon no-print" title="تعديل">✎</button>
      </div>
    </div>

    <div class="h-center">
      <img id="moeLogo" alt="شعار وزارة التعليم" src="وزارة التعليم.png"
        onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'220\\' height=\\'90\\'><rect fill=\\'white\\' width=\\'100%\\' height=\\'100%\\'/><text x=\\'50%\\' y=\\'55%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-family=\\'Tajawal\\' font-weight=\\'800\\' font-size=\\'20\\' fill=\\'#1e8a79\\'>وزارة التعليم</text></svg>');"/>
    </div>

    <div class="h-right">
      <div class="today" id="todayTxt">—</div>
      <div id="dateTxt" style="color:#466e69">—</div>
      <div class="model" id="modelTxt">نموذج التقييم: —</div>
    </div>
  </header>
  <section class="picker-row no-print">
    <div class="pill-select"><select id="modelSelect">
      <option value="teacher">معلم</option>
      <option value="vp">وكيل</option>
      <option value="principal">مدير</option>
      <option value="activity">رائد نشاط</option>
      <option value="health">موجه صحي</option>
      <option value="counselor">موجه طلابي</option>
      <option value="lab">محضر مختبر</option>
      <option value="kg">معلمة رياض أطفال</option>
    </select><span class="ico">▾</span></div>

    <div class="pill-select"><select id="stageSelect">
      <option value="planning">التخطيط</option>
      <option value="mid">المراجعة النصف سنوية</option>
      <option value="final">التقييم النهائي</option>
    </select><span class="ico">▾</span></div>

    <button id="btnGapPlan" class="pill primary">خطة تحسين فجوة الأداء</button>
  </section>
  <section class="stage-inline" id="stageInline">
    <div id="stageChips"></div>
  </section>
  <section class="data-row no-print">
    <div class="input-wrap">
      <input id="tName" class="lined" placeholder="اسم الموظف/المعلم"/>
      <span class="in-icon" id="openMini">🔎</span>
    </div>
    <input id="tId"   class="lined" inputmode="numeric" placeholder="رقم الهوية"/>
    <input id="tSpec" class="lined" placeholder="التخصص"/>
    <input id="tRank" class="lined" placeholder="المرتبة/الرتبة"/>
  </section>

  <div class="mini" id="mini">
    <div class="card">
      <div class="row">
        <input id="qName" class="lined" placeholder="ابحث عن اسم"/>
        <div style="display:flex;gap:8px">
          <input type="file" id="xlsInput" accept=".xlsx,.xls,.csv"/>
          <button id="btnTpl" class="pill">⬇️ قالب Excel</button>
        </div>
      </div>
      <div class="list" id="nameList"></div>
      <div style="text-align:end;margin-top:8px"><button id="miniClose" class="pill">إغلاق</button></div>
    </div>
  </div>
  <div class="kpi-wrap">
    <div class="kpi-bar"><div class="kpi-fill" id="kpiFill"></div><div class="kpi-waves" id="kpiWaves"></div></div>
    <div class="kpi-label"><div id="kpiLabelL">مؤشر الإنجاز: 0%</div><div id="kpiLabelR">مجموع الأوزان: 0%</div></div>
  </div>
  <section id="rubric">
    <table class="table">
      <thead>
        <tr>
          <th class="items">عناصر التقييم</th>
          <th class="weight">الوزن النسبي</th>
          <th class="scale">سلم التقدير</th>
          <th class="result">الناتج الموزون</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <th>التقدير العام للأداء</th>
          <th id="sumWeight">0%</th>
          <th></th>
          <th id="sumScore">0.00</th>
        </tr>
      </tfoot>
    </table>
  </section>
  <section class="two">
    <div class="stage-inline">
      <h3 style="margin:0 0 6px;color:#0c4f47">نقاط القوة</h3>
      <p id="strengthsBox">—</p>
    </div>
    <div class="stage-inline">
      <h3 style="margin:0 0 6px;color:#0c4f47">مجالات التحسين والتطوير</h3>
      <p id="improveBox">—</p>
    </div>
  </section>
  <section class="sign-section">
    <div>
      <div style="font-weight:800;color:#0c4f47">اسم المعلم/الموظف</div>
      <div id="signTeacherName" class="sign-box">—</div>
      <div style="font-weight:800;color:#0c4f47;margin-top:6px">التوقيع</div>
      <div class="sign-box"></div>
    </div>
    <div>
      <div style="font-weight:800;color:#0c4f47">اسم مدير المدرسة</div>
      <div id="signPrincipalName" class="sign-box">فهد حامد علي الزهراني</div>
      <div style="font-weight:800;color:#0c4f47;margin-top:6px">التوقيع</div>
      <div class="sign-box"></div>
    </div>
  </section>
  <div class="actions no-print" id="actionsBar">
    <button class="pill" id="btnPrint">🖨️ طباعة</button>
    <button class="pill primary" id="btnPdf">🧾 PDF</button>
    <button class="pill" id="btnSave">💾 حفظ</button>
    <button class="pill" id="btnClear">🧹 مسح</button>
    <button class="pill" id="btnExport">📊 تصدير</button>
    <button class="pill" id="btnClipboard">🗂️ الحافظة</button>
    <button class="pill" id="openHelp">ℹ️ الشرح</button>
    <button class="pill" id="openRubrics">📑 الأدلة</button>
  </div>
  <div class="modal" id="helpModal">
    <div class="panel">
      <div class="close"><button data-close="#helpModal" class="pill">✖ إغلاق</button></div>
      <div class="title">دليل الاستخدام</div><div class="hr"></div>
      <ol style="line-height:1.9">
        <li>اختر «النموذج» و«المرحلة»؛ تُولَّد البنود والأوزان وسطر «ما ينبغي عمله» تلقائيًا وقابلًا للتعديل.</li>
        <li>أدخل الاسم أو استخدم 🔎 لاستيراد Excel: (الاسم/الهوية/التخصص/المرتبة/المسمى) بأي ترتيب، وسيُتعرّف عليها تلقائيًا.</li>
        <li>قيّم البنود من 1–5؛ تُحسب النتائج ويُحدّث مؤشر الإنجاز وتستنبط القوة/التحسين.</li>
        <li>احفظ/استرجع تلقائيًا لكل (اسم+نموذج+مرحلة). اطبع أو احفظ PDF بدون الأزرار.</li>
        <li>أنشئ «خطة تحسين فجوة الأداء» من الزر العلوي؛ تُملأ خوارزميًا وتحفظ PDF مستقل.</li>
      </ol>
    </div>
  </div>

  <div class="modal" id="reportsModal">
    <div class="panel">
      <div class="close"><button data-close="#reportsModal" class="pill">✖ إغلاق</button></div>
      <div class="title">أدلة التقارير</div><div class="hr"></div>
      <ul style="line-height:1.9">
        <li>الاحتساب: (الدرجة ÷ 5) × الوزن = الناتج الموزون.</li>
        <li>مستويات التقدير: 1 غير مرضي، 2 بحاجة لتطوير، 3 وافق التوقعات، 4 تخطى التوقعات، 5 مثالي.</li>
        <li>تصنيف البنود: مشتركة / وفق الأدوار / عمل إضافي — تمييز أرقام البنود لونيًا.</li>
        <li>توثيق الشواهد الرقمية والميدانية في كل مرحلة وربطها بالخطة التحسينية.</li>
      </ul>
    </div>
  </div>
<script>
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];

const TITLE_BY_MODEL={ teacher:'معلم', activity:'رائد نشاط', health:'موجه صحي', kg:'معلمة رياض أطفال', lab:'محضر مختبر', counselor:'موجه طلابي', vp:'وكيل', principal:'مدير' };
const REQUIRED={ teacher:11, activity:15, health:14, kg:19, lab:13, counselor:13, vp:19, principal:19 };
const TYPE_COLOR = { shared:'b-shared', role:'b-role', extra:'b-extra' };

/* اليوم والتاريخ */
(function(){
  const days=['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
  const d=new Date();
  $('#todayTxt').textContent = days[d.getDay()];
  $('#dateTxt').textContent = d.toLocaleDateString('ar-SA');
})();

/* تعديل الإدارة/المدرسة */
function promptEdit(id,key,def){
  const v=prompt("أدخل النص:", localStorage.getItem(key)||def||"");
  if(v){ $(id).textContent=v; localStorage.setItem(key,v); }
}
$('#editDir').addEventListener('click',()=> promptEdit('#dirText','dirText',$('#dirText').textContent));
$('#editSchool').addEventListener('click',()=> promptEdit('#schoolText','schoolText',$('#schoolText').textContent));
$('#dirText').textContent    = localStorage.getItem('dirText')    || $('#dirText').textContent;
$('#schoolText').textContent = localStorage.getItem('schoolText') || $('#schoolText').textContent;
</script>
<script>
const RUBRICS_OFFICIAL_1447 = {
  teacher:[{name:"أداء الواجبات الوظيفية",weight:10,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:10,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:10,type:'shared'},{name:"التنوع في استراتيجيات التدريس",weight:10,type:'role'},{name:"تحسين نتائج المتعلمين",weight:10,type:'role'},{name:"إعداد وتنفيذ خطة التعلم",weight:10,type:'role'},{name:"توظيف تقنيات ووسائل التعلم المناسبة",weight:10,type:'role'},{name:"تهيئة بيئة تعليمية",weight:5,type:'role'},{name:"الإدارة الصفية",weight:5,type:'role'},{name:"تحليل نتائج المتعلمين وتشخيص مستوياتهم",weight:10,type:'role'},{name:"تنوع أساليب التقويم",weight:10,type:'role'}],
  activity:[{name:"أداء الواجبات الوظيفية",weight:10,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:10,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:5,type:'shared'},{name:"التنوع في استراتيجيات التدريس",weight:5,type:'role'},{name:"تحسين نتائج المتعلمين",weight:5,type:'role'},{name:"إعداد وتنفيذ خطة التعلم",weight:10,type:'role'},{name:"توظيف تقنيات ووسائل التعلم المناسبة",weight:5,type:'role'},{name:"تهيئة بيئة تعليمية",weight:5,type:'role'},{name:"الإدارة الصفية",weight:5,type:'role'},{name:"تحليل نتائج المتعلمين وتشخيص مستوياتهم",weight:5,type:'role'},{name:"تنوع أساليب التقويم",weight:5,type:'role'},{name:"إعداد خطة مزمنة ومعتمدة لبرامج وفعاليات النشاط الطلابي",weight:10,type:'extra'},{name:"تهيئة البيئة المدرسية للبرامج والأنشطة الطلابية",weight:5,type:'extra'},{name:"يدعم المتعلمين وفق احتياجاتهم وميولهم للنشاط",weight:5,type:'extra'},{name:"تحفيز المتعلمين على المشاركة في الأنشطة",weight:10,type:'extra'}],
  health:[{name:"أداء الواجبات الوظيفية",weight:10,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:10,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:10,type:'shared'},{name:"التنوع في استراتيجيات التدريس",weight:5,type:'role'},{name:"تحسين نتائج المتعلمين",weight:5,type:'role'},{name:"إعداد وتنفيذ خطة التعلم",weight:5,type:'role'},{name:"توظيف تقنيات ووسائل التعلم المناسبة",weight:5,type:'role'},{name:"تهيئة بيئة تعليمية",weight:5,type:'role'},{name:"الإدارة الصفية",weight:5,type:'role'},{name:"تحليل نتائج المتعلمين وتشخيص مستوياتهم",weight:5,type:'role'},{name:"تنوع أساليب التقويم",weight:5,type:'role'},{name:"تنفيذ الخطة المشتركة للبرامج الصحية المدرسية",weight:15,type:'extra'},{name:"حصر الحالات الصحية للمتعلمين",weight:5,type:'extra'},{name:"تهيئة البيئة الصحية المدرسية",weight:10,type:'extra'}],
  kg:[{name:"أداء الواجبات الوظيفية",weight:10,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:5,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:5,type:'shared'},{name:"التنوع في استراتيجيات التدريس",weight:5,type:'role'},{name:"تحسين نواتج التعلم",weight:5,type:'role'},{name:"اعتماد ممارسات تعليمية مسؤولة للأطفال",weight:5,type:'role'},{name:"إعداد خطط التعلم",weight:5,type:'role'},{name:"توظيف تقنيات ووسائل التعلم المناسبة",weight:5,type:'role'},{name:"التقيد بمنهاج المادة العلمية",weight:5,type:'role'},{name:"استخدام استراتيجيات تدريس فاعلة ومتنوعة",weight:5,type:'role'},{name:"إشراك الأسرة في خطط النمو والتعلم",weight:5,type:'role'},{name:"تهيئة بيئة تعليمية آمنة ومُمكِّنة للتطور والتعلم",weight:15,type:'role'},{name:"توفير ركن موضوعي ملائم لتفاعلات ونمو الطفل",weight:5,type:'role'},{name:"تتبع تقدم الأطفال ونتائج تعلمهم بانتظام",weight:5,type:'role'},{name:"التقويم المستمر والمتنوع لقياس النمو والتعلم",weight:5,type:'role'},{name:"تشارك في الأنشطة التربوية",weight:5,type:'role'},{name:"تبادل الخبرات المهنية",weight:5,type:'role'},{name:"تدعم مكتسبات المتعلمين من المهارات والقيم والاتجاهات",weight:5,type:'role'},{name:"تدعم اكـتساب المتعلمين القيم والمبادئ والاتجاهات",weight:5,type:'role'}],
  lab:[{name:"أداء الواجبات الوظيفية",weight:10,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:10,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:10,type:'shared'},{name:"التنوع في استراتيجيات التدريس",weight:10,type:'role'},{name:"تحسين نتائج المتعلمين",weight:10,type:'role'},{name:"إعداد خطة تشغيل المختبر",weight:5,type:'role'},{name:"المعرفة والمهارات اللازمة لأداء التجارب العملية",weight:5,type:'role'},{name:"يوفّر مستلزمات وتجهيزات أداء التجارب العلمية",weight:5,type:'role'},{name:"يلتزم بسياسات وإجراءات السلامة المهنية",weight:5,type:'role'},{name:"يحضر ويجهز المختبر",weight:5,type:'role'},{name:"تهيئة وتسليم الأجهزة المطلوبة للمعلمين وتخزينها بطريقة سليمة",weight:5,type:'role'},{name:"إعداد تقرير أنشطة ومهام المختبر الأسبوعية",weight:10,type:'extra'},{name:"إعداد تقارير دورية عن حالة الأجهزة والمعدات",weight:10,type:'extra'}],
  counselor:[{name:"أداء الواجبات الوظيفية",weight:20,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:5,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:5,type:'shared'},{name:"يقدم التدخلات المناسبة لتعزيز الانضباط",weight:5,type:'role'},{name:"تقديم برامج تربوية لتعزيز دافعية الطلبة للتعلم",weight:5,type:'role'},{name:"إعداد خطة لبرامج التوجيه الطلابي",weight:10,type:'role'},{name:"يصنف الحالات ويقدم برامج الدعم المناسبة",weight:10,type:'role'},{name:"يعزز القيم والسلوكيات للمتعلمين",weight:10,type:'role'},{name:"يقدم التدخلات النفسية والاجتماعية",weight:10,type:'role'},{name:"يساعد المتعلمين على التخطيط المهني والتعليمي",weight:5,type:'role'},{name:"يعزز التفوق الدراسي",weight:5,type:'role'},{name:"يقدم تدخلات تربوية للمتأخرين دراسيًا والمعيدين",weight:5,type:'role'},{name:"توعية المتعلمين وأولياء أمورهم بقواعد السلوك والمواظبة",weight:5,type:'role'}],
  vp:[{name:"أداء الواجبات الوظيفية",weight:5,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:5,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:5,type:'shared'},{name:"مرن وقادر على تنفيذ أعماله في ظل ظروف العمل المختلفة",weight:5,type:'role'},{name:"يدعم ويشارك في المبادرات النوعية",weight:5,type:'role'},{name:"يتخذ إجراءات وقائية لتحقيق الانضباط المدرسي",weight:10,type:'role'},{name:"يدير الموارد في المدرسة",weight:5,type:'role'},{name:"يسهم في إعداد خطة التطوير المهني",weight:5,type:'role'},{name:"يتابع التغذية الراجعة ونتائج تحقق مؤشرات الأداء الوظيفي",weight:5,type:'role'},{name:"يقيم أداء منسوبي المدرسة",weight:5,type:'role'},{name:"ينفذ إجراءات علمية لتحسين نتائج التعلم",weight:5,type:'role'},{name:"يسهم في تحسين مستوى أداء المدرسة",weight:15,type:'role'},{name:"يشارك في إعداد الخطط المدرسية اللازمة",weight:5,type:'role'},{name:"يتابع تنفيذ الخطط المدرسية بمختلف أنواعها",weight:5,type:'role'},{name:"تهيئة الفرص والإمكانات الداعمة لمشاركة الطلاب في الأنشطة الصفية وغير الصفية",weight:5,type:'role'},{name:"يوظف المنصات الرقمية وتطبيقاتها المعتمدة في دعم عمليات التعليم والتعلم",weight:5,type:'role'},{name:"يتابع تعزيز السلوك الإيجابي للطلاب",weight:5,type:'role'},{name:"يهيئ بيئة مدرسية آمنة ومُمكِّنة على التعلم",weight:5,type:'role'},{name:"التقدير العام للأداء (احتساب آلي)",weight:0,type:'extra'}],
  principal:[{name:"أداء الواجبات الوظيفية",weight:5,type:'shared'},{name:"التفاعل مع المجتمع المهني",weight:5,type:'shared'},{name:"التفاعل مع أولياء الأمور",weight:5,type:'shared'},{name:"مرن وقادر على تنفيذ أعماله في ظل ظروف العمل المختلفة",weight:5,type:'role'},{name:"يدعم ويشارك في المبادرات النوعية",weight:5,type:'role'},{name:"يتخذ إجراءات وقائية لتحقيق الانضباط المدرسي",weight:5,type:'role'},{name:"يدير الموارد في المدرسة",weight:5,type:'role'},{name:"يسهم في إعداد خطة التطوير المهني",weight:5,type:'role'},{name:"يتابع التغذية الراجعة ونتائج تحقق مؤشرات الأداء الوظيفي",weight:5,type:'role'},{name:"يقيم أداء منسوبي المدرسة",weight:5,type:'role'},{name:"يدعم تنفيذ برامج التطوير المهني",weight:5,type:'role'},{name:"يسهم تنفيذ خطة التطوير المهني",weight:15,type:'role'},{name:"يسهم في تحسين مستوى أداء المدرسة",weight:10,type:'role'},{name:"يشارك في إعداد الخطط المدرسية اللازمة",weight:5,type:'role'},{name:"يتابع تنفيذ الخطط المدرسية بمختلف أنواعها",weight:5,type:'role'},{name:"تهيئة الفرص والإمكانات الداعمة لمشاركة الطلاب في الأنشطة الصفية وغير الصفية",weight:5,type:'role'},{name:"يوظف المنصات الرقمية وتطبيقاتها المعتمدة في دعم عمليات التعليم والتعلم",weight:5,type:'role'},{name:"يتابع تعزيز السلوك الإيجابي للطلاب",weight:5,type:'role'},{name:"يهيئ بيئة مدرسية آمنة ومُمكِّنة على التعلم",weight:5,type:'role'}]
};
</script>
<script>
function assertCount(key, arr){ const need=REQUIRED[key], have=(arr||[]).length; if(have!==need) throw new Error(`النموذج «${TITLE_BY_MODEL[key]}»: البنود (${have}) ≠ المطلوب (${need}).`); }

function buildRows(items){
  const tb=$("#rows"); tb.innerHTML=""; let wsum=0;
  items.forEach((it,i)=>{
    wsum+=+it.weight;
    const tr=document.createElement('tr'); tr.dataset.w=it.weight;
    tr.innerHTML=`
      <td><span class="bullet ${TYPE_COLOR[it.type]||'b-role'}">${i+1}</span><span class="item-text">${it.name}</span></td>
      <td style="text-align:center">${it.weight}%</td>
      <td style="text-align:center"><select class="select-mini grade"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select></td>
      <td class="result" style="text-align:center"><span class="score">0.00</span></td>`;
    tb.appendChild(tr);
  });
  $("#sumWeight").textContent=wsum+"%";
}

function recalc(){
  let total=0, wsum=0;
  $$('#rows tr').forEach(tr=>{
    const w=+tr.dataset.w||0; wsum+=w;
    const v=+tr.querySelector('.grade').value||1;
    const s=(v/5)*w; total+=s;
    tr.querySelector('.score').textContent=s.toFixed(2);
    for(let k=1;k<=5;k++) tr.classList.remove('rate-'+k);
    tr.classList.add('rate-'+v);
  });
  $("#sumScore").textContent=total.toFixed(2);
  const pct=Math.max(0,Math.min(100,total));
  $("#kpiFill").style.width=pct+"%";
  $("#kpiLabelL").textContent=`مؤشر الإنجاز: ${pct.toFixed(0)}%`;
  $("#kpiLabelR").textContent=`مجموع الأوزان: ${wsum}%`;
}

document.addEventListener('change',e=>{ if(e.target.classList.contains('grade')){ recalc(); buildInsights(); autoSave(); }});

/* ما ينبغي عمله لكل مرحلة */
const SHOULD={};
SHOULD.planning={teacher:["تحديد أهداف قابلة للقياس","تحليل النتائج","تخطيط مهام متنوعة","شواهد متوقعة"],activity:["خطة نشاط","تنظيم فرق","مواءمة البرامج","توثيق الشواهد"],health:["تفعيل الخطة الصحية","حصر الحالات","توعية دورية","تهيئة البيئة"],kg:["تخطيط مراعي للطفل","شراكة الأسرة","تنويع اللعب","تهيئة ركن"],lab:["خطة تشغيل","جرد وتجهيز","سلامة","تقارير"],counselor:["خطة توجيه","تصنيف الحالات","تعزيز الانضباط","إرشاد أكاديمي"],vp:["خطة انضباط","تتبّع المؤشرات","إدارة الموارد","تطوير الكوادر"],principal:["خطة تحسين","تمكين المتابعة","تعزيز الانضباط","رفع كفاءة التطوير"]};
SHOULD.mid={teacher:["توثيق ما تحقق","إجراءات تصحيحية","تحليل قبلي/بعدي","تعزيز التغذية الراجعة"],activity:["قياس أثر","تحسين الخطة","شراكات","توثيق"],health:["حملات صحية","متابعة الحالات","تحسين البيئة","قياس الأثر"],kg:["متابعة النمو","تحسين الركن","تواصل الأسرة","تصحيح الممارسة"],lab:["تحديث سجل السلامة","معالجة النواقص","توثيق التجارب","تقارير"],counselor:["تحليل الانضباط","مواءمة الخطة","رفع الأثر","دعم التفوق"],vp:["تحسين المؤشرات","فاعلية المنصات","تطوير الأداء","تعزيز المشاركة"],principal:["تحسين الأداء","تطوير الخطط","رفع أثر التطوير","تعزيز السلوك"]};
SHOULD.final={teacher:["ملخص الإنجاز","أثر التحسين","خطة العام القادم","مشروعات تعلم"],activity:["نِسَب المشاركة","أثر الفعاليات","خطة قادمة","شراكات"],health:["نتائج البرامج","تحسن البيئة الصحية","خطة تطوير","شراكات"],kg:["تحسن النمو","فعالية التعلم باللعب","خطة تطوير","مشاركة الأسرة"],lab:["تشغيل المختبر","سلامة","خطة تطوير","إثراء عملي"],counselor:["أثر التوجيه","نجاعة التدخلات","خطة الحالات","شراكات"],vp:["تحسن المؤشرات","فاعلية الموارد","رفع الأداء","خطة تحسين قادمة"],principal:["تحسن أداء المدرسة","نجاعة التخطيط","تطوير التطوير المهني","مبادرات نوعية"]};

function updateStageInline(){
  const model=$('#modelSelect').value, stage=$('#stageSelect').value;
  const list=SHOULD[stage][model]||[];
  const box=$('#stageChips'); box.innerHTML='';
  list.forEach(txt=>{
    const chip=document.createElement('span'); chip.className='stage-chip'; chip.contentEditable='true'; chip.textContent=txt; box.appendChild(chip);
  });
}
</script>
<script>
function buildInsights(){
  const items=$$('#rows tr'); if(!items.length){ $('#strengthsBox').textContent='—'; $('#improveBox').textContent='—'; return; }
  const strengths=[], improve=[];
  items.forEach(tr=>{
    const v=+tr.querySelector('.grade').value||1;
    const name=tr.querySelector('.item-text').textContent.trim();
    if(v>=4) strengths.push(name);
    if(v<=2) improve.push(name);
  });
  const uniq=a=>[...new Set(a)].slice(0,6);
  $('#strengthsBox').textContent = (uniq(strengths).length? '• '+uniq(strengths).join('\n• '):'—');
  $('#improveBox').textContent   = (uniq(improve).length?   '• '+uniq(improve).join('\n• '):'—');
  $('#signTeacherName').textContent = $('#tName').value || '—';
}
function keyFor(){ return `PF_${($('#tName').value||'').trim()}_${$('#modelSelect').value}_${$('#stageSelect').value}`; }
function autoSave(){
  const rows=$$('#rows tr').map(tr=>({n:tr.querySelector('.item-text').textContent,w:+tr.dataset.w,v:+tr.querySelector('.grade').value}));
  const data={dir:$('#dirText').textContent,school:$('#schoolText').textContent,model:$('#modelSelect').value,stage:$('#stageSelect').value,rows,meta:{name:$('#tName').value,id:$('#tId').value,spec:$('#tSpec').value,rank:$('#tRank').value},ins:{s:$('#strengthsBox').textContent,i:$('#improveBox').textContent},sum:$('#sumScore').textContent};
  localStorage.setItem(keyFor(),JSON.stringify(data));
}
function tryLoad(){
  const raw=localStorage.getItem(keyFor()); if(!raw) return;
  const d=JSON.parse(raw);
  $('#tId').value=d.meta.id||''; $('#tSpec').value=d.meta.spec||''; $('#tRank').value=d.meta.rank||'';
  $$('#rows tr').forEach((tr,i)=>{ const r=d.rows[i]; if(r) tr.querySelector('.grade').value=r.v; });
  recalc(); buildInsights();
}
function applyModelStage(){
  const key=$('#modelSelect').value, arr=RUBRICS_OFFICIAL_1447[key]||[]; assertCount(key,arr);
  buildRows(arr); recalc(); buildInsights();
  $('#modelTxt').textContent='نموذج التقييم: '+TITLE_BY_MODEL[key];
  updateStageInline(); tryLoad();
}
$('#modelSelect').addEventListener('change',()=>{ applyModelStage(); autoSave();});
$('#stageSelect').addEventListener('change',()=>{ updateStageInline(); buildInsights(); tryLoad(); autoSave(); });
applyModelStage();

/* العدسة وقالب Excel */
$('#openMini').addEventListener('click',()=> {refreshNameList(); $('#mini').style.display='flex';});
$('#miniClose').addEventListener('click',()=> $('#mini').style.display='none');
$('#btnTpl').addEventListener('click',()=>{
  const rows=[["الاسم","رقم الهوية","التخصص","المرتبة","المسمى"],[""],];
  const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"أسماء");
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'}); saveAs(new Blob([wbout],{type:"application/octet-stream"}),"template_names.xlsx");
});
function getNames(){ return JSON.parse(localStorage.getItem('namesV2')||'[]'); }
function setNames(a){ localStorage.setItem('namesV2',JSON.stringify(a)); }
function refreshNameList(){
  const box=$("#nameList"); box.innerHTML="";
  const names=getNames();
  if(!names.length){ box.textContent="لا توجد بيانات أسماء بعد. استورد ملف Excel."; return; }
  const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fill,minmax(240px,1fr))'; grid.style.gap='8px';
  names.forEach(o=>{
    const card=document.createElement('div'); card.style.border='1px solid var(--border)'; card.style.borderRadius='10px'; card.style.padding='8px'; card.style.cursor='pointer'; card.style.background='#fff';
    card.innerHTML=`<div style="font-weight:900;color:#0c4f47">${o.name}</div><div style="font-size:12px;color:#667;display:flex;gap:6px;flex-wrap:wrap"><span>${o.id||'—'}</span><span>${o.spec||'—'}</span><span>${o.rank||'—'}</span><span>${o.title||'—'}</span></div>`;
    card.onclick=()=>{ $('#tName').value=o.name||''; $('#tId').value=o.id||''; $('#tSpec').value=o.spec||''; $('#tRank').value=o.rank||''; $('#mini').style.display='none'; applyModelStage(); };
    grid.appendChild(card);
  }); box.appendChild(grid);
}
const HEADER_MAP=[
  {keys:['الاسم','Name','Full Name'], prop:'name'},
  {keys:['رقم الهوية','هوية','ID','National ID'], prop:'id'},
  {keys:['التخصص','Specialty','Major'], prop:'spec'},
  {keys:['المرتبة','الرتبة','Rank','Grade'], prop:'rank'},
  {keys:['المسمى','المسمى الوظيفي','Title','Role'], prop:'title'},
];
function findProp(h){ h=(h||'').toString().trim(); for(const m of HEADER_MAP){ if(m.keys.some(k=>new RegExp(`^${k}$`,'i').test(h))) return m.prop; } return null; }
$('#xlsInput').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=await f.arrayBuffer(); const wb=XLSX.read(data,{type:'array'});
    const all=[];
    wb.SheetNames.forEach(name=>{
      const ws=wb.Sheets[name]; const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''}); if(!rows.length) return;
      const head=rows[0]; const idx={}; head.forEach((h,i)=>{ const p=findProp(h); if(p) idx[p]=i; });
      for(let r=1;r<rows.length;r++){
        const row=rows[r]; if(!row.length) continue;
        const o={}; Object.keys(idx).forEach(p=> o[p]=String(row[idx[p]]||'').trim());
        if(o.name){ all.push(o); }
      }
    });
    if(all.length){ const prev=getNames(); const mix=[...prev];
      all.forEach(o=>{ if(!mix.some(x=>x.name===o.name && x.id===o.id)){ mix.push(o); }});
      setNames(mix); refreshNameList();
    } else alert('لم يتم العثور على أعمدة معرّفة للأسماء.');
  }catch(err){ alert('تعذّر قراءة الملف.'); }
  e.target.value='';
});

/* تفاعل عام */
['change','keyup'].forEach(evt=>{
  document.addEventListener(evt,(e)=>{
    if(e.target.matches('.grade,#tName,#tSpec,#tRank,#modelSelect,#stageSelect')) { recalc(); buildInsights(); autoSave(); }
  });
});
</script>
<script>
/* نافذة خطة الفجوة */
const gapModal=document.createElement('div');
gapModal.className='modal'; gapModal.id='gapModal';
gapModal.innerHTML=`
  <div class="panel" id="gapPanel" style="width:900px">
    <div class="close no-print" style="gap:8px">
      <button id="gapPdf"   class="pill primary">🧾 حفظ PDF</button>
      <button id="gapClose" class="pill">✖ إغلاق</button>
    </div>

    <div style="text-align:center;margin-bottom:10px">
      <div style="font-weight:900;color:#0c4f47;font-size:20px">خطة تحسين فجوة الأداء</div>
      <div id="gapHeaderSub" style="color:#5a7a74;font-weight:700"></div>
    </div>

    <section style="border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:10px">
      <table class="table" style="border-radius:0;margin:0;text-align:center">
        <thead><tr><th colspan="4">أولاً: البيانات الأساسية لشاغل الوظيفة التعليمية</th></tr></thead>
        <tbody>
          <tr><td>الاسم</td><td id="g_name">—</td><td>الإدارة</td><td id="g_dir">—</td></tr>
          <tr><td>المسمى الوظيفي</td><td id="g_title">—</td><td>التخصص</td><td id="g_spec">—</td></tr>
          <tr><td>المدير المباشر</td><td id="g_mgr">فهد حامد علي الزهراني</td><td>الفترة</td><td id="g_stage">—</td></tr>
          <tr><td>جهة العمل</td><td id="g_school">—</td><td>العام الدراسي</td><td id="g_year"></td></tr>
        </tbody>
      </table>
    </section>

    <section style="padding:6px 0;text-align:center">
      <div style="display:flex;align-items:center;gap:8px;justify-content:center;margin:6px 0">
        <div style="font-weight:900;color:#0c4f47">ثانيًا: الخطة التحسينية</div>
        <span class="badge-mini">مرتبطة بالنموذج والدرجات الحالية</span>
      </div>

      <div class="stage-inline" style="margin-top:6px">
        <h3 style="margin:0 0 8px">أ- تحديد الفجوة</h3>
        <table class="table" style="border-radius:10px;margin:0">
          <thead><tr><th style="width:50%">المعيار المستهدف تطويره</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead>
          <tbody><tr><td id="g_target">—</td><td id="g_s1"></td><td id="g_s2"></td><td id="g_s3"></td><td id="g_s4"></td><td id="g_s5"></td></tr></tbody>
        </table>
      </div>

      <div class="stage-inline">
        <h3 style="margin:0 0 8px">ب- تحليل مستوى الأداء الحالي</h3>
        <table class="table" style="border-radius:10px;margin:0">
          <thead><tr><th>درجة التمكن</th><th>الأسباب</th><th>نقاط القوة</th><th>الجوانب التي بحاجة للتحسين</th></tr></thead>
        <tbody><tr><td id="g_grade" style="font-weight:900"></td><td contenteditable="true" id="g_reasons"></td><td id="g_strengths"></td><td id="g_gaps"></td></tr></tbody>
        </table>
      </div>

      <div class="stage-inline">
        <h3 style="margin:0 0 8px">ج- خطة العمل لإنجاز التحسين</h3>
        <table class="table" style="border-radius:10px;margin:0">
          <thead><tr><th>م</th><th>الخطة الإجرائية</th><th>متطلبات التنفيذ</th><th>زمن التنفيذ</th><th>الاحتياجات</th><th>المكلف</th><th>المساند</th><th>مؤشر الأداء</th></tr></thead>
          <tbody id="g_actions"></tbody>
        </table>
        <div style="margin-top:6px;font-size:12px;color:#5a7a74">الخلايا قابلة للتحرير قبل الحفظ.</div>
      </div>
    </section>
  </div>`;
document.body.appendChild(gapModal);

/* بناء الخطة */
function buildGapPlan(){
  const name=$('#tName').value||'—';
  const model=$('#modelSelect').selectedOptions[0].textContent;
  const stage=$('#stageSelect').selectedOptions[0].textContent;
  const year=new Date().getFullYear()+' / '+(new Date().getFullYear()+1);

  $('#gapHeaderSub').textContent = `${name} — ${model} — ${stage}`;
  $('#g_name').textContent=name; $('#g_dir').textContent=$('#dirText').textContent;
  $('#g_title').textContent=model; $('#g_spec').textContent=$('#tSpec').value||'—';
  $('#g_stage').textContent=stage; $('#g_school').textContent=$('#schoolText').textContent;
  $('#g_year').textContent=year;

  const rows=$$('#rows tr').map(tr=>({name:tr.querySelector('.item-text').textContent,w:+tr.dataset.w,v:+tr.querySelector('.grade').value}));
  rows.sort((a,b)=> (a.v===b.v? a.w-b.w : a.v-b.v));
  const target=rows[0]||{name:'—',v:3};
  $('#g_target').textContent=target.name;
  ['g_s1','g_s2','g_s3','g_s4','g_s5'].forEach((id,i)=>{ const el=$('#'+id); el.textContent=(i+1)===target.v?'✓':''; el.style.fontWeight='900'; });
  $('#g_grade').textContent = `${target.v} / 5`;
  $('#g_strengths').textContent = ($('#strengthsBox').textContent||'').replace(/^•\s*/,'') || '—';
  $('#g_gaps').textContent      = ($('#improveBox').textContent||'').replace(/^•\s*/,'')   || '—';

  const actions=$('#g_actions'); actions.innerHTML='';
  ['جلسة تغذية راجعة أسبوعية','درس تطبيقي/زيارة زميل','متابعة المؤشرات ورفع تقرير'].forEach((t,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td contenteditable="true">${t} — (${target.name})</td><td contenteditable="true">مواد/منصات</td><td contenteditable="true">أسبوعان</td><td contenteditable="true">تدريب/دعم</td><td contenteditable="true">${name||'المعلم'}</td><td contenteditable="true">المدير/المشرف</td><td contenteditable="true">تحسن الدرجة ≥ 1</td>`;
    actions.appendChild(tr);
  });
}

/* فتح/إغلاق/PDF */
document.getElementById('btnGapPlan').addEventListener('click',()=>{ buildGapPlan(); document.getElementById('gapModal').style.display='flex'; });
document.addEventListener('click',(e)=>{ if(e.target.id==='gapClose'){ document.getElementById('gapModal').style.display='none'; }});
document.addEventListener('click',async(e)=>{
  if(e.target.id!=='gapPdf') return;
  try{
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.getElementById('gapPanel'),{scale:1.3,useCORS:true});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    const props=pdf.getImageProperties(img); const w=210, h=(props.height*w)/props.width;
    pdf.addImage(img,'PNG',0,0,w,h);
    const name=$('#tName').value||'بدون اسم';
    const role=$('#modelSelect').selectedOptions[0].textContent;
    pdf.save(`خطة تحسين فجوة الأداء - ${name} - ${role}.pdf`);
  }catch(e){ alert('تعذّر حفظ PDF'); }
});

/* أزرار الصفحة الرئيسية */
document.getElementById('btnPrint').addEventListener('click',()=> window.print());
document.getElementById('btnPdf').addEventListener('click', async ()=>{
  const hideSel='.no-print,.actions,.mini,.modal';
  const hidden=[...document.querySelectorAll(hideSel)];
  hidden.forEach(el=>{el.dataset._np='1'; el.style.display='none';});
  try{
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.body,{scale:1.2,useCORS:true});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    const props=pdf.getImageProperties(img); const w=210, h=(props.height*w)/props.width;
    pdf.addImage(img,'PNG',0,0,w,h);
    const model=$('#modelSelect').selectedOptions[0].textContent;
    const name=$('#tName').value||'بدون اسم';
    pdf.save(`تقييم الأداء الوظيفي - ${name} - ${model}.pdf`);
  }finally{
    hidden.forEach(el=>{ if(el.dataset._np==='1'){el.style.display=''; delete el.dataset._np;} });
  }
});
document.getElementById('btnSave').addEventListener('click',()=>{ autoSave(); alert('تم الحفظ محليًا.'); });
document.getElementById('btnClear').addEventListener('click',()=>{ $$('.grade').forEach(s=> s.value='3'); recalc(); buildInsights(); autoSave(); });
document.getElementById('btnExport').addEventListener('click',()=>{
  let csv="الاسم,النموذج,المرحلة,العنصر,الوزن,الدرجة,الناتج\n";
  const name=$('#tName').value||'—', model=$('#modelSelect').selectedOptions[0].textContent, stage=$('#stageSelect').selectedOptions[0].textContent;
  $$('#rows tr').forEach(tr=>{
    const item=tr.querySelector('.item-text').textContent, w=+tr.dataset.w, v=+tr.querySelector('.grade').value, s=(v/5)*w;
    csv+=`"${name}","${model}","${stage}","${item}",${w},${v},${s.toFixed(2)}\n`;
  });
  saveAs(new Blob([csv],{type:"text/csv;charset=utf-8"}),`تقرير-التقييم-${name}.csv`);
});
document.getElementById('btnClipboard').addEventListener('click',()=>{
  const name=$('#tName').value||'—', model=$('#modelSelect').selectedOptions[0].textContent, stage=$('#stageSelect').selectedOptions[0].textContent;
  const lines=[`${name} — ${model} — ${stage}`, `المجموع: ${$('#sumScore').textContent}`];
  $$('#rows tr').forEach(tr=>{
    const item=tr.querySelector('.item-text').textContent; const w=+tr.dataset.w; const v=+tr.querySelector('.grade').value; const s=(v/5)*w;
    lines.push(`- ${item}: وزن ${w}%، درجة ${v}/5، ناتج ${s.toFixed(2)}`);
  });
  navigator.clipboard.writeText(lines.join("\n")); alert('تم نسخ الملخص.');
});
</script>
  <div class="footer">تنفيذ وتصميم: فهد حامد الزهراني</div>
</div><!-- /page -->
</body>
</html>
