<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>نموذج تقييم الأداء الوظيفي ١٤٤٧هـ</title>

<!-- خطوط عربية واضحة -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<!-- مكتبات -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --teal:#0f4c46; --ink:#103330; --border:#e5efec; --line:#cfe1dd;
  --muted:#5a7571; --accent:#16a34a; --bg:#ffffff;
  --red:#ef4444; --green:#22c55e;
}
/* أساس */
html,body{
  margin:0!important;padding:0!important;background:#fff;color:var(--ink);
  -webkit-text-size-adjust:100%;
  print-color-adjust: exact; -webkit-print-color-adjust: exact;
  font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  direction:rtl; unicode-bidi:plaintext;
}
*{box-sizing:border-box}
#page{width:min(100%,1080px);min-height:100dvh;margin:0 auto;background:#fff}
.wrap{max-width:100%;margin-inline:auto;padding:8px 12px;display:flex;flex-direction:column;min-height:100%}
#sheet{direction:rtl;unicode-bidi:plaintext}

/* الهيدر (مضغوط) */
header{margin:0 0 6px}
.header-block{display:flex;flex-direction:column;align-items:center;text-align:center;gap:1px;color:var(--teal)}
.header-block .ksa{font-weight:800;font-size:clamp(15px,1.9vw,18px); line-height:1.1}
.header-block .moe{font-weight:800;font-size:clamp(14px,1.8vw,17px); line-height:1.1}
.header-block .dept,.header-block .school{font-weight:700;font-size:clamp(13px,1.7vw,16px); line-height:1.1}
.header-title{margin-top:4px;display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap}
.header-title h1{margin:0;color:var(--teal);font-size:clamp(18px,2.6vw,24px);font-weight:800}
.badge{background:#eaf4f1;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-weight:800;color:#0b2f2c;font-size:12px}

/* أزرار موحّدة */
.icon-btn,.gear-btn{
  width:36px;height:36px;border:1px solid var(--border);border-radius:12px;
  background:#fff;display:inline-flex;align-items:center;justify-content:center;
  cursor:pointer; transition:.15s ease; box-shadow:0 1px 2px rgba(0,0,0,.03)
}
.icon-btn:hover,.gear-btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.08)}
.icon svg{width:18px;height:18px;stroke:var(--teal);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* الشريط العلوي */
.topbar{
  display:grid;gap:6px;align-items:end;margin:6px 0;
  grid-template-columns:auto auto auto 2fr 1fr 1.1fr;
}
#excelInput{display:none}
.ff{display:flex;flex-direction:column;gap:3px}
.ff .label{font-weight:800;color:#0f4c46;font-size:12.5px}
/* اسم المعلم أصغر قليلاً */
.lined{
  height:40px;background:transparent;border:none;outline:none;border-bottom:2px solid #b9d2cd;
  padding:0 8px;font:800 16px/40px "Tajawal";color:#0f2f2b;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;direction:rtl
}
.lined::placeholder{color:#96aaa6;font-weight:600}
.lined:focus{border-bottom-color:#0f7a66}

/* شريط المراحل + الزيارات + أم القرى */
.stage-bar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:6px 0}
.stage-btn,.stage-link{
  height:38px; display:inline-flex; align-items:center; gap:6px;
  border:1px solid var(--border); border-radius:999px; background:#fff; color:#0f4c46;
  padding:0 14px; font-weight:800; font-size:13px; cursor:pointer; text-decoration:none
}
.stage-btn.active{background:#eaf8f4;border-color:var(--accent);color:#0b6e44}
.stage-link{background:#f0fbf7;border-color:#d8ebe6}
.stage-link .icon svg{stroke:#0b6e44}

/* لوحات المراحل (نصائح فقط) */
.stage-panel{overflow:hidden;max-height:0;opacity:0;background:#fbfdfc;border:1px dashed var(--border);border-radius:12px;margin:6px 0;padding:0 8px;transition:max-height .28s ease, opacity .2s ease}
.stage-panel.open{opacity:1;padding:8px 10px;max-height:420px}
.tips{margin:0;background:#f7fbfa;border:1px solid #e6ف0ed;border-radius:10px;padding:8px 10px}
.tips ul{margin:0;padding:0 1.25em;line-height:1.7;font-size:12.7px}
.tips li{margin:2px 0}

/* أهداف المعلم (مركزية) */
.row{display:grid;grid-template-columns:1fr;gap:6px;justify-items:center}
.goal{
  width:min(720px,96%); height:34px; text-align:center;
  border:1px solid #cfe1dd;border-radius:10px;padding:0 10px;font:700 13.5px "Tajawal"
}

/* بطاقة بيانات المعلم */
.idcard{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:flex-start;background:#fbfdfc;border:1px solid var(--border);border-radius:10px;padding:6px 8px;margin:6px 0}
.idchip{background:#f2f7f6;border:1px solid var(--border);border-radius:10px;padding:4px 8px;font-size:12.3px;color:#0f4c46}

/* المؤشر */
.bar-row{display:flex;align-items:center;gap:6px;margin:6px 0 4px}
.chip{background:#f2f7f6;border:1px solid var(--border);padding:5px 8px;border-radius:10px;font-weight:800;color:#09312d;min-width:130px;text-align:center;font-size:12.4px}
.meter{position:relative;height:16px;flex:1;background:#eaf1ef;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.fill{position:absolute;inset:3px;border-radius:10px;background:linear-gradient(90deg,var(--red) 0%,#ff914d 45%,var(--green) 100%)}
.ticks{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none;direction:ltr;padding:0 6px}
.ticks span{width:18px;height:18px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px}
.thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:11px;height:11px;border-radius:50%;background:#fff;border:3px solid #8b5a2b;box-shadow:0 1px 4px rgba(0,0,0,.15)}

/* الجدول (مضغوط) */
table{width:100%;border-collapse:collapse;margin-top:4px}
th,td{background:#fff;border:1px solid var(--line);padding:3.5px 6px;vertical-align:middle}
th{background:var(--teal);color:#fff;text-align:center;font-size:12px;line-height:1.1;padding:4px 6px}
td{font-size:11.8px}
th:first-child,td:first-child{border-radius:8px 0 0 8px}
th:last-child,td:last-child{border-radius:0 8px 8px 0}
.w-tight{width:64px;text-align:center}.w{width:60px;text-align:center}
th .sub{display:block;font-size:9.8px;opacity:.92;margin-top:1px}
select.grade{width:56px;height:24px;text-align:center;border:1px solid #cfe1dd;border-radius:9px;background:#fff;font-size:11.6px}
td.brief{font-size:11.6px;color:#1d3f3b;line-height:1.38}

/* صف الأسماء أسفل الصفحة (صف واحد) */
.names-row{
  margin:8px 0 2px; background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 8px;
  display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap
}
.names-row .cell{display:flex;align-items:center;gap:6px;min-width:240px}
.names-row .label{font-size:12.2px;color:#0f4c46;font-weight:800}
.names-row .value{font-size:13.6px;font-weight:900;color:#0f2f2b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* عنوان المرحلة للطباعة/الحفظ */
.print-stage-title{display:none; margin:6px 0 2px; font-weight:900; color:#0b6e44; background:#f1fbf7; border:1px solid #e5efec; border-radius:10px; padding:6px 10px; font-size:13px}

/* شريط عناوين جميع المراحل عند الحفظ/الطباعة */
.print-all-titles{
  display:none; gap:6px; flex-wrap:wrap; align-items:center; margin:6px 0 4px
}
.print-all-titles .pill{
  display:inline-flex; align-items:center; gap:6px; height:30px; padding:0 12px;
  border-radius:999px; border:1px solid #e5efec; background:#f7fbfa; color:#0f4c46;
  font-weight:800; font-size:12px
}
.print-all-titles .pill.active{background:#eaf8f4;border-color:var(--accent);color:#0b6e44}

/* شريط الأيقونات السفلي (مخفي في الطباعة والحفظ) */
.actions.no-print{
  position:sticky; bottom:6px; z-index:5;
  display:flex;gap:8px;justify-content:center;margin:10px auto 4px;flex-wrap:wrap;
  background:#f7fbfa;border:1px solid #e6f0ed;border-radius:14px;padding:8px 10px;max-width:980px;
  box-shadow:0 6px 22px rgba(0,0,0,.06);
}
.actions .badge-mini{font-size:11.6px;color:#4b6864;margin-inline-end:6px}
.actions .icon-btn{width:36px;height:36px;border-radius:12px}

/* إخفاء الأزرار وقت الالتقاط */
body.capture .no-print{display:none!important}

/* طباعة A4 */
@page{size:A4 portrait; margin:4mm 5mm 5mm 5mm}
@media print{
  #page{width:210mm;min-height:297mm;height:297mm;display:flex}
  .wrap{padding:4mm 5mm;display:flex;flex-direction:column;min-height:100%}
  .no-print{display:none!important}

  /* افتراضيًا: لا تُظهر أي لوحة */
  #stage-planning,#stage-mid,#stage-final{display:none!important}

  /* إذا كنا في وضع إظهار المرحلة: أظهر اللوحة المطابقة فقط */
  body.print-show-stage[data-stage="planning"] #stage-planning,
  body.print-show-stage[data-stage="mid"] #stage-mid,
  body.print-show-stage[data-stage="final"] #stage-final{
    display:block!important;max-height:none!important;opacity:1!important;border-style:solid
  }

  .print-stage-title{display:block}
  .print-all-titles{display:flex}
  table{font-size:10.4px} td.brief{font-size:10.2px;line-height:1.28} th,td{padding:3px 5px}
  .names-row{margin-top:6px}
}

@media (max-width:900px){ .topbar{grid-template-columns:auto auto auto 1fr} }
@media (max-width:680px){ .topbar{grid-template-columns:auto auto 1fr; grid-auto-flow:row} }
</style>
</head>
<body data-stage="planning">
<div id="page">
  <div class="wrap" id="sheet">

    <!-- الهيدر -->
    <header>
      <div class="header-block">
        <div class="ksa">المملكة العربية السعودية</div>
        <div class="moe">وزارة التعليم</div>
        <div class="dept" id="sectorNameDisplay">الإدارة العامة للتعليم بالمنطقة الشرقية</div>
        <div class="school" id="schoolNameDisplay">مدرسة اليعقوبي الثانوية</div>
      </div>
      <div class="header-title">
        <h1>نموذج تقييم الأداء الوظيفي</h1>
        <button class="gear-btn no-print" id="openHeaderEdit" title="تعديل الإدارة/المدرسة">
          <span class="icon">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a2 2 0 1 0 2.9 2.8l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1a2 2 0 0 0-1.8-.3 2 2 0 0 0-1 1.5V21a2 2 0 1 1-4 0v-.1a2 2 0 0 0-1-1.5 2 2 0 0 0-1.8.3l-.1.1A2 2 0 1 1 4.2 18l.1-.1A2 2 0 0 0 4.6 16 2 2 0 0 0 3.1 15H3a2 2 0 1 1 0-4h.1A2 2 0 0 0 4.6 9 2 2 0 0 0 4.3 7.2L4.2 7A2 2 0 1 1 7.1 4.2l.1.1A2 2 0 0 0 9 4.6 2 2 0 0 0 10 3.1V3a2 2 0 1 1 4 0v.1A2 2 0 0 0 15 4.6a2 2 0 0 0 1.8-.3l.1-.1A2 2 0 1 1 19.7 7l-.1.1A2 2 0 0 0 19.4 9a2 2 0 0 0 1.5 1H21a2 2 0 1 1 0 4h-.1a2 2 0 0 0-1.5 1z"/></svg>
          </span>
        </button>
      </div>
    </header>

    <!-- الشريط العلوي -->
    <div class="topbar no-print">
      <!-- استيراد إكسل -->
      <label for="excelInput" class="icon-btn" title="استيراد ملف المعلمين (Excel)">
        <span class="icon">
          <svg viewBox="0 0 24 24"><path d="M12 3v12M7 8l5-5 5 5M4 20h16"/></svg>
        </span>
      </label>
      <input type="file" id="excelInput" accept=".xlsx,.xls,.csv"/>

      <!-- عدسة البحث -->
      <button class="icon-btn" id="openSearch" title="بحث عن معلم">
        <span class="icon">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-3.5-3.5"/></svg>
        </span>
      </button>

      <!-- الحقول -->
      <div class="ff" style="grid-column:4">
        <div class="label">اسم المعلم</div>
        <input id="tName" class="lined" placeholder="اكتب اسم المعلم"/>
      </div>
      <div class="ff" style="grid-column:5">
        <div class="label">رقم الهوية</div>
        <input id="tId" class="lined" inputmode="numeric" placeholder="10 أرقام"/>
      </div>
      <div class="ff" style="grid-column:6">
        <div class="label">التخصص</div>
        <input id="tSpec" class="lined" placeholder="التخصص الدراسي"/>
      </div>
    </div>

    <!-- شريط المراحل + الزيارات الصفية + تاريخ أم القرى -->
    <div class="no-print">
      <div class="stage-bar">
        <button class="stage-btn active" data-stage="planning">مرحلة التخطيط</button>
        <button class="stage-btn" data-stage="mid">المراجعة النصف سنوية</button>
        <button class="stage-btn" data-stage="final">التقييم النهائي</button>

        <a class="stage-link" href="https://fhz545-hub.github.io/teachervisit/" target="_blank" rel="noopener" title="الزيارات الصفية">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg></span>
          الزيارات الصفية
        </a>

        <!-- التاريخ بجوار الزيارات -->
        <span class="badge" id="hijriChip">—</span>
      </div>
    </div>

    <!-- عناوين جميع المراحل (تظهر عند الحفظ/الطباعة) -->
    <div id="allTitles" class="print-all-titles">
      <span class="pill" data-key="planning">مرحلة التخطيط</span>
      <span class="pill" data-key="mid">المراجعة النصف سنوية</span>
      <span class="pill" data-key="final">التقييم النهائي</span>
    </div>

    <!-- عنوان المرحلة (يظهر عند الطباعة/الحفظ فقط) -->
    <div id="stageTitlePrint" class="print-stage-title">—</div>

    <!-- لوحات المراحل -->
    <div id="stage-planning" class="stage-panel">
      <div class="tips">
        <ul>
          <li>يحدد المعلم أهدافه المهنية والتربوية بالتعاون مع قائد المدرسة.</li>
          <li>يحرص أن تكون الأهداف واقعية وذكية (محددة، قابلة للقياس، قابلة للتحقيق، مرتبطة بالوقت).</li>
          <li>يوزّع أهدافه على مجالات متنوعة مثل التحصيل، التقنية، التطوير المهني، والانضباط.</li>
          <li>يوثّق الأهداف في ميثاق الأداء كمرجع للمتابعة طوال العام.</li>
        </ul>
      </div>
      <div class="row" style="margin-top:6px">
        <input class="goal" id="g1" placeholder="هدف 1 — اكتب هدفك هنا">
        <input class="goal" id="g2" placeholder="هدف 2 — اكتب هدفك هنا">
        <input class="goal" id="g3" placeholder="هدف 3 — اكتب هدفك هنا">
        <input class="goal" id="g4" placeholder="هدف 4 — اكتب هدفك هنا">
      </div>
    </div>

    <div id="stage-mid" class="stage-panel">
      <div class="tips">
        <ul>
          <li>يقارن المعلم بين أهدافه وما تحقق فعليًا.</li>
          <li>يعزز نقاط القوة ويضع حلولًا عملية لمجالات التحسين.</li>
          <li>يوثّق شواهده وأدلته لدعم تقييمه.</li>
          <li>يتواصل مع قائد المدرسة لمواءمة خطته وتطوير أهدافه.</li>
        </ul>
      </div>
    </div>

    <div id="stage-final" class="stage-panel">
      <div class="tips">
        <ul>
          <li>يراجع المعلم ما أنجزه مقارنة بأهدافه المعتمدة.</li>
          <li>يبرز شواهده وأدلته لإثبات جهوده.</li>
          <li>يستثمر نقاط قوته في خططه المستقبلية.</li>
          <li>يحدد مجالات التحسين ليخطو نحو تطوير جديد.</li>
          <li>ينظر للتقييم كفرصة للتقدير والتعلّم وبداية لمرحلة أكثر نضجًا.</li>
        </ul>
      </div>
    </div>

    <!-- بطاقة للشاشة -->
    <div class="idcard" id="idcard">
      <span class="idchip">المعلم: <b id="s_name">—</b></span>
      <span class="idchip">الهوية: <b id="s_id">—</b></span>
      <span class="idchip">التخصص: <b id="s_spec">—</b></span>
      <span class="idchip">مرحلة التقييم: <b id="s_stage">التخطيط</b></span>
    </div>

    <!-- المؤشر -->
    <div class="bar-row" id="barRow">
      <div class="chip" id="scoreChip">مؤشر الإنجاز: 0.00 / 5</div>
      <div class="meter">
        <div class="fill"></div>
        <div class="ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
        <div class="thumb" id="thumb" style="left:0%"></div>
      </div>
      <div class="chip" id="percentChip">المجموع: %0</div>
    </div>

    <!-- الجدول -->
    <table id="tbl">
      <thead>
      <tr>
        <th class="w-tight">#</th>
        <th>العنصر</th>
        <th class="w">الوزن</th>
        <th class="w-tight">الدرجة<span class="sub">(1–5)</span></th>
        <th>تفسير / أمثلة مختصرة</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <!-- صف الأسماء أسفل الصفحة -->
    <div class="names-row" id="namesRow">
      <div class="cell">
        <span class="label">اسم المعلم:</span>
        <span class="value" id="footerTeacher">—</span>
      </div>
      <div class="cell">
        <span class="label">اسم مدير المدرسة:</span>
        <span class="value" id="footerPrincipal">فهد حامد الزهراني</span>
        <button class="icon-btn no-print" id="editPrincipalBtn" title="تعديل اسم المدير" style="width:30px;height:28px;border-radius:8px">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 20v-6M6 8V4h12v4"/></svg></span>
        </button>
      </div>
    </div>

    <!-- شريط الأيقونات السفلي -->
    <div class="actions no-print">
      <span class="badge-mini">وضع الطباعة:</span>
      <select id="printMode" style="height:34px;line-height:34px;border:1px solid #cfe1dd;border-radius:12px;padding:0 10px;font-weight:800">
        <option value="color" selected>ملون</option>
        <option value="bw">أبيض وأسود</option>
      </select>

      <button class="icon-btn" id="printBtn" title="طباعة A4">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M6 9V3h12v6"/><path d="M6 13h12v8H6z"/><path d="M4 9h16a2 2 0 0 1 2 2v2H2v-2a2 2 0 0 1 2-2z"/></svg></span>
      </button>
      <button class="icon-btn" id="saveBtn" title="حفظ PDF">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 3v12"/><path d="M7 8l5 5 5-5"/><path d="M4 21h16"/></svg></span>
      </button>
      <button class="icon-btn" id="saveTeacherBtn" title="حفظ بيانات المعلم">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="M8 7V4h8v3"/><path d="M12 11v6"/></svg></span>
      </button>
      <button class="icon-btn" id="clearOneBtn" title="مسح بيانات هذا المعلم">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 14h10l1-14"/></svg></span>
      </button>
      <button class="icon-btn" id="exportExcelBtn" title="تنزيل قائمة المعلمين (Excel)">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 17h16v3H4z"/><path d="M12 4v11"/></svg></span>
      </button>
      <button class="icon-btn" id="clearTeachersBtn" title="مسح بيانات المعلمين">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 14"/></svg></span>
      </button>
      <button class="icon-btn" id="importTemplateBtn" title="تحميل قالب Excel">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 5v14"/><path d="M18 13l-6 6-6-6"/></svg></span>
      </button>
    </div>

    <div class="footer" style="text-align:center;font-size:10.6px;color:#6a8682;margin:4px 0 2px">
      © مبادرة مدرسة اليعقوبي الثانوية بالخبر — تصميم وتنفيذ: فهد حامد الزهراني
    </div>

  </div>
</div>

<!-- نافذة تعديل الرأس -->
<div id="editModal" class="no-print" style="display:none;position:fixed;inset:0;z-index:100;align-items:center;justify-content:center">
  <div style="position:absolute;inset:0;background:rgba(0,0,0,.25)"></div>
  <div style="position:relative;background:#fff;border:1px solid #dbe8e5;border-radius:12px;min-width:320px;max-width:92vw;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101">
    <h3 style="margin:0 0 8px;font-size:14px;color:#0f4c46">تعديل بيانات الرأس</h3>
    <div style="display:grid;gap:6px">
      <input id="editSector" class="lined" style="height:34px;line-height:34px" placeholder="الإدارة/القطاع"/>
      <input id="editSchool" class="lined" style="height:34px;line-height:34px" placeholder="اسم المدرسة"/>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:8px">
      <button id="mClose" class="gear-btn" title="إغلاق"><span class="icon"><svg viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></span></button>
      <button id="mSave" class="gear-btn" title="حفظ" style="border-color:#0f7a66;background:#0f7a66">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="M8 7V4h8v3"/><path d="M12 11ف6"/></svg></span>
      </button>
    </div>
  </div>
</div>

<!-- نافذة البحث -->
<div id="searchModal" class="no-print" style="display:none;position:fixed;inset:0;z-index:110;align-items:center;justify-content:center">
  <div style="position:absolute;inset:0;background:rgba(0,0,0,.25)"></div>
  <div style="position:relative;background:#fff;border:1px solid #dbe8e5;border-radius:12px;min-width:340px;max-width:min(92vw,520px);padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:111">
    <h3 style="margin:0 0 8px;font-size:14px;color:#0f4c46">بحث عن معلم</h3>
    <input id="searchBox" class="lined" style="height:36px;line-height:36px" placeholder="اكتب جزءًا من الاسم أو الهوية"/>
    <div id="results" style="max-height:48vh;overflow:auto;margin-top:8px;border:1px solid #e9f2ef;border-radius:10px;padding:6px"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button id="sClose" class="gear-btn" title="إغلاق"><span class="icon"><svg viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></span></button>
    </div>
  </div>
</div>

<script>
/* أدوات مساعدة */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const collapse=s=>String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
const digits=s=>String(s||'').replace(/\D+/g,'');

/* التاريخ الهجري (أم القرى) */
function hijriUmmAlQura(){
  let txt='—';
  try{txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date())}
  catch(e){try{txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date())}catch{txt=new Date().toLocaleDateString('ar-SA')}}
  $('#hijriChip').textContent='التاريخ الهجري: '+txt+' هـ';
  return txt+' هـ';
}
const hijriToday=hijriUmmAlQura();

/* إعدادات الرأس + المدير */
const LS_SETTINGS='yaqubi_settings_best';
(function(){
  const s=localStorage.getItem(LS_SETTINGS); if(!s) return;
  try{const o=JSON.parse(s);
    if(o.sector) $('#sectorNameDisplay').textContent=o.sector;
    if(o.school) $('#schoolNameDisplay').textContent=o.school;
    if(o.principal) $('#footerPrincipal').textContent=o.principal;
  }catch{}
})();
$('#openHeaderEdit').addEventListener('click',()=>{
  $('#editModal').style.display='flex';
  $('#editSector').value=$('#sectorNameDisplay').textContent.trim();
  $('#editSchool').value=$('#schoolNameDisplay').textContent.trim();
});
$('#mClose').addEventListener('click',()=>$('#editModal').style.display='none');
$('#mSave').addEventListener('click',()=>{
  const sector=collapse($('#editSector').value)||'الإدارة العامة للتعليم بالمنطقة الشرقية';
  const school=collapse($('#editSchool').value)||'مدرسة اليعقوبي الثانوية';
  $('#sectorNameDisplay').textContent=sector; $('#schoolNameDisplay').textContent=school;
  const saved=localStorage.getItem(LS_SETTINGS); let o={};
  try{o=saved?JSON.parse(saved):{}}catch{ o={}; }
  o.sector=sector; o.school=school;
  localStorage.setItem(LS_SETTINGS,JSON.stringify(o));
  $('#editModal').style.display='none';
});
document.getElementById('editPrincipalBtn').addEventListener('click',()=>{
  const curr=$('#footerPrincipal').textContent.trim();
  const v=prompt('اسم مدير المدرسة:',curr||''); if(v===null) return;
  const name=collapse(v)||'—';
  $('#footerPrincipal').textContent=name;
  const saved=localStorage.getItem(LS_SETTINGS); let o={};
  try{o=saved?JSON.parse(saved):{}}catch{ o={}; }
  o.principal=name; localStorage.setItem(LS_SETTINGS,JSON.stringify(o));
});

/* وضع الطباعة */
const LS_PRINT='yaqubi_print_mode';
const printSel=$('#printMode');
function applyPrintMode(m){ if(m==='bw') document.body.classList.add('bw-print'); else document.body.classList.remove('bw-print'); }
if(printSel){
  const m=localStorage.getItem(LS_PRINT)||'color'; printSel.value=m; applyPrintMode(m);
  printSel.addEventListener('change',()=>{ localStorage.setItem(LS_PRINT,printSel.value); applyPrintMode(printSel.value); });
}

/* عناصر التقييم */
const items=[
  {name:"أداء الواجبات الوظيفية",weight:10,brief:"انضباط يومي؛ التزام بالمواعيد؛ تحضير وتتبع؛ تسليم التقارير."},
  {name:"التفاعل مع المجتمع المهني",weight:10,brief:"مجتمعات تعلم؛ تبادل زيارات؛ حضور دورات؛ مشاركة موارد."},
  {name:"التفاعل مع أولياء الأمور",weight:10,brief:"قنوات منضبطة؛ رسائل موجزة؛ متابعة بنّاءة."},
  {name:"التنوع في استراتيجيات التدريس",weight:10,brief:"تعلم نشط؛ مراعاة الفروق؛ أسئلة عليا؛ تعلّم تعاوني."},
  {name:"تحسين نتائج المتعلمين",weight:10,brief:"قياس قبلي/بعدي؛ خطط علاج؛ متابعة التقدم."},
  {name:"إعداد وتنفيذ خطة التعلم",weight:10,brief:"توزيع منهج؛ تحضير علمي؛ تقويم بنائي؛ التزام بالزمن."},
  {name:"توظيف التقنيات والوسائل",weight:10,brief:"منصات؛ موارد تفاعلية؛ مصادر متعددة؛ محتوى منظم."},
  {name:"تهيئة البيئة التعليمية",weight:5, brief:"تهيئة نفسية؛ تنظيم المقاعد؛ لوحات صفية."},
  {name:"الإدارة الصفية",weight:5,  brief:"قواعد واضحة؛ إدارة وقت؛ انتقالات سلسة؛ متابعة الغياب."},
  {name:"تحليل نتائج المتعلمين",weight:10,brief:"تحليل بنود؛ تحديد القوة والضعف؛ تقارير مختصرة."},
  {name:"تنوع أساليب التقويم",weight:10,brief:"اختبارات متنوعة؛ مهام أداء؛ ملفات إنجاز."},
];
(function buildTable(){
  const tb=$('#rows');
  items.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="w-tight" style="text-align:center">${i+1}</td>
      <td>${it.name}</td>
      <td class="w"><b>${it.weight}%</b></td>
      <td class="w-tight">
        <select class="grade">
          <option value="5">5</option><option value="4">4</option>
          <option value="3" selected>3</option><option value="2">2</option><option value="1">1</option>
        </select>
      </td>
      <td class="brief">${it.brief}</td>`;
    tb.appendChild(tr);
  });
})();

/* المؤشر */
const chipScore=$('#scoreChip'), chipPct=$('#percentChip'), thumb=$('#thumb');
function recalc(){
  let weighted=0, per=0;
  $$('.grade').forEach((sel,i)=>{ const g=Number(sel.value); const w=items[i].weight; weighted+=g*w; per+=(g/5)*w; });
  const avg=weighted/100, pct=Math.round(per);
  chipScore.textContent=`مؤشر الإنجاز: ${avg.toFixed(2)} / 5`;
  chipPct.textContent=`المجموع: %${pct}`;
  thumb.style.left=`${((avg-1)/4)*100}%`;
  return {avg,pct};
}
$$('.grade').forEach(el=>el.addEventListener('change',recalc)); recalc();

/* بيانات المعلم */
function vName(){return collapse($('#tName').value)} function vId(){return digits($('#tId').value)} function vSpec(){return collapse($('#tSpec').value)}
function updateSummary(){
  const n=vName()||'—', i=vId()||'—', sp=vSpec()||'—';
  $('#s_name').textContent=n; $('#s_id').textContent=i; $('#s_spec').textContent=sp;
  $('#footerTeacher').textContent=n;
}
['#tName','#tId','#tSpec'].forEach(sel=>$(sel).addEventListener('input',updateSummary));
updateSummary();

/* تبديل المراحل (فتح/غلق + ضبط data-stage) */
const stageBtns=$$('.stage-btn');
const panels={ planning:$('#stage-planning'), mid:$('#stage-mid'), final:$('#stage-final') };
let currentStage='planning', isOpen=true;
function setStage(key, toggle=false){
  if(toggle && currentStage===key){ isOpen=!isOpen; } else { currentStage=key; isOpen=true; }
  document.body.setAttribute('data-stage', currentStage);
  stageBtns.forEach(b=>b.classList.toggle('active', b.dataset.stage===currentStage));
  Object.values(panels).forEach(p=>{p.classList.remove('open'); p.style.maxHeight='0px';});
  if(isOpen){ const p=panels[currentStage]; p.classList.add('open'); p.style.maxHeight=p.scrollHeight+'px'; }
  $('#s_stage').textContent= key==='planning'?'التخطيط': key==='mid'?'المراجعة النصف سنوية':'التقييم النهائي';
  const isPlanning=(currentStage==='planning');
  $$('.grade').forEach(s=>s.disabled=isPlanning);
  $('#barRow').style.opacity=(isPlanning?0.45:1);
  if(!isOpen){ chipScore.textContent='—'; chipPct.textContent='—'; } else if(!isPlanning) recalc(); else {chipScore.textContent='وضع التخطيط: المؤشر غير مُفعّل'; chipPct.textContent='—';}
}
stageBtns.forEach(b=>b.addEventListener('click',()=>setStage(b.dataset.stage,true)));
setStage('planning');

/* عنوان المرحلة + شريط كل العناوين */
function stageTitleText(){
  const map={planning:'مرحلة التخطيط — بداية العام', mid:'مرحلة المراجعة النصف سنوية', final:'مرحلة التقييم النهائي — نهاية العام'};
  return map[currentStage]||'—';
}
function setPrintStageTitle(){
  const el=$('#stageTitlePrint');
  if(isOpen){ el.textContent='عنوان المرحلة: '+stageTitleText(); }
  else{ el.textContent='عرض مختصر: العناوين والجدول وبيانات الأسماء'; }
}
function highlightAllTitles(){
  $$('#allTitles .pill').forEach(p=>p.classList.toggle('active', p.dataset.key===currentStage && isOpen));
}

/* تحقق/طباعة/حفظ PDF — تُظهر المرحلة الحالية فقط عند فتحها، مع إظهار عناوين جميع المراحل */
function validate(){
  if(!vName()){ alert('رجاءً اكتب اسم المعلم.'); $('#tName').focus(); return false; }
  if(!/^\d{10}$/.test(vId())){ alert('رجاءً أدخل رقم هوية صحيحًا (10 أرقام).'); $('#tId').focus(); return false; }
  if(!vSpec()){ alert('رجاءً اكتب التخصص.'); $('#tSpec').focus(); return false; }
  if(currentStage==='planning' && isOpen){
    const g=[collapse($('#g1').value),collapse($('#g2').value),collapse($('#g3').value),collapse($('#g4').value)];
    if(g.some(x=>!x)){ alert('يرجى إدخال الأهداف الأربعة في مرحلة التخطيط.'); return false; }
  }
  return true;
}
function ensureCurrentOpenIfNeeded(){
  if(!isOpen) return ()=>{}; // مختصر
  const panel=panels[currentStage];
  const wasOpen=panel.classList.contains('open');
  if(!wasOpen){ panel.classList.add('open'); panel.style.maxHeight=panel.scrollHeight+'px'; }
  return ()=>{ if(!wasOpen){ panel.classList.remove('open'); panel.style.maxHeight='0px'; } };
}
function fitForA4(){
  const page=$('#page'), sheet=$('#sheet');
  const prev={minH:page.style.minHeight,h:page.style.height,w:page.style.width,disp:page.style.display,tf:sheet.style.transform,tfOrigin:sheet.style.transformOrigin};
  page.style.minHeight='297mm'; page.style.height='297mm'; page.style.width='210mm'; page.style.display='block';
  const mm=3.78, innerH=(297-10)*mm, innerW=(210-10)*mm;
  const H=sheet.scrollHeight, W=sheet.scrollWidth;
  const sc=Math.min(1,(innerH/H)*0.998,(innerW/W)*0.998);
  sheet.style.transformOrigin='top right';
  sheet.style.transform=`scale(${sc})`;
  return ()=>{ page.style.minHeight=prev.minH; page.style.height=prev.h; page.style.width=prev.w; page.style.display=prev.disp; sheet.style.transform=prev.tf; sheet.style.transformOrigin=prev.tfOrigin; };
}
function startCapture(){ document.body.classList.add('capture'); $('#allTitles').style.display='flex'; setPrintStageTitle(); highlightAllTitles(); }
function endCapture(){ document.body.classList.remove('capture'); $('#allTitles').style.display='none'; }

document.getElementById('printBtn').addEventListener('click',()=>{
  if(!validate()) return;
  if(isOpen) document.body.classList.add('print-show-stage'); else document.body.classList.remove('print-show-stage');
  const undoOpen=ensureCurrentOpenIfNeeded();
  const undoFit=fitForA4();
  startCapture();
  setTimeout(()=>window.print(),60);
  setTimeout(()=>{ endCapture(); undoFit(); undoOpen(); document.body.classList.remove('print-show-stage'); },900);
});

document.getElementById('saveBtn').addEventListener('click',async()=>{
  if(!validate()) return;
  if(isOpen) document.body.classList.add('print-show-stage'); else document.body.classList.remove('print-show-stage');
  const undoOpen=ensureCurrentOpenIfNeeded();
  startCapture();
  try{
    const page=$('#page');
    const prev={minH:page.style.minHeight,h:page.style.height,w:page.style.width,disp:page.style.display};
    page.style.minHeight='297mm'; page.style.height='297mm'; page.style.width='210mm'; page.style.display='block';
    const canvas=await html2canvas(page,{useCORS:true,scale:2,background:'#ffffff',scrollX:0,scrollY:0,windowWidth:page.scrollWidth,windowHeight:page.scrollHeight});
    const img=canvas.toDataURL('image/png',1.0);
    const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
    const margin=5, pdfW=210-2*margin, pdfH=297-2*margin;
    const imgW=canvas.width*0.264583, imgH=canvas.height*0.264583;
    const r=Math.min(pdfW/imgW,pdfH/imgH); const w=imgW*r, h=imgH*r; const x=margin+(pdfW-w)/2, y=margin+(pdfH-h)/2;
    const fileName=`تقييم الأداء الوظيفي - ${vName()||'غير مسمى'} - ${(isOpen?$('#s_stage').textContent:'مختصر')} - ${hijriToday}.pdf`;
    pdf.addImage(img,'PNG',x,y,w,h,'','FAST'); pdf.save(fileName);
    page.style.minHeight=prev.minH; page.style.height=prev.h; page.style.width=prev.w; page.style.display=prev.disp;
  }catch(err){ alert('تعذّر الحفظ PDF.'); console.error(err); }
  finally{ endCapture(); undoOpen(); document.body.classList.remove('print-show-stage'); }
});

/* قائمة المعلّمين (حفظ/تحميل/بحث/استيراد/تصدير) */
const LS_TEACHERS='yaqubi_teachers_best';
let teachers=[]; 
function saveTeachers(){localStorage.setItem(LS_TEACHERS,JSON.stringify(teachers));}
function loadTeachers(){const raw=localStorage.getItem(LS_TEACHERS); teachers=raw?(JSON.parse(raw)||[]):[];}
function applyTeacher(t){
  $('#tName').value=t.name||''; $('#tId').value=t.id||''; $('#tSpec').value=t.spec||'';
  ['g1','g2','g3','g4'].forEach((id,i)=>{const el=$('#'+id); if(el) el.value=(t.goals||[])[i]||'';});
  if(t.grades) $$('.grade').forEach((sel,i)=> sel.value=t.grades[i]||sel.value);
  updateSummary(); recalc();
}
function upsertTeacher(){
  const t={name:vName(),id:vId(),spec:vSpec(),goals:['g1','g2','g3','g4'].map(id=>collapse($('#'+id)?.value||'')),grades:$$('.grade').map(s=>Number(s.value))};
  if(!t.name){alert('أدخل الاسم قبل الحفظ');return;}
  let i=teachers.findIndex(x=>x.id && t.id && x.id===t.id); if(i<0) i=teachers.findIndex(x=>x.name===t.name);
  if(i>=0) teachers[i]=t; else teachers.push(t); saveTeachers(); alert('تم حفظ بيانات المعلم.');
}
document.getElementById('saveTeacherBtn').addEventListener('click',()=>{ if(validate()) upsertTeacher(); });
document.getElementById('clearOneBtn').addEventListener('click',()=>{
  const id=vId(), name=vName(); if(!id && !name){alert('أدخل الاسم أو الهوية أولًا');return;}
  if(!confirm('سيتم مسح بيانات هذا المعلم. متابعة؟'))return;
  const before=teachers.length;
  teachers=teachers.filter(x=> !((id&&x.id===id)||(!id&&name&&x.name===name)) );
  saveTeachers(); alert(before!==teachers.length?'تم المسح.':'لم يتم العثور على سجل.');
});
document.getElementById('excelInput').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const data=await file.arrayBuffer(); const wb=XLSX.read(data); const sh=wb.Sheets[wb.SheetNames[0]];
    const raw=XLSX.utils.sheet_to_json(sh,{header:1,defval:''}); if(!raw.length){alert('الملف فارغ');return;}
    const norm=h=>{h=String(h).trim().toLowerCase(); const map={'name':'name','الاسم':'name','fullname':'name','id':'id','الهوية':'id','رقم الهوية':'id','specialization':'spec','التخصص':'spec'}; return map[h]||h;}
    const headers=raw[0].map(norm), rows=raw.slice(1); const arr=[];
    rows.forEach(r=>{
      if(r.every(c=>String(c).trim()==='')) return;
      const o={name:'',id:'',spec:''}; r.forEach((c,i)=>{const k=headers[i]; if(!k) return;
        if(k.includes('name')) o.name=collapse(c);
        else if(k.includes('id')) o.id=digits(c);
        else if(k.includes('spec')) o.spec=collapse(c);
      });
      if(!o.name && r[0]) o.name=collapse(r[0]); if(!o.id && r[1]) o.id=digits(r[1]); if(!o.spec && r[2]) o.spec=collapse(r[2]);
      if(o.name) arr.push(o);
    });
    if(!arr.length){alert('لم يتم العثور على أعمدة مناسبة (الاسم/الهوية/التخصص)');return;}
    teachers=arr; saveTeachers(); alert('تم الاستيراد بنجاح.');
  }catch(err){console.error(err); alert('فشل استيراد الملف.');}
  finally{ e.target.value=''; }
});
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  if(!teachers.length){alert('لا توجد بيانات للتصدير');return;}
  const header=['الاسم','الهوية','التخصص'], data=teachers.map(t=>[t.name,t.id,t.spec]);
  const ws=XLSX.utils.aoa_to_sheet([header,...data]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'المعلمون');
  const out=XLSX.write(wb,{bookType:'xlsx',type:'array'}); saveAs(new Blob([out],{type:'application/octet-stream'}),'قائمة_المعلمين.xlsx');
});
document.getElementById('importTemplateBtn').addEventListener('click', ()=>{
  const header=['الاسم','الهوية','التخصص']; const ws=XLSX.utils.aoa_to_sheet([header,['مثال: محمد علي','1010101010','رياضيات']]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'قالب_المعلمين');
  const out=XLSX.write(wb,{bookType:'xlsx',type:'array'}); saveAs(new Blob([out],{type:'application/octet-stream'}),'قالب_المعلمين.xlsx');
});
document.getElementById('clearTeachersBtn').addEventListener('click',()=>{ if(confirm('مسح جميع بيانات المعلمين؟')){ localStorage.removeItem(LS_TEACHERS); teachers=[]; }});

/* نافذة البحث */
function renderResults(q=''){
  const box=$('#results'); box.innerHTML='';
  if(!teachers.length){ box.innerHTML='<div style="padding:8px;color:#6a8682">لا توجد بيانات محفوظة.</div>'; return;}
  const qq=collapse(q).toLowerCase();
  const list=teachers.filter(t=>{
    const nm=(t.name||'').toLowerCase(), id=(t.id||'').toLowerCase(), sp=(t.spec||'').toLowerCase();
    return !qq || nm.includes(qq) || id.includes(qq) || sp.includes(qq);
  });
  if(!list.length){ box.innerHTML='<div style="padding:8px;color:#6a8682">لا نتائج مطابقة.</div>'; return;}
  list.forEach(t=>{
    const row=document.createElement('button');
    row.type='button';
    row.style.cssText='width:100%;text-align:inherit;padding:8px;border:1px solid #e9f2ef;border-radius:10px;margin:4px 0;background:#fff;cursor:pointer';
    row.innerHTML=`<div style="font-weight:900;color:#0f2f2b">${t.name||'—'}</div>
                   <div style="font-size:12px;color:#5a7571">الهوية: ${t.id||'—'} • التخصص: ${t.spec||'—'}</div>`;
    row.addEventListener('click',()=>{ applyTeacher(t); $('#searchModal').style.display='none'; });
    box.appendChild(row);
  });
}
document.getElementById('openSearch').addEventListener('click',()=>{
  $('#searchModal').style.display='flex';
  const sb=$('#searchBox'); sb.value=''; renderResults(''); setTimeout(()=>sb.focus(),60);
});
document.getElementById('sClose').addEventListener('click',()=>$('#searchModal').style.display='none');
$('#searchModal').addEventListener('click',e=>{ if(e.target===e.currentTarget) $('#searchModal').style.display='none'; });
$('#searchBox').addEventListener('input',e=>renderResults(e.target.value));

/* تهيئة قائمة المعلّمين */
(function loadInit(){
  const raw=localStorage.getItem(LS_TEACHERS);
  teachers=raw?(JSON.parse(raw)||[]):[];
})();
</script>
</body>
</html>
