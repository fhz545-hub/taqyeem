<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù¡Ù¤Ù¤Ù§Ù‡Ù€</title>

<!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø© -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --teal:#0f4c46; --ink:#103330; --border:#e5efec; --line:#cfe1dd;
  --muted:#5a7571; --accent:#16a34a; --bg:#ffffff;
  --red:#ef4444; --green:#22c55e;
}
/* Ø£Ø³Ø§Ø³ */
html,body{
  margin:0!important;padding:0!important;background:#fff;color:var(--ink);
  -webkit-text-size-adjust:100%;
  print-color-adjust: exact; -webkit-print-color-adjust: exact;
  font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  text-rendering:optimizeLegibility; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  direction:rtl; unicode-bidi:plaintext;
}
*{box-sizing:border-box}
#page{width:min(100%,1080px);min-height:100dvh;margin:0 auto;background:#fff}
.wrap{max-width:100%;margin-inline:auto;padding:8px 12px;display:flex;flex-direction:column;min-height:100%}
#sheet{direction:rtl;unicode-bidi:plaintext}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…Ø¶ØºÙˆØ·) */
header{margin:0 0 6px}
.header-block{display:flex;flex-direction:column;align-items:center;text-align:center;gap:1px;color:var(--teal)}
.header-block .ksa{font-weight:800;font-size:clamp(15px,1.9vw,18px); line-height:1.1}
.header-block .moe{font-weight:800;font-size:clamp(14px,1.8vw,17px); line-height:1.1}
.header-block .dept,.header-block .school{font-weight:700;font-size:clamp(13px,1.7vw,16px); line-height:1.1}
.header-title{margin-top:4px;display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap}
.header-title h1{margin:0;color:var(--teal);font-size:clamp(18px,2.6vw,24px);font-weight:800}
.badge{background:#eaf4f1;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-weight:800;color:#0b2f2c;font-size:12px}

/* Ø£Ø²Ø±Ø§Ø± Ù…ÙˆØ­Ù‘Ø¯Ø© */
.icon-btn,.gear-btn{
  width:36px;height:36px;border:1px solid var(--border);border-radius:12px;
  background:#fff;display:inline-flex;align-items:center;justify-content:center;
  cursor:pointer; transition:.15s ease; box-shadow:0 1px 2px rgba(0,0,0,.03)
}
.icon-btn:hover,.gear-btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.08)}
.icon svg{width:18px;height:18px;stroke:var(--teal);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
.topbar{
  display:grid;gap:6px;align-items:end;margin:6px 0;
  grid-template-columns:auto auto auto 2fr 1fr 1.1fr;
}
#excelInput{display:none}
.ff{display:flex;flex-direction:column;gap:3px}
.ff .label{font-weight:800;color:#0f4c46;font-size:12.5px}
/* Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£ØµØºØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
.lined{
  height:40px;background:transparent;border:none;outline:none;border-bottom:2px solid #b9d2cd;
  padding:0 8px;font:800 16px/40px "Tajawal";color:#0f2f2b;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;direction:rtl
}
.lined::placeholder{color:#96aaa6;font-weight:600}
.lined:focus{border-bottom-color:#0f7a66}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø±Ø§Ø­Ù„ + Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª + Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ */
.stage-bar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:6px 0}
.stage-btn,.stage-link{
  height:38px; display:inline-flex; align-items:center; gap:6px;
  border:1px solid var(--border); border-radius:999px; background:#fff; color:#0f4c46;
  padding:0 14px; font-weight:800; font-size:13px; cursor:pointer; text-decoration:none
}
.stage-btn.active{background:#eaf8f4;border-color:var(--accent);color:#0b6e44}
.stage-link{background:#f0fbf7;border-color:#d8ebe6}
.stage-link .icon svg{stroke:#0b6e44}

/* Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Ù†ØµØ§Ø¦Ø­ ÙÙ‚Ø·) */
.stage-panel{overflow:hidden;max-height:0;opacity:0;background:#fbfdfc;border:1px dashed var(--border);border-radius:12px;margin:6px 0;padding:0 8px;transition:max-height .28s ease, opacity .2s ease}
.stage-panel.open{opacity:1;padding:8px 10px;max-height:420px}
.tips{margin:0;background:#f7fbfa;border:1px solid #e6f0ed;border-radius:10px;padding:8px 10px}
.tips ul{margin:0;padding:0 1.25em;line-height:1.7;font-size:12.7px}
.tips li{margin:2px 0}

/* Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø¹Ù„Ù… (Ù…Ø±ÙƒØ²ÙŠØ©) */
.row{display:grid;grid-template-columns:1fr;gap:6px;justify-items:center}
.goal{
  width:min(720px,96%); height:34px; text-align:center;
  border:1px solid #cfe1dd;border-radius:10px;padding:0 10px;font:700 13.5px "Tajawal"
}

/* Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… */
.idcard{display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:flex-start;background:#fbfdfc;border:1px solid var(--border);border-radius:10px;padding:6px 8px;margin:6px 0}
.idchip{background:#f2f7f6;border:1px solid var(--border);border-radius:10px;padding:4px 8px;font-size:12.3px;color:#0f4c46}

/* Ø§Ù„Ù…Ø¤Ø´Ø± */
.bar-row{display:flex;align-items:center;gap:6px;margin:6px 0 4px}
.chip{background:#f2f7f6;border:1px solid var(--border);padding:5px 8px;border-radius:10px;font-weight:800;color:#09312d;min-width:130px;text-align:center;font-size:12.4px}
.meter{position:relative;height:16px;flex:1;background:#eaf1ef;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.fill{position:absolute;inset:3px;border-radius:10px;background:linear-gradient(90deg,var(--red) 0%,#ff914d 45%,var(--green) 100%)}
.ticks{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none;direction:ltr;padding:0 6px}
.ticks span{width:18px;height:18px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px}
.thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:11px;height:11px;border-radius:50%;background:#fff;border:3px solid #8b5a2b;box-shadow:0 1px 4px rgba(0,0,0,.15)}

/* Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ø¶ØºÙˆØ·) */
table{width:100%;border-collapse:collapse;margin-top:4px}
th,td{background:#fff;border:1px solid var(--line);padding:3.5px 6px;vertical-align:middle}
th{background:var(--teal);color:#fff;text-align:center;font-size:12px;line-height:1.1;padding:4px 6px}
td{font-size:11.8px}
th:first-child,td:first-child{border-radius:8px 0 0 8px}
th:last-child,td:last-child{border-radius:0 8px 8px 0}
.w-tight{width:64px;text-align:center}.w{width:60px;text-align:center}
th .sub{display:block;font-size:9.8px;opacity:.92;margin-top:1px}
select.grade{width:56px;height:24px;text-align:center;border:1px solid #cfe1dd;border-radius:9px;background:#fff;font-size:11.6px}
td.brief{font-size:11.6px;color:#1d3f3b;line-height:1.38}

/* Ø§Ù„Ù‚ÙˆØ©/Ø§Ù„ØªØ·ÙˆÙŠØ± */
.cards{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px 10px;min-height:50px}
.card h3{margin:0 0 4px;font-size:13.2px}
#strength h3{color:#136b3e} #dev h3{color:#b4372d}
#strengthBody,#devBody{font-family:"Cairo",Tahoma,sans-serif;font-size:12.1px;line-height:1.45}

/* ØµÙ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© (ØµÙ ÙˆØ§Ø­Ø¯) */
.names-row{
  margin:8px 0 2px; background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 8px;
  display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap
}
.names-row .cell{display:flex;align-items:center;gap:6px;min-width:240px}
.names-row .label{font-size:12.2px;color:#0f4c46;font-weight:800}
.names-row .value{font-size:13.6px;font-weight:900;color:#0f2f2b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ */
.print-stage-title{display:none; margin:6px 0 2px; font-weight:900; color:#0b6e44; background:#f1fbf7; border:1px solid #e5efec; border-radius:10px; padding:6px 10px; font-size:13px}

/* Ø´Ø±ÙŠØ· Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸/Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
.print-all-titles{
  display:none; gap:6px; flex-wrap:wrap; align-items:center; margin:6px 0 4px
}
.print-all-titles .pill{
  display:inline-flex; align-items:center; gap:6px; height:30px; padding:0 12px;
  border-radius:999px; border:1px solid #e5efec; background:#f7fbfa; color:#0f4c46;
  font-weight:800; font-size:12px
}
.print-all-titles .pill.active{background:#eaf8f4;border-color:var(--accent);color:#0b6e44}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ (Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸) */
.actions.no-print{
  position:sticky; bottom:6px; z-index:5;
  display:flex;gap:8px;justify-content:center;margin:10px auto 4px;flex-wrap:wrap;
  background:#f7fbfa;border:1px solid #e6f0ed;border-radius:14px;padding:8px 10px;max-width:980px;
  box-shadow:0 6px 22px rgba(0,0,0,.06);
}
.actions .badge-mini{font-size:11.6px;color:#4b6864;margin-inline-end:6px}
.actions .icon-btn{width:36px;height:36px;border-radius:12px}

/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙ‚Øª Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· */
body.capture .no-print{display:none!important}

/* Ø·Ø¨Ø§Ø¹Ø© A4 */
@page{size:A4 portrait; margin:4mm 5mm 5mm 5mm}
@media print{
  #page{width:210mm;min-height:297mm;height:297mm;display:flex}
  .wrap{padding:4mm 5mm;display:flex;flex-direction:column;min-height:100%}
  .no-print{display:none!important}

  /* Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§: Ù„Ø§ ØªÙØ¸Ù‡Ø± Ø£ÙŠ Ù„ÙˆØ­Ø© */
  #stage-planning,#stage-mid,#stage-final{display:none!important}

  /* Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø©: Ø£Ø¸Ù‡Ø± Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙ‚Ø· */
  body.print-show-stage[data-stage="planning"] #stage-planning,
  body.print-show-stage[data-stage="mid"] #stage-mid,
  body.print-show-stage[data-stage="final"] #stage-final{
    display:block!important;max-height:none!important;opacity:1!important;border-style:solid
  }

  .print-stage-title{display:block}
  .print-all-titles{display:flex}
  table{font-size:10.4px} td.brief{font-size:10.2px;line-height:1.28} th,td{padding:3px 5px}
  .names-row{margin-top:6px}
}

@media (max-width:900px){ .topbar{grid-template-columns:auto auto auto 1fr} }
@media (max-width:680px){ .topbar{grid-template-columns:auto auto 1fr; grid-auto-flow:row} }
</style>
</head>
<body data-stage="planning">
<div id="page">
  <div class="wrap" id="sheet">

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <header>
      <div class="header-block">
        <div class="ksa">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
        <div class="moe">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
        <div class="dept" id="sectorNameDisplay">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</div>
        <div class="school" id="schoolNameDisplay">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</div>
      </div>
      <div class="header-title">
        <h1>Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</h1>
        <button class="gear-btn no-print" id="openHeaderEdit" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
          <span class="icon">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a2 2 0 1 0 2.9 2.8l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1a2 2 0 0 0-1.8-.3 2 2 0 0 0-1 1.5V21a2 2 0 1 1-4 0v-.1a2 2 0 0 0-1-1.5 2 2 0 0 0-1.8.3l-.1.1A2 2 0 1 1 4.2 18l.1-.1A2 2 0 0 0 4.6 16 2 2 0 0 0 3.1 15H3a2 2 0 1 1 0-4h.1A2 2 0 0 0 4.6 9 2 2 0 0 0 4.3 7.2L4.2 7A2 2 0 1 1 7.1 4.2l.1.1A2 2 0 0 0 9 4.6 2 2 0 0 0 10 3.1V3a2 2 0 1 1 4 0v.1A2 2 0 0 0 15 4.6a2 2 0 0 0 1.8-.3l.1-.1A2 2 0 1 1 19.7 7l-.1.1A2 2 0 0 0 19.4 9a2 2 0 0 0 1.5 1H21a2 2 0 1 1 0 4h-.1a2 2 0 0 0-1.5 1z"/></svg>
          </span>
        </button>
      </div>
    </header>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="topbar no-print">
      <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„ -->
      <label for="excelInput" class="icon-btn" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Excel)">
        <span class="icon">
          <svg viewBox="0 0 24 24"><path d="M12 3v12M7 8l5-5 5 5M4 20h16"/></svg>
        </span>
      </label>
      <input type="file" id="excelInput" accept=".xlsx,.xls,.csv"/>

      <!-- Ø¹Ø¯Ø³Ø© Ø§Ù„Ø¨Ø­Ø« -->
      <button class="icon-btn" id="openSearch" title="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„Ù…">
        <span class="icon">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-3.5-3.5"/></svg>
        </span>
      </button>

      <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ -->
      <div class="ff" style="grid-column:4">
        <div class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</div>
        <input id="tName" class="lined" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…"/>
      </div>
      <div class="ff" style="grid-column:5">
        <div class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</div>
        <input id="tId" class="lined" inputmode="numeric" placeholder="10 Ø£Ø±Ù‚Ø§Ù…"/>
      </div>
      <div class="ff" style="grid-column:6">
        <div class="label">Ø§Ù„ØªØ®ØµØµ</div>
        <input id="tSpec" class="lined" placeholder="Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"/>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø±Ø§Ø­Ù„ + Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙŠØ© + ØªØ§Ø±ÙŠØ® Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ -->
    <div class="no-print">
      <div class="stage-bar">
        <button class="stage-btn active" data-stage="planning">Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·</button>
        <button class="stage-btn" data-stage="mid">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©</button>
        <button class="stage-btn" data-stage="final">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>

        <a class="stage-link" href="https://fhz545-hub.github.io/teachervisit/" target="_blank" rel="noopener" title="Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙŠØ©">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg></span>
          Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ØµÙÙŠØ©
        </a>

        <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª -->
        <span class="badge" id="hijriChip">â€”</span>
      </div>
    </div>

    <!-- Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸/Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) -->
    <div id="allTitles" class="print-all-titles">
      <span class="pill" data-key="planning">Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·</span>
      <span class="pill" data-key="mid">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©</span>
      <span class="pill" data-key="final">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span>
    </div>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙÙ‚Ø·) -->
    <div id="stageTitlePrint" class="print-stage-title">â€”</div>

    <!-- Ù„ÙˆØ­Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„ -->
    <div id="stage-planning" class="stage-panel">
      <div class="tips">
        <ul>
          <li>ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ù‡Ø¯Ø§ÙÙ‡ Ø§Ù„Ù…Ù‡Ù†ÙŠØ© ÙˆØ§Ù„ØªØ±Ø¨ÙˆÙŠØ© Ø¨Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ù…Ø¹ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.</li>
          <li>ÙŠØ­Ø±Øµ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù‚Ø¹ÙŠØ© ÙˆØ°ÙƒÙŠØ© (Ù…Ø­Ø¯Ø¯Ø©ØŒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³ØŒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ù‚ÙŠÙ‚ØŒ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆÙ‚Øª).</li>
          <li>ÙŠÙˆØ²Ù‘Ø¹ Ø£Ù‡Ø¯Ø§ÙÙ‡ Ø¹Ù„Ù‰ Ù…Ø¬Ø§Ù„Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø© Ù…Ø«Ù„ Ø§Ù„ØªØ­ØµÙŠÙ„ØŒ Ø§Ù„ØªÙ‚Ù†ÙŠØ©ØŒ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ù‡Ù†ÙŠØŒ ÙˆØ§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·.</li>
          <li>ÙŠÙˆØ«Ù‘Ù‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙÙŠ Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙƒÙ…Ø±Ø¬Ø¹ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø·ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù….</li>
        </ul>
      </div>
      <div class="row" style="margin-top:6px">
        <input class="goal" id="g1" placeholder="Ù‡Ø¯Ù 1 â€” Ø§ÙƒØªØ¨ Ù‡Ø¯ÙÙƒ Ù‡Ù†Ø§">
        <input class="goal" id="g2" placeholder="Ù‡Ø¯Ù 2 â€” Ø§ÙƒØªØ¨ Ù‡Ø¯ÙÙƒ Ù‡Ù†Ø§">
        <input class="goal" id="g3" placeholder="Ù‡Ø¯Ù 3 â€” Ø§ÙƒØªØ¨ Ù‡Ø¯ÙÙƒ Ù‡Ù†Ø§">
        <input class="goal" id="g4" placeholder="Ù‡Ø¯Ù 4 â€” Ø§ÙƒØªØ¨ Ù‡Ø¯ÙÙƒ Ù‡Ù†Ø§">
      </div>
    </div>

    <div id="stage-mid" class="stage-panel">
      <div class="tips">
        <ul>
          <li>ÙŠÙ‚Ø§Ø±Ù† Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨ÙŠÙ† Ø£Ù‡Ø¯Ø§ÙÙ‡ ÙˆÙ…Ø§ ØªØ­Ù‚Ù‚ ÙØ¹Ù„ÙŠÙ‹Ø§.</li>
          <li>ÙŠØ¹Ø²Ø² Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆÙŠØ¶Ø¹ Ø­Ù„ÙˆÙ„Ù‹Ø§ Ø¹Ù…Ù„ÙŠØ© Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†.</li>
          <li>ÙŠÙˆØ«Ù‘Ù‚ Ø´ÙˆØ§Ù‡Ø¯Ù‡ ÙˆØ£Ø¯Ù„ØªÙ‡ Ù„Ø¯Ø¹Ù… ØªÙ‚ÙŠÙŠÙ…Ù‡.</li>
          <li>ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù…ÙˆØ§Ø¡Ù…Ø© Ø®Ø·ØªÙ‡ ÙˆØªØ·ÙˆÙŠØ± Ø£Ù‡Ø¯Ø§ÙÙ‡.</li>
        </ul>
      </div>
    </div>

    <div id="stage-final" class="stage-panel">
      <div class="tips">
        <ul>
          <li>ÙŠØ±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ø§ Ø£Ù†Ø¬Ø²Ù‡ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø£Ù‡Ø¯Ø§ÙÙ‡ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©.</li>
          <li>ÙŠØ¨Ø±Ø² Ø´ÙˆØ§Ù‡Ø¯Ù‡ ÙˆØ£Ø¯Ù„ØªÙ‡ Ù„Ø¥Ø«Ø¨Ø§Øª Ø¬Ù‡ÙˆØ¯Ù‡.</li>
          <li>ÙŠØ³ØªØ«Ù…Ø± Ù†Ù‚Ø§Ø· Ù‚ÙˆØªÙ‡ ÙÙŠ Ø®Ø·Ø·Ù‡ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©.</li>
          <li>ÙŠØ­Ø¯Ø¯ Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ† Ù„ÙŠØ®Ø·Ùˆ Ù†Ø­Ùˆ ØªØ·ÙˆÙŠØ± Ø¬Ø¯ÙŠØ¯.</li>
          <li>ÙŠÙ†Ø¸Ø± Ù„Ù„ØªÙ‚ÙŠÙŠÙ… ÙƒÙØ±ØµØ© Ù„Ù„ØªÙ‚Ø¯ÙŠØ± ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… ÙˆØ¨Ø¯Ø§ÙŠØ© Ù„Ù…Ø±Ø­Ù„Ø© Ø£ÙƒØ«Ø± Ù†Ø¶Ø¬Ù‹Ø§.</li>
        </ul>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø´Ø§Ø´Ø© -->
    <div class="idcard" id="idcard">
      <span class="idchip">Ø§Ù„Ù…Ø¹Ù„Ù…: <b id="s_name">â€”</b></span>
      <span class="idchip">Ø§Ù„Ù‡ÙˆÙŠØ©: <b id="s_id">â€”</b></span>
      <span class="idchip">Ø§Ù„ØªØ®ØµØµ: <b id="s_spec">â€”</b></span>
      <span class="idchip">Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: <b id="s_stage">Ø§Ù„ØªØ®Ø·ÙŠØ·</b></span>
    </div>

    <!-- Ø§Ù„Ù…Ø¤Ø´Ø± -->
    <div class="bar-row" id="barRow">
      <div class="chip" id="scoreChip">Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: 0.00 / 5</div>
      <div class="meter">
        <div class="fill"></div>
        <div class="ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span></div>
        <div class="thumb" id="thumb" style="left:0%"></div>
      </div>
      <div class="chip" id="percentChip">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: %0</div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <table id="tbl">
      <thead>
      <tr>
        <th class="w-tight">#</th>
        <th>Ø§Ù„Ø¹Ù†ØµØ±</th>
        <th class="w">Ø§Ù„ÙˆØ²Ù†</th>
        <th class="w-tight">Ø§Ù„Ø¯Ø±Ø¬Ø©<span class="sub">(1â€“5)</span></th>
        <th>ØªÙØ³ÙŠØ± / Ø£Ù…Ø«Ù„Ø© Ù…Ø®ØªØµØ±Ø©</th>
      </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <!-- Ø§Ù„Ù‚ÙˆØ©/Ø§Ù„ØªØ·ÙˆÙŠØ± (Ù…Ø±ØªØ¨Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø§Øª) -->
    <div class="cards">
      <div id="strength" class="card">
        <h3>Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©</h3>
        <div id="strengthBody">â€”</div>
      </div>
      <div id="dev" class="card">
        <h3>Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±</h3>
        <div id="devBody">â€”</div>
      </div>
    </div>

    <!-- ØµÙ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© -->
    <div class="names-row" id="namesRow">
      <div class="cell">
        <span class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…:</span>
        <span class="value" id="footerTeacher">â€”</span>
      </div>
      <div class="cell">
        <span class="label">Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</span>
        <span class="value" id="footerPrincipal">ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span>
        <button class="icon-btn no-print" id="editPrincipalBtn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±" style="width:30px;height:28px;border-radius:8px">
          <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 20v-6M6 8V4h12v4"/></svg></span>
        </button>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <div class="actions no-print">
      <span class="badge-mini">ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</span>
      <select id="printMode" style="height:34px;line-height:34px;border:1px solid #cfe1dd;border-radius:12px;padding:0 10px;font-weight:800">
        <option value="color" selected>Ù…Ù„ÙˆÙ†</option>
        <option value="bw">Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯</option>
      </select>

      <button class="icon-btn" id="printBtn" title="Ø·Ø¨Ø§Ø¹Ø© A4">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M6 9V3h12v6"/><path d="M6 13h12v8H6z"/><path d="M4 9h16a2 2 0 0 1 2 2v2H2v-2a2 2 0 0 1 2-2z"/></svg></span>
      </button>
      <button class="icon-btn" id="saveBtn" title="Ø­ÙØ¸ PDF">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 3v12"/><path d="M7 8l5 5 5-5"/><path d="M4 21h16"/></svg></span>
      </button>
      <button class="icon-btn" id="saveTeacherBtn" title="Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="M8 7V4h8v3"/><path d="M12 11v6"/></svg></span>
      </button>
      <button class="icon-btn" id="clearOneBtn" title="Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6Ù„1 14h10l1-14"/></svg></span>
      </button>
      <button class="icon-btn" id="exportExcelBtn" title="ØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Excel)">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 17h16v3H4z"/><path d="M12 4Ù11"/></svg></span>
      </button>
      <button class="icon-btn" id="clearTeachersBtn" title="Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6Ù„1 14"/></svg></span>
      </button>
      <button class="icon-btn" id="importTemplateBtn" title="ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Excel">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 5v14"/><path d="M18 13l-6 6-6-6"/></svg></span>
      </button>

      <!-- Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) -->
      <button class="icon-btn" id="whatsappBtn" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
        <span class="icon">
          <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù…ØªÙ†Ø§Ø³Ù‚Ø© -->
          <svg viewBox="0 0 24 24">
            <path d="M20.5 3.5c-2.8-2.8-7.4-2.8-10.3 0-2 2-2.7 4.9-1.9 7.5L4 20l8.5-3.7c2.6.8 5.5.1 7.5-1.9 2.8-2.8 2.8-7.4 0-10.3z"/>
            <path d="M15.2 8.8c-.3-.1-.7-.1-1 .1-.3.2-.6.5-.8.8-.2.3-.2.6.1 1 .2.3.5.6.8.8.3.2.6.3 1 .1.3-.1.6-.4.8-.7.2-.3.2-.6-.1-1-.2-.3-.4-.5-.8-.9z"/>
          </svg>
        </span>
      </button>

      <!-- Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ -->
      <button class="icon-btn" id="editWhatsappBtn" title="ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨">
        <span class="icon">
          <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        </span>
      </button>
    </div>

    <div class="footer" style="text-align:center;font-size:10.6px;color:#6a8682;margin:4px 0 2px">
      Â© Ù…Ø¨Ø§Ø¯Ø±Ø© Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ø§Ù„Ø®Ø¨Ø± â€” ØªØµÙ…ÙŠÙ… ÙˆØªÙ†ÙÙŠØ°: ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ
    </div>

  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø£Ø³ -->
<div id="editModal" class="no-print" style="display:none;position:fixed;inset:0;z-index:100;align-items:center;justify-content:center">
  <div style="position:absolute;inset:0;background:rgba(0,0,0,.25)"></div>
  <div style="position:relative;background:#fff;border:1px solid #dbe8e5;border-radius:12px;min-width:320px;max-width:92vw;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101">
    <h3 style="margin:0 0 8px;font-size:14px;color:#0f4c46">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø£Ø³</h3>
    <div style="display:grid;gap:6px">
      <input id="editSector" class="lined" style="height:34px;line-height:34px" placeholder="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù‚Ø·Ø§Ø¹"/>
      <input id="editSchool" class="lined" style="height:34px;line-height:34px" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"/>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:8px">
      <button id="mClose" class="gear-btn" title="Ø¥ØºÙ„Ø§Ù‚"><span class="icon"><svg viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></span></button>
      <button id="mSave" class="gear-btn" title="Ø­ÙØ¸" style="border-color:#0f7a66;background:#0f7a66">
        <span class="icon"><svg viewBox="0 0 24 24"><path d="M4 7h16v13H4z"/><path d="Ù…8 7V4h8v3"/><path d="M12 11Ù6"/></svg></span>
      </button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« -->
<div id="searchModal" class="no-print" style="display:none;position:fixed;inset:0;z-index:110;align-items:center;justify-content:center">
  <div style="position:absolute;inset:0;background:rgba(0,0,0,.25)"></div>
  <div style="position:relative;background:#fff;border:1px solid #dbe8e5;border-radius:12px;min-width:340px;max-width:min(92vw,520px);padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:111">
    <h3 style="margin:0 0 8px;font-size:14px;color:#0f4c46">Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ù„Ù…</h3>
    <input id="searchBox" class="lined" style="height:36px;line-height:36px" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡Ù‹Ø§ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡ÙˆÙŠØ©"/>
    <div id="results" style="max-height:48vh;overflow:auto;margin-top:8px;border:1px solid #e9Ù2ef;border-radius:10px;padding:6px"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button id="sClose" class="gear-btn" title="Ø¥ØºÙ„Ø§Ù‚"><span class="icon"><svg viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></span></button>
    </div>
  </div>
</div>

<script>
/* Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const collapse=s=>String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
const digits=s=>String(s||'').replace(/\D+/g,'');

/* Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ (Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰) */
function hijriUmmAlQura(){
  let txt='â€”';
  try{txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date())}
  catch(e){try{txt=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).format(new Date())}catch{txt=new Date().toLocaleDateString('ar-SA')}}
  $('#hijriChip').textContent='Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ: '+txt+' Ù‡Ù€';
  return txt+' Ù‡Ù€';
}
const hijriToday=hijriUmmAlQura();

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø£Ø³ + Ø§Ù„Ù…Ø¯ÙŠØ± */
const LS_SETTINGS='yaqubi_settings_best';
(function(){
  const s=localStorage.getItem(LS_SETTINGS); if(!s) return;
  try{const o=JSON.parse(s);
    if(o.sector) $('#sectorNameDisplay').textContent=o.sector;
    if(o.school) $('#schoolNameDisplay').textContent=o.school;
    if(o.principal) $('#footerPrincipal').textContent=o.principal;
  }catch{}
})();
$('#openHeaderEdit').addEventListener('click',()=>{
  $('#editModal').style.display='flex';
  $('#editSector').value=$('#sectorNameDisplay').textContent.trim();
  $('#editSchool').value=$('#schoolNameDisplay').textContent.trim();
});
$('#mClose').addEventListener('click',()=>$('#editModal').style.display='none');
$('#mSave').addEventListener('click',()=>{
  const sector=collapse($('#editSector').value)||'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©';
  const school=collapse($('#editSchool').value)||'Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©';
  $('#sectorNameDisplay').textContent=sector; $('#schoolNameDisplay').textContent=school;
  const saved=localStorage.getItem(LS_SETTINGS); let o={};
  try{o=saved?JSON.parse(saved):{}}catch{ o={}; }
  o.sector=sector; o.school=school;
  localStorage.setItem(LS_SETTINGS,JSON.stringify(o));
  $('#editModal').style.display='none';
});
document.getElementById('editPrincipalBtn').addEventListener('click',()=>{
  const curr=$('#footerPrincipal').textContent.trim();
  const v=prompt('Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:',curr||''); if(v===null) return;
  const name=collapse(v)||'â€”';
  $('#footerPrincipal').textContent=name;
  const saved=localStorage.getItem(LS_SETTINGS); let o={};
  try{o=saved?JSON.parse(saved):{}}catch{ o={}; }
  o.principal=name; localStorage.setItem(LS_SETTINGS,JSON.stringify(o));
});

/* ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
const LS_PRINT='yaqubi_print_mode';
const printSel=$('#printMode');
function applyPrintMode(m){ if(m==='bw') document.body.classList.add('bw-print'); else document.body.classList.remove('bw-print'); }
if(printSel){
  const m=localStorage.getItem(LS_PRINT)||'color'; printSel.value=m; applyPrintMode(m);
  printSel.addEventListener('change',()=>{ localStorage.setItem(LS_PRINT,printSel.value); applyPrintMode(printSel.value); });
}

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
const items=[
  {name:"Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©",weight:10,brief:"Ø§Ù†Ø¶Ø¨Ø§Ø· ÙŠÙˆÙ…ÙŠØ› Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯Ø› ØªØ­Ø¶ÙŠØ± ÙˆØªØªØ¨Ø¹Ø› ØªØ³Ù„ÙŠÙ… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±."},
  {name:"Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ù‡Ù†ÙŠ",weight:10,brief:"Ù…Ø¬ØªÙ…Ø¹Ø§Øª ØªØ¹Ù„Ù…Ø› ØªØ¨Ø§Ø¯Ù„ Ø²ÙŠØ§Ø±Ø§ØªØ› Ø­Ø¶ÙˆØ± Ø¯ÙˆØ±Ø§ØªØ› Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆØ§Ø±Ø¯."},
  {name:"Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±",weight:10,brief:"Ù‚Ù†ÙˆØ§Øª Ù…Ù†Ø¶Ø¨Ø·Ø©Ø› Ø±Ø³Ø§Ø¦Ù„ Ù…ÙˆØ¬Ø²Ø©Ø› Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù†Ù‘Ø§Ø¡Ø©."},
  {name:"Ø§Ù„ØªÙ†ÙˆØ¹ ÙÙŠ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³",weight:10,brief:"ØªØ¹Ù„Ù… Ù†Ø´Ø·Ø› Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„ÙØ±ÙˆÙ‚Ø› Ø£Ø³Ø¦Ù„Ø© Ø¹Ù„ÙŠØ§Ø› ØªØ¹Ù„Ù‘Ù… ØªØ¹Ø§ÙˆÙ†ÙŠ."},
  {name:"ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†",weight:10,brief:"Ù‚ÙŠØ§Ø³ Ù‚Ø¨Ù„ÙŠ/Ø¨Ø¹Ø¯ÙŠØ› Ø®Ø·Ø· Ø¹Ù„Ø§Ø¬Ø› Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù…."},
  {name:"Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†ÙÙŠØ° Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„Ù…",weight:10,brief:"ØªÙˆØ²ÙŠØ¹ Ù…Ù†Ù‡Ø¬Ø› ØªØ­Ø¶ÙŠØ± Ø¹Ù„Ù…ÙŠØ› ØªÙ‚ÙˆÙŠÙ… Ø¨Ù†Ø§Ø¦ÙŠØ› Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø²Ù…Ù†."},
  {name:"ØªÙˆØ¸ÙŠÙ Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ù„",weight:10,brief:"Ù…Ù†ØµØ§ØªØ› Ù…ÙˆØ§Ø±Ø¯ ØªÙØ§Ø¹Ù„ÙŠØ©Ø› Ù…ØµØ§Ø¯Ø± Ù…ØªØ¹Ø¯Ø¯Ø©Ø› Ù…Ø­ØªÙˆÙ‰ Ù…Ù†Ø¸Ù…."},
  {name:"ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©",weight:5, brief:"ØªÙ‡ÙŠØ¦Ø© Ù†ÙØ³ÙŠØ©Ø› ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯Ø› Ù„ÙˆØ­Ø§Øª ØµÙÙŠØ©."},
  {name:"Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙŠØ©",weight:5,  brief:"Ù‚ÙˆØ§Ø¹Ø¯ ÙˆØ§Ø¶Ø­Ø©Ø› Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ‚ØªØ› Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø³Ù„Ø³Ø©Ø› Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø¨."},
  {name:"ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†",weight:10,brief:"ØªØ­Ù„ÙŠÙ„ Ø¨Ù†ÙˆØ¯Ø› ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¶Ø¹ÙØ› ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø®ØªØµØ±Ø©."},
  {name:"ØªÙ†ÙˆØ¹ Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…",weight:10,brief:"Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©Ø› Ù…Ù‡Ø§Ù… Ø£Ø¯Ø§Ø¡Ø› Ù…Ù„ÙØ§Øª Ø¥Ù†Ø¬Ø§Ø²."},
];
(function buildTable(){
  const tb=$('#rows');
  items.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="w-tight" style="text-align:center">${i+1}</td>
      <td>${it.name}</td>
      <td class="w"><b>${it.weight}%</b></td>
      <td class="w-tight">
        <select class="grade">
          <option value="5">5</option><option value="4">4</option>
          <option value="3" selected>3</option><option value="2">2</option><option value="1">1</option>
        </select>
      </td>
      <td class="brief">${it.brief}</td>`;
    tb.appendChild(tr);
  });
})();

/* Ø§Ù„Ù…Ø¤Ø´Ø± + ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙˆØ©/Ø§Ù„ØªØ·ÙˆÙŠØ± */
const chipScore=$('#scoreChip'), chipPct=$('#percentChip'), thumb=$('#thumb');
const strengthBody=$('#strengthBody'), devBody=$('#devBody');

function updateInsights(grades){
  const enriched = items.map((it,i)=>({
    ...it, g: grades[i], impact: grades[i]*it.weight
  }));
  const strengths = enriched.filter(x=>x.g>=4).sort((a,b)=>b.impact-a.impact);
  const devs = enriched.filter(x=>x.g<=2).sort((a,b)=>b.weight-a.weight||a.g-b.g);

  if(strengths.length){
    strengthBody.innerHTML = '<ul style="margin:0;padding:0 1.2em">' +
      strengths.map(x=>`<li><b>${x.name}</b> â€” Ø¯Ø±Ø¬Ø© ${x.g}/5 Ø¨ÙˆØ²Ù† ${x.weight}% (Ø£Ø«Ø±: ${Math.round(x.impact)}). </li>`).join('') +
      '</ul>';
  }else{
    strengthBody.textContent = 'â€”';
  }

  if(devs.length){
    devBody.innerHTML = '<ul style="margin:0;padding:0 1.2em">' +
      devs.map(x=>`<li><b>${x.name}</b> â€” Ø¯Ø±Ø¬Ø© ${x.g}/5 Ø¨ÙˆØ²Ù† ${x.weight}%Ø› ØªÙˆØµÙŠØ©: ${x.brief}</li>`).join('') +
      '</ul>';
  }else{
    devBody.textContent = 'â€”';
  }
}

function recalc(){
  let weighted=0, per=0;
  const grades = $$('.grade').map((sel)=> Number(sel.value));
  grades.forEach((g,i)=>{ const w=items[i].weight; weighted+=g*w; per+=(g/5)*w; });
  const avg=weighted/100, pct=Math.round(per);
  chipScore.textContent=`Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²: ${avg.toFixed(2)} / 5`;
  chipPct.textContent=`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: %${pct}`;
  thumb.style.left=`${((avg-1)/4)*100}%`;
  updateInsights(grades);
  return {avg,pct};
}
$$('.grade').forEach(el=>el.addEventListener('change',recalc)); 
recalc();

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… */
function vName(){return collapse($('#tName').value)} function vId(){return digits($('#tId').value)} function vSpec(){return collapse($('#tSpec').value)}
function updateSummary(){
  const n=vName()||'â€”', i=vId()||'â€”', sp=vSpec()||'â€”';
  $('#s_name').textContent=n; $('#s_id').textContent=i; $('#s_spec').textContent=sp;
  $('#footerTeacher').textContent=n;
}
['#tName','#tId','#tSpec'].forEach(sel=>$(sel).addEventListener('input',updateSummary));
updateSummary();

/* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (ÙØªØ­/ØºÙ„Ù‚ + Ø¶Ø¨Ø· data-stage) */
const stageBtns=$$('.stage-btn');
const panels={ planning:$('#stage-planning'), mid:$('#stage-mid'), final:$('#stage-final') };
let currentStage='planning', isOpen=true;
function setStage(key, toggle=false){
  if(toggle && currentStage===key){ isOpen=!isOpen; } else { currentStage=key; isOpen=true; }
  document.body.setAttribute('data-stage', currentStage);
  stageBtns.forEach(b=>b.classList.toggle('active', b.dataset.stage===currentStage));
  Object.values(panels).forEach(p=>{p.classList.remove('open'); p.style.maxHeight='0px';});
  if(isOpen){ const p=panels[currentStage]; p.classList.add('open'); p.style.maxHeight=p.scrollHeight+'px'; }
  $('#s_stage').textContent= key==='planning'?'Ø§Ù„ØªØ®Ø·ÙŠØ·': key==='mid'?'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©':'Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ';
  const isPlanning=(currentStage==='planning');
  $$('.grade').forEach(s=>s.disabled=isPlanning);
  $('#barRow').style.opacity=(isPlanning?0.45:1);
  if(!isOpen){ chipScore.textContent='â€”'; chipPct.textContent='â€”'; } 
  else if(!isPlanning) recalc(); 
  else {chipScore.textContent='ÙˆØ¶Ø¹ Ø§Ù„ØªØ®Ø·ÙŠØ·: Ø§Ù„Ù…Ø¤Ø´Ø± ØºÙŠØ± Ù…ÙÙØ¹Ù‘Ù„'; chipPct.textContent='â€”';}
}
stageBtns.forEach(b=>b.addEventListener('click',()=>setStage(b.dataset.stage,true)));
setStage('planning');

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© + Ø´Ø±ÙŠØ· ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
function stageTitleText(){
  const map={planning:'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ø·ÙŠØ· â€” Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù…', mid:'Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©', final:'Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ â€” Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù…'};
  return map[currentStage]||'â€”';
}
function setPrintStageTitle(){
  const el=$('#stageTitlePrint');
  if(isOpen){ el.textContent='Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©: '+stageTitleText(); }
  else{ el.textContent='Ø¹Ø±Ø¶ Ù…Ø®ØªØµØ±: Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù…Ø§Ø¡'; }
}
function highlightAllTitles(){
  $$('#allTitles .pill').forEach(p=>p.classList.toggle('active', p.dataset.key===currentStage && isOpen));
}

/* ØªØ­Ù‚Ù‚/Ø·Ø¨Ø§Ø¹Ø©/Ø­ÙØ¸ PDF */
function validate(){
  if(!vName()){ alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù….'); $('#tName').focus(); return false; }
  if(!/^\d{10}$/.test(vId())){ alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© ØµØ­ÙŠØ­Ù‹Ø§ (10 Ø£Ø±Ù‚Ø§Ù…).'); $('#tId').focus(); return false; }
  if(!vSpec()){ alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„ØªØ®ØµØµ.'); $('#tSpec').focus(); return false; }
  if(currentStage==='planning' && isOpen){
    const g=[collapse($('#g1').value),collapse($('#g2').value),collapse($('#g3').value),collapse($('#g4').value)];
    if(g.some(x=>!x)){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·.'); return false; }
  }
  return true;
}
function ensureCurrentOpenIfNeeded(){
  if(!isOpen) return ()=>{}; 
  const panel=panels[currentStage];
  const wasOpen=panel.classList.contains('open');
  if(!wasOpen){ panel.classList.add('open'); panel.style.maxHeight=panel.scrollHeight+'px'; }
  return ()=>{ if(!wasOpen){ panel.classList.remove('open'); panel.style.maxHeight='0px'; } };
}
function fitForA4(){
  const page=$('#page'), sheet=$('#sheet');
  const prev={minH:page.style.minHeight,h:page.style.height,w:page.style.width,disp:page.style.display,tf:sheet.style.transform,tfOrigin:sheet.style.transformOrigin};
  page.style.minHeight='297mm'; page.style.height='297mm'; page.style.width='210mm'; page.style.display='block';
  const mm=3.78, innerH=(297-10)*mm, innerW=(210-10)*mm;
  const H=sheet.scrollHeight, W=sheet.scrollWidth;
  const sc=Math.min(1,(innerH/H)*0.998,(innerW/W)*0.998);
  sheet.style.transformOrigin='top right';
  sheet.style.transform=`scale(${sc})`;
  return ()=>{ page.style.minHeight=prev.minH; page.style.height=prev.h; page.style.width=prev.w; page.style.display=prev.disp; sheet.style.transform=prev.tf; sheet.style.transformOrigin=prev.tfOrigin; };
}
function startCapture(){ document.body.classList.add('capture'); $('#allTitles').style.display='flex'; setPrintStageTitle(); highlightAllTitles(); }
function endCapture(){ document.body.classList.remove('capture'); $('#allTitles').style.display='none'; }

document.getElementById('printBtn').addEventListener('click',()=>{
  if(!validate()) return;
  if(isOpen) document.body.classList.add('print-show-stage'); else document.body.classList.remove('print-show-stage');
  const undoOpen=ensureCurrentOpenIfNeeded();
  const undoFit=fitForA4();
  startCapture();
  setTimeout(()=>window.print(),60);
  setTimeout(()=>{ endCapture(); undoFit(); undoOpen(); document.body.classList.remove('print-show-stage'); },900);
});

document.getElementById('saveBtn').addEventListener('click',async()=>{
  if(!validate()) return;
  if(isOpen) document.body.classList.add('print-show-stage'); else document.body.classList.remove('print-show-stage');
  const undoOpen=ensureCurrentOpenIfNeeded();
  startCapture();
  try{
    const page=$('#page');
    const prev={minH:page.style.minHeight,h:page.style.height,w:page.style.width,disp:page.style.display};
    page.style.minHeight='297mm'; page.style.height='297mm'; page.style.width='210mm'; page.style.display='block';
    const canvas=await html2canvas(page,{useCORS:true,scale:2,background:'#ffffff',scrollX:0,scrollY:0,windowWidth:page.scrollWidth,windowHeight:page.scrollHeight});
    const img=canvas.toDataURL('image/png',1.0);
    const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
    const margin=5, pdfW=210-2*margin, pdfH=297-2*margin;
    const imgW=canvas.width*0.264583, imgH=canvas.height*0.264583;
    const r=Math.min(pdfW/imgW,pdfH/imgH); const w=imgW*r, h=imgH*r; const x=margin+(pdfW-w)/2, y=margin+(pdfH-h)/2;
    const fileName=`ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ - ${vName()||'ØºÙŠØ± Ù…Ø³Ù…Ù‰'} - ${(isOpen?$('#s_stage').textContent:'Ù…Ø®ØªØµØ±')} - ${hijriToday}.pdf`;
    pdf.addImage(img,'PNG',x,y,w,h,'','FAST'); pdf.save(fileName);
    page.style.minHeight=prev.minH; page.style.height=prev.h; page.style.width=prev.w; page.style.display=prev.disp;
  }catch(err){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ PDF.'); console.error(err); }
  finally{ endCapture(); undoOpen(); document.body.classList.remove('print-show-stage'); }
});

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ† (Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„/Ø¨Ø­Ø«/Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±) */
const LS_TEACHERS='yaqubi_teachers_best';
let teachers=[]; 
function saveTeachers(){localStorage.setItem(LS_TEACHERS,JSON.stringify(teachers));}
function loadTeachers(){const raw=localStorage.getItem(LS_TEACHERS); teachers=raw?(JSON.parse(raw)||[]):[];}
function applyTeacher(t){
  $('#tName').value=t.name||''; $('#tId').value=t.id||''; $('#tSpec').value=t.spec||'';
  ['g1','g2','g3','g4'].forEach((id,i)=>{const el=$('#'+id); if(el) el.value=(t.goals||[])[i]||'';});
  if(t.grades) $$('.grade').forEach((sel,i)=> sel.value=t.grades[i]||sel.value);
  updateSummary(); recalc();
}
function upsertTeacher(){
  const t={name:vName(),id:vId(),spec:vSpec(),goals:['g1','g2','g3','g4'].map(id=>collapse($('#'+id)?.value||'')),grades:$$('.grade').map(s=>Number(s.value))};
  if(!t.name){alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸');return;}
  let i=teachers.findIndex(x=>x.id && t.id && x.id===t.id); if(i<0) i=teachers.findIndex(x=>x.name===t.name);
  if(i>=0) teachers[i]=t; else teachers.push(t); saveTeachers(); alert('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù….');
}
document.getElementById('saveTeacherBtn').addEventListener('click',()=>{ if(validate()) upsertTeacher(); });
document.getElementById('clearOneBtn').addEventListener('click',()=>{
  const id=vId(), name=vName(); if(!id && !name){alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆÙ„Ù‹Ø§');return;}
  if(!confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'))return;
  const before=teachers.length;
  teachers=teachers.filter(x=> !((id&&x.id===id)||(!id&&name&&x.name===name)) );
  saveTeachers(); alert(before!==teachers.length?'ØªÙ… Ø§Ù„Ù…Ø³Ø­.':'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„.');
});
document.getElementById('excelInput').addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const data=await file.arrayBuffer(); const wb=XLSX.read(data); const sh=wb.Sheets[wb.SheetNames[0]];
    const raw=XLSX.utils.sheet_to_json(sh,{header:1,defval:''}); if(!raw.length){alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº');return;}
    const norm=h=>{h=String(h).trim().toLowerCase(); const map={'name':'name','Ø§Ù„Ø§Ø³Ù…':'name','fullname':'name','id':'id','Ø§Ù„Ù‡ÙˆÙŠØ©':'id','Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©':'id','specialization':'spec','Ø§Ù„ØªØ®ØµØµ':'spec'}; return map[h]||h;}
    const headers=raw[0].map(norm), rows=raw.slice(1); const arr=[];
    rows.forEach(r=>{
      if(r.every(c=>String(c).trim()==='')) return;
      const o={name:'',id:'',spec:''}; r.forEach((c,i)=>{const k=headers[i]; if(!k) return;
        if(k.includes('name')) o.name=collapse(c);
        else if(k.includes('id')) o.id=digits(c);
        else if(k.includes('spec')) o.spec=collapse(c);
      });
      if(!o.name && r[0]) o.name=collapse(r[0]); if(!o.id && r[1]) o.id=digits(r[1]); if(!o.spec && r[2]) o.spec=collapse(r[2]);
      if(o.name) arr.push(o);
    });
    if(!arr.length){alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø¹Ù…Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø© (Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„ØªØ®ØµØµ)');return;}
    teachers=arr; saveTeachers(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
  }catch(err){console.error(err); alert('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù.');}
  finally{ e.target.value=''; }
});
document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
  if(!teachers.length){alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');return;}
  const header=['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„ØªØ®ØµØµ'], data=teachers.map(t=>[t.name,t.id,t.spec]);
  const ws=XLSX.utils.aoa_to_sheet([header,...data]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ†');
  const out=XLSX.write(wb,{bookType:'xlsx',type:'array'}); saveAs(new Blob([out],{type:'application/octet-stream'}),'Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.xlsx');
});
document.getElementById('importTemplateBtn').addEventListener('click', ()=>{
  const header=['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ù‡ÙˆÙŠØ©','Ø§Ù„ØªØ®ØµØµ']; const ws=XLSX.utils.aoa_to_sheet([header,['Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ','1010101010','Ø±ÙŠØ§Ø¶ÙŠØ§Øª']]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Ù‚Ø§Ù„Ø¨_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†');
  const out=XLSX.write(wb,{bookType:'xlsx',type:'array'}); saveAs(new Blob([out],{type:'application/octet-stream'}),'Ù‚Ø§Ù„Ø¨_Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.xlsx');
});
document.getElementById('clearTeachersBtn').addEventListener('click',()=>{ if(confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†ØŸ')){ localStorage.removeItem(LS_TEACHERS); teachers=[]; }});

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« */
function renderResults(q=''){
  const box=$('#results'); box.innerHTML='';
  if(!teachers.length){ box.innerHTML='<div style="padding:8px;color:#6a8682">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.</div>'; return;}
  const qq=collapse(q).toLowerCase();
  const list=teachers.filter(t=>{
    const nm=(t.name||'').toLowerCase(), id=(t.id||'').toLowerCase(), sp=(t.spec||'').toLowerCase();
    return !qq || nm.includes(qq) || id.includes(qq) || sp.includes(qq);
  });
  if(!list.length){ box.innerHTML='<div style="padding:8px;color:#6a8682">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>'; return;}
  list.forEach(t=>{
    const row=document.createElement('button');
    row.type='button';
    row.style.cssText='width:100%;text-align:inherit;padding:8px;border:1px solid #e9f2ef;border-radius:10px;margin:4px 0;background:#fff;cursor:pointer';
    row.innerHTML=`<div style="font-weight:900;color:#0Ù2f2b">${t.name||'â€”'}</div>
                   <div style="font-size:12px;color:#5a7571">Ø§Ù„Ù‡ÙˆÙŠØ©: ${t.id||'â€”'} â€¢ Ø§Ù„ØªØ®ØµØµ: ${t.spec||'â€”'}</div>`;
    row.addEventListener('click',()=>{ applyTeacher(t); $('#searchModal').style.display='none'; });
    box.appendChild(row);
  });
}
document.getElementById('openSearch').addEventListener('click',()=>{
  $('#searchModal').style.display='flex';
  const sb=$('#searchBox'); sb.value=''; renderResults(''); setTimeout(()=>sb.focus(),60);
});
document.getElementById('sClose').addEventListener('click',()=>$('#searchModal').style.display='none');
$('#searchModal').addEventListener('click',e=>{ if(e.target===e.currentTarget) $('#searchModal').style.display='none'; });
$('#searchBox').addEventListener('input',e=>renderResults(e.target.value));

/* ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ† */
(function loadInit(){
  const raw=localStorage.getItem(LS_TEACHERS);
  teachers=raw?(JSON.parse(raw)||[]):[];
})();

/* ======= ÙˆØ§ØªØ³Ø§Ø¨: Ø±Ù‚Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ + Ø±Ø³Ø§Ù„Ø© Ø´Ø§Ù…Ù„Ø© ======= */
const LS_WA='yaqubi_whatsapp';
const WA_DEFAULT='966504532489'; // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨

function getWhatsNumber(){
  const s=localStorage.getItem(LS_WA);
  const d=digits(s||'');
  return d || WA_DEFAULT;
}
function setWhatsNumber(raw){
  const d=digits(String(raw||''));
  if(!d) return false;
  localStorage.setItem(LS_WA,d);
  return true;
}

const whatsappBtn = $('#whatsappBtn');
const editWhatsappBtn = $('#editWhatsappBtn');

function getListTextFrom(el){
  if(!el) return '';
  // Ø§Ø¬Ù„Ø¨ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù† ÙˆØ¬Ø¯ØªØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„Ù†Øµ ÙƒÙ…Ø§ Ù‡Ùˆ
  const lis=[...el.querySelectorAll('li')];
  if(!lis.length) return collapse(el.textContent||'');
  return lis.map(li=>'â€¢ '+collapse(li.textContent||'')).join('\n');
}

function buildWhatsappMessage(){
  // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ù‹Ø§
  const {avg,pct}=recalc();

  const school = collapse($('#schoolNameDisplay').textContent||'â€”');
  const teacher = collapse(vName()||'â€”');
  const principal = collapse($('#footerPrincipal').textContent||'â€”');
  const stage = collapse(stageTitleText());
  const date = hijriToday;

  // Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
  const goals = ['g1','g2','g3','g4']
    .map(id=>collapse(($('#'+id)&&$('#'+id).value)||''))
    .filter(x=>x).map(x=>'â€¢ '+x).join('\n') || 'â€¢ â€”';

  // Ø§Ù„Ù‚ÙˆØ©/Ø§Ù„ØªØ·ÙˆÙŠØ± (Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©)
  const strengths = getListTextFrom($('#strengthBody')) || 'â€¢ â€”';
  const devs = getListTextFrom($('#devBody')) || 'â€¢ â€”';

  const scoreLine = `Ø§Ù„Ù…Ø¤Ø´Ø±: ${avg.toFixed(2)} / 5 â€” Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: %${pct}`;

  const msg =
`ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${school}
ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…: ${teacher}
ğŸ“Œ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${stage}
ğŸ—“ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰): ${date}

ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù:
${goals}

ğŸ’ª Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©:
${strengths}

ğŸ§­ Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±:
${devs}

ğŸ“ˆ ${scoreLine}

ğŸ‘¨â€ğŸ’¼ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${principal}`;

  return msg;
}

function openWhatsApp(){
  const num=getWhatsNumber();
  const text = buildWhatsappMessage();
  const url = `https://wa.me/${num}?text=${encodeURIComponent(text)}`;
  window.open(url,'_blank');
}

function refreshWhatsappTitle(){
  const n=getWhatsNumber();
  whatsappBtn.title = `Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ â€” ${n}`;
  editWhatsappBtn.title = `ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ (Ø­Ø§Ù„ÙŠ: ${n})`;
}

whatsappBtn.addEventListener('click', openWhatsApp);

editWhatsappBtn.addEventListener('click', ()=>{
  const curr=getWhatsNumber();
  let inp = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† +)ØŒ Ù…Ø«Ø§Ù„: 9665xxxxxxxx:', curr);
  if(inp===null) return;
  inp = collapse(inp);
  const d = digits(inp);
  if(!d){
    alert('Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© (Ù…Ø«Ø§Ù„: 9665xxxxxxxx).');
    return;
  }
  setWhatsNumber(d);
  refreshWhatsappTitle();
  alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.');
});

refreshWhatsappTitle();
/* ======= Ù†Ù‡Ø§ÙŠØ© ÙˆØ§ØªØ³Ø§Ø¨ ======= */
</script>
</body>
</html>
